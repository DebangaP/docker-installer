<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #4CAF50;
        }

        .status-offline {
            background-color: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-icon {
            font-size: 24px;
        }

        .tpo-chart-container {
            height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
        }

        .chart-placeholder {
            text-align: center;
            color: #666;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .backtest-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .backtest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .backtest-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .mode-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .mode-live {
            background: #d4edda;
            color: #155724;
        }

        .mode-backtest {
            background: #fff3cd;
            color: #856404;
        }

        .date-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-backtest {
            background: #17a2b8;
            color: white;
        }

        .btn-live {
            background: #28a745;
            color: white;
        }

        .analysis-info {
            background: rgba(23, 162, 184, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #17a2b8;
        }

        .analysis-info h4 {
            color: #17a2b8;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .grafana-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üìä Trading Dashboard</div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span>Kite Token: {{ token_status }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span>Last Update: {{ last_update }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span>Total Ticks today: {{ total_ticks }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="marginCash">Cash: ‚Çπ0</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="marginBalance">Balance: ‚Çπ0</span>
                </div>
                <div class="status-item">
                    <a href="http://localhost:3001/d/my-dashboard/sample-dashboard?orgId=1&from=now-90d&to=now" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">
                        üìä Grafana
                    </a>
                </div>
                <div class="status-item">
                    <a href="/logout" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">
                        üö™ Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Backtesting Controls -->
        <div class="backtest-controls">
            <div class="backtest-header">
                <h3 class="backtest-title">üìä Analysis Mode</h3>
                <span id="modeIndicator" class="mode-indicator mode-live">LIVE MODE</span>
            </div>
            
            <div class="date-controls">
                <label for="analysisDate">Analysis Date:</label>
                <input type="date" id="analysisDate" class="date-input" />
                <button id="backtestBtn" class="btn btn-backtest">üîç Backtest</button>
                <button id="liveBtn" class="btn btn-live">üì° Live Mode</button>
                <button id="refreshBtn" class="btn btn-secondary">üîÑ Refresh Charts</button>
            </div>
            
            <div class="date-controls" style="margin-top: 10px;">
                <label for="refreshInterval">Auto Refresh:</label>
                <select id="refreshInterval" class="date-input" disabled="true">
                    <option value="5000">5 seconds</option>
                    <option value="10000" selected>10 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                    <option value="600000">10 minutes</option>
                    <option value="0">Manual only</option>
                </select>
                <span id="refreshStatus" style="margin-left: 10px; font-size: 12px; color: #666;">Next refresh in: <span id="countdown">10</span>s</span>
            </div>
            
        </div>


        <!-- Market Bias Analysis Section -->
        <div class="card" style="margin-bottom: 10px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">üéØ Market Bias Analysis</h3>
                <span class="card-icon" style="font-size: 20px;">üìä</span>
            </div>
            <div class="metrics-grid" style="gap: 10px; margin-bottom: 10px;">
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasScore" style="font-size: 18px;">0.0</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Score</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasDirection" style="font-size: 18px;">Neutral</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Direction</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasStrength" style="font-size: 18px;">Weak</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Strength</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="riskLevel" style="font-size: 18px;">Medium</div>
                    <div class="metric-label" style="font-size: 11px;">Risk Level</div>
                </div>
            </div>
        </div>

        <!-- TPO Charts Section (full width) -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">üìà TPO Market Profile</h3>
                <span class="card-icon">üìä</span>
            </div>
            <div class="tpo-chart-container" style="height: 600px;">
                <img id="tpoChartImage" src="" alt="TPO Charts" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
            </div>
        </div>

        <!-- Futures Order Flow Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">üìä Nifty 50 Futures Order Flow - latest 2 ticks (Last Trading Day)</h3>
                <span class="card-icon" style="font-size: 20px;">üìà</span>
            </div>
            <div class="tpo-chart-container" style="height: 200px; overflow-y: auto;">
                <table id="futuresOrderFlowTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Time</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Side</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Quantity</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Orders</th>
                        </tr>
                    </thead>
                    <tbody id="futuresOrderFlowBody">
                        <tr>
                            <td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading order flow data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% if show_holdings %}
        <!-- Today's P&L Summary Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">üìä P&L Summary</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadPnlSummary('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as Excel">
                        üì• Excel
                    </button>
                    <button onclick="downloadPnlSummary('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as PDF">
                        üì• PDF
                    </button>
                    <span class="card-icon">üí∞</span>
                </div>
            </div>
            <div style="padding: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Category</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Today's P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Overall P&L</th>
                        </tr>
                    </thead>
                    <tbody id="pnlSummaryTableBody">
                        <tr>
                            <td colspan="3" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading P&L summary...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Portfolio Value Chart Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">üìà Total Portfolio Value</h3>
                <span class="card-icon">üìä</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label for="portfolioDaysSelector" style="margin-right: 10px; font-size: 12px;">Days:</label>
                    <select id="portfolioDaysSelector" onchange="loadPortfolioChart(this.value)" style="padding: 5px 10px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="7">7 Days</option>
                        <option value="30" selected>30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">180 Days</option>
                        <option value="365">1 Year</option>
                    </select>
                </div>
                <canvas id="portfolioChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Current Positions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">üìä Active Positions</h3>
                <span class="card-icon">üìà</span>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Timestamp</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Type</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Symbol</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Product</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Exchange</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Avg. Price</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading positions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% if show_holdings %}
        <!-- Current Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">üíº Current Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        üì• Excel
                    </button>
                    <button onclick="downloadHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        üì• PDF
                    </button>
                    <button onclick="addGTTForAll(5)" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" disabled>
                        + Add GTT (5% SL)
                    </button>
                    <button onclick="addGTTForAll(10)" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" disabled>
                        + Add GTT (10% SL)
                    </button>
                    <button onclick="viewAllGTTs()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #6c757d; color: white;" disabled>
                        View GTTs
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead id="holdingsTableHeader">
                        <tr style="background-color: #f8f9fa;">
                            <th onclick="sortHoldings('trading_symbol')" style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; cursor: pointer; user-select: none;" id="header_trading_symbol">Symbol ‚Üï</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Sparkline (last 30D)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Qty</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Avg. Price</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">LTP</th>
                            <th onclick="sortHoldings('invested_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_invested_amount">Invested Amount ‚Üï</th>
                            <th onclick="sortHoldings('current_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_current_amount">Current Amount ‚Üï</th>
                            <th onclick="sortHoldings('pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_pnl">Total P&L ‚Üï</th>
                            <th onclick="sortHoldings('today_pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_today_pnl">Today's P&L ‚Üï</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Existing GTT</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Set New GTT</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTableBody">
                        {% for holding in holdings_info.holdings %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <strong>{{ holding.trading_symbol }}</strong>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                <canvas id="sparkline-{{ holding.trading_symbol }}" width="120" height="40" onclick="showCandlestick('{{ holding.trading_symbol }}')" style="cursor: pointer;"></canvas>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {{ holding.quantity }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ‚Çπ{{ "%.2f"|format(holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ‚Çπ{{ "%.2f"|format(holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ‚Çπ{{ "%.2f"|format(holding.quantity * holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ‚Çπ{{ "%.2f"|format(holding.quantity * holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {% if holding.pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold;">‚Çπ{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 10px; color: #28a745;">{{ "+%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold;">‚Çπ{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 10px; color: #dc3545;">{{ "%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {%- if holding.today_pnl is defined -%}
                                    {% set today_pnl = holding.today_pnl %}
                                {%- else -%}
                                    {% set today_pnl = 0 %}
                                {%- endif -%}
                                {%- if holding.pct_change is defined -%}
                                    {% set pct_change = holding.pct_change %}
                                {%- else -%}
                                    {% set pct_change = 0 %}
                                {%- endif -%}
                                {% if today_pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold;">‚Çπ{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 10px; color: #28a745;">{{ "+%.2f"|format(pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold;">‚Çπ{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 10px; color: #dc3545;">{{ "%.2f"|format(pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">
                                {% if holding.existing_gtt %}
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #28a745; font-weight: bold;">‚úì Active</span>
                                    <span style="color: #666;">‚Çπ{{ "%.2f"|format(holding.existing_gtt.trigger_price) }}</span>
                                    <button onclick="cancelGTT({{ holding.existing_gtt.trigger_id }}, '{{ holding.trading_symbol }}')" 
                                            class="btn" style="padding: 2px 6px; font-size: 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        Cancel
                                    </button>
                                </div>
                                {% else %}
                                <span style="color: #999;">No GTT</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                <form onsubmit="setGTT(event, '{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})" style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                    <input type="number" id="trigger_price_{{ holding.instrument_token }}" step="0.05" placeholder="Price" 
                                           style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" required>
                                    <button type="submit" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Set</button>
                                </form>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="buyMore('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}')">
                                        Buy More
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="sellSome('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell Some
                                    </button>
                                    <button class="btn" style="padding: 4px 8px; font-size: 11px; background-color: #dc3545; color: white;" onclick="sellAll('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell All
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            {% set total_pages = (holdings_info.total_count / holdings_info.per_page) | round(0, 'ceil') | int %}
            <div id="holdingsPagination" style="display: flex; justify-content: center; align-items: center; padding: 20px; border-top: 1px solid #eee;">
                {% if total_pages > 1 %}
                    {% if holdings_info.page > 1 %}
                    <button onclick="loadHoldingsPage({{ holdings_info.page - 1 }})" 
                       style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">&laquo; Previous</button>
                    {% else %}
                    <span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">&laquo; Previous</span>
                    {% endif %}
                    <span style="margin: 0 10px; font-weight: 600;">Page {{ holdings_info.page }} of {{ total_pages }}</span>
                    {% if holdings_info.page < total_pages %}
                    <button onclick="loadHoldingsPage({{ holdings_info.page + 1 }})" 
                       style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Next &raquo;</button>
                    {% else %}
                    <span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">Next &raquo;</span>
                    {% endif %}
                {% else %}
                    <span style="margin: 0 10px; font-weight: 600;">Page 1 of 1</span>
                {% endif %}
            </div>
        </div>

        <!-- Mutual Fund Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">üìä Mutual Fund Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadMFHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        üì• Excel
                    </button>
                    <button onclick="downloadMFHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        üì• PDF
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">MF Name</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Invested Amount</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Current Value</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Net Change %</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Day Change %</th>
                        </tr>
                    </thead>
                    <tbody id="mfHoldingsTableBody">
                        <tr>
                            <td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading MF holdings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>  <!-- Close container div -->

    <!-- Load TPO chart renderer -->
    <script src="/static/tpo-charts.js"></script>
    
    <script>
        // Global variables for market bias analysis
        let currentAnalysisDate = null;
        let marketBiasData = null;
        let refreshInterval = 30000; // Default 10 seconds
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = 10;
        
        // Initialize refresh system
        function initializeRefreshSystem() {
            // Check if countdown elements exist before initializing
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, delaying refresh system initialization');
                // Retry after a short delay
                setTimeout(initializeRefreshSystem, 100);
                return;
            }
            
            // Start the refresh timer
            startRefreshTimer();
            
            // Start countdown display
            startCountdown();
        }
        
        // Start refresh timer
        function startRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            if (refreshInterval > 0) {
                refreshTimer = setInterval(function() {
                    refreshDashboardData();
                }, refreshInterval);
            }
        }
        
        // Start countdown display
        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
                
                countdownTimer = setInterval(function() {
                    countdownValue--;
                    updateCountdownDisplay();
                    
                    if (countdownValue <= 0) {
                        countdownValue = Math.floor(refreshInterval / 1000);
                    }
                }, 1000);
            } else {
                updateCountdownDisplay();
            }
        }
        
        // Update countdown display
        function updateCountdownDisplay() {
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            // Check if elements exist before trying to update them
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, skipping update');
                return;
            }
            
            if (refreshInterval === 0) {
                countdownElement.textContent = 'Manual';
                refreshStatusElement.textContent = 'Auto refresh disabled';
            } else {
                countdownElement.textContent = countdownValue;
                refreshStatusElement.textContent = `Next refresh in: ${countdownValue}s`;
            }
        }
        
        // Refresh dashboard data
        function refreshDashboardData() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    // Update status indicators
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                });
            
            // Update margin data
            if (window.tpoChartRenderer) {
                window.tpoChartRenderer.loadMarginData();
            }
            
            // Refresh futures data
            fetch('/api/refresh_futures', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Futures data refreshed: ${data.fetched_count}/${data.total_symbols} symbols`);
                    } else {
                        console.error('Error refreshing futures data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error refreshing futures data:', error);
                });
            
            // Update market bias analysis and futures order flow
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            
            // Only update holdings if enabled
            {% if show_holdings %}
            // Refresh holdings table with current page
            if (typeof currentHoldingsPage !== 'undefined') {
                loadHoldingsPage(currentHoldingsPage);
            }
            
            // Update MF holdings
            loadMFHoldings();
            
            // Update P&L Summary
            loadPnlSummary();
            
            // Update Portfolio Chart
            const daysSelector = document.getElementById('portfolioDaysSelector');
            if (daysSelector) {
                loadPortfolioChart(daysSelector.value || 30);
            }
            {% endif %}
        }

        function updateStatusIndicators(data) {
            // Update token status
            const tokenIndicator = document.querySelector('.status-item:nth-child(1) .status-indicator');
            tokenIndicator.className = `status-indicator ${data.token_valid ? 'status-online' : 'status-offline'}`;
            
            // Update tick status
            const tickIndicator = document.querySelector('.status-item:nth-child(2) .status-indicator');
            tickIndicator.className = `status-indicator ${data.tick_active ? 'status-online' : 'status-offline'}`;
        }
        
        // Load market bias analysis
        function loadMarketBiasAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || null;
            
            // Load market bias data
            fetch(`/api/market_bias${analysisDate ? '?analysis_date=' + analysisDate : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading market bias:', data.error);
                        return;
                    }
                    
                    marketBiasData = data.analysis;
                    updateMarketBiasDisplay();
                })
                .catch(error => {
                    console.error('Error fetching market bias:', error);
                });
        }
        
        // Load futures order flow data
        function loadFuturesOrderFlow() {
            fetch('/api/futures_order_flow')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading futures order flow:', data.error);
                        updateFuturesOrderFlowDisplay([]);
                        return;
                    }
                    
                    updateFuturesOrderFlowDisplay(data.order_flow);
                })
                .catch(error => {
                    console.error('Error fetching futures order flow:', error);
                    updateFuturesOrderFlowDisplay([]);
                });
        }
        
        // Update futures order flow display
        function updateFuturesOrderFlowDisplay(orderFlowData) {
            const tbody = document.getElementById('futuresOrderFlowBody');
            const titleElement = document.querySelector('#futuresOrderFlowTable').closest('.card').querySelector('.card-title');
            
            if (!orderFlowData || orderFlowData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No order flow data available for last trading day</td></tr>';
                // Reset title to default
                titleElement.textContent = 'üìä Nifty 50 Futures Order Flow (Last Trading Day)';
                return;
            }
            
            let html = '';
            let tradingDate = '';
            
            // Get trading date from first order
            if (orderFlowData.length > 0 && orderFlowData[0].run_date) {
                tradingDate = orderFlowData[0].run_date;
                // Update the title with trading date
                titleElement.textContent = `üìä Nifty 50 Futures Order Flow (Last Trading Day - ${tradingDate})`;
            }
            
            orderFlowData.forEach((order, index) => {
                const sideClass = order.side === 'buy' ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                const sideText = order.side === 'buy' ? 'BUY' : 'SELL';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd; font-size: 12px;">${order.timestamp}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; ${sideClass}; font-size: 12px;">${sideText}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.quantity.toLocaleString()}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.orders}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update market bias display
        function updateMarketBiasDisplay() {
            if (!marketBiasData) return;
            
            const comprehensiveBias = marketBiasData.comprehensive_bias;
            const recommendations = marketBiasData.trading_recommendations;
            
            // Update bias metrics
            document.getElementById('biasScore').textContent = comprehensiveBias.bias_score.toFixed(1);
            document.getElementById('biasDirection').textContent = comprehensiveBias.bias_direction;
            document.getElementById('biasStrength').textContent = comprehensiveBias.bias_strength;
            document.getElementById('riskLevel').textContent = recommendations.risk_level;
            
            // Color code the bias direction
            const biasDirectionElement = document.getElementById('biasDirection');
            biasDirectionElement.className = 'metric-value';
            if (comprehensiveBias.bias_direction === 'Bullish') {
                biasDirectionElement.style.color = '#28a745';
            } else if (comprehensiveBias.bias_direction === 'Bearish') {
                biasDirectionElement.style.color = '#dc3545';
            } else {
                biasDirectionElement.style.color = '#6c757d';
            }
            
            // Color code the bias strength
            const biasStrengthElement = document.getElementById('biasStrength');
            biasStrengthElement.className = 'metric-value';
            if (comprehensiveBias.bias_strength === 'Strong') {
                biasStrengthElement.style.color = '#dc3545';
            } else if (comprehensiveBias.bias_strength === 'Moderate') {
                biasStrengthElement.style.color = '#ffc107';
            } else {
                biasStrengthElement.style.color = '#6c757d';
            }
        }
        
        
        // Event listeners for analysis date changes
        document.getElementById('analysisDate').addEventListener('change', function() {
            try {
                loadMarketBiasAnalysis();
            } catch (error) {
                console.error('Error in analysis date change:', error);
            }
        });
        
        // Event listener for refresh interval changes
        document.getElementById('refreshInterval').addEventListener('change', function() {
            refreshInterval = parseInt(this.value);
            initializeRefreshSystem();
        });
        
        // Event listener for manual refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            refreshDashboardData();
            // Reset countdown
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
            }
        });
        
        document.getElementById('backtestBtn').addEventListener('click', function() {
            const analysisDate = document.getElementById('analysisDate').value;
            if (!analysisDate) {
                alert('Please select a date for backtesting');
                return;
            }
            
            // Update analysis date via API
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `date=${analysisDate}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'BACKTEST MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-backtest';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
            })
            .catch(error => {
                console.error('Error setting analysis date:', error);
            });
        });
        
        document.getElementById('liveBtn').addEventListener('click', function() {
            // Switch to live mode
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'date=live'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'LIVE MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-live';
                document.getElementById('analysisDate').value = '';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
            })
            .catch(error => {
                console.error('Error switching to live mode:', error);
            });
        });
        
        // Global variable for sort settings
        let sortColumn = 'trading_symbol';
        let sortDirection = 'asc';
        let currentHoldingsPage = {% if holdings_info %}{{ holdings_info.page }}{% else %}1{% endif %};
        
        // Sort holdings function
        function sortHoldings(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header indicators
            updateSortIndicators();
            
            // Reload first page with new sort
            loadHoldingsPage(1);
        }
        
        // Update sort indicators in table headers
        function updateSortIndicators() {
            const headers = ['header_trading_symbol', 'header_invested_amount', 'header_current_amount', 'header_pnl', 'header_today_pnl'];
            const labelMap = {
                'header_trading_symbol': 'Symbol',
                'header_invested_amount': 'Invested Amount',
                'header_current_amount': 'Current Amount',
                'header_pnl': 'Total P&L',
                'header_today_pnl': 'Today\'s P&L'
            };
            
            headers.forEach(headerId => {
                const header = document.getElementById(headerId);
                if (header) {
                    const column = headerId.replace('header_', '');
                    if (sortColumn === column) {
                        header.innerHTML = `${labelMap[headerId]} ${sortDirection === 'asc' ? '‚Üë' : '‚Üì'}`;
                    } else {
                        header.innerHTML = `${labelMap[headerId]} ‚Üï`;
                    }
                }
            });
        }
        
        // Load holdings page via AJAX
        function loadHoldingsPage(page) {
            // Ensure sortColumn and sortDirection are defined
            const sortBy = sortColumn || 'trading_symbol';
            const sortDir = sortDirection || 'asc';
            // Pass sort parameters to API for server-side sorting
            fetch(`/api/holdings?page=${page}&per_page=10&sort_by=${sortBy}&sort_dir=${sortDir}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading holdings:', data.error);
                        return;
                    }
                    
                    // Update table body (data is already sorted by server)
                    const tbody = document.getElementById('holdingsTableBody');
                    tbody.innerHTML = '';
                    
                    data.holdings.forEach(holding => {
                        const pnlClass = holding.pnl >= 0 ? '28a745' : 'dc3545';
                        const pnlColor = holding.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd;">
                                    <strong>${holding.trading_symbol}</strong>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-ajax-${holding.trading_symbol}" width="120" height="40" onclick="showCandlestick('${holding.trading_symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ${holding.quantity}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ‚Çπ${holding.average_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ‚Çπ${holding.last_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ‚Çπ${holding.invested_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ‚Çπ${holding.current_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <div style="${pnlColor}">‚Çπ${holding.pnl.toFixed(2)}</div>
                                    <div style="font-size: 10px; ${holding.pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pnl_pct_change >= 0 ? '+' : ''}${holding.pnl_pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <div style="${holding.today_pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;'}">‚Çπ${holding.today_pnl.toFixed(2)}</div>
                                    <div style="font-size: 10px; ${holding.today_pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pct_change >= 0 ? '+' : ''}${holding.pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">
                                    ${holding.existing_gtt ? `
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <span style="color: #28a745; font-weight: bold;">‚úì Active</span>
                                        <span style="color: #666;">‚Çπ${holding.existing_gtt.trigger_price.toFixed(2)}</span>
                                        <button onclick="cancelGTT(${holding.existing_gtt.trigger_id}, '${holding.trading_symbol}')" 
                                                class="btn" style="padding: 2px 6px; font-size: 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                            Cancel
                                        </button>
                                    </div>
                                    ` : `
                                    <span style="color: #999;">No GTT</span>
                                    `}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                    <form onsubmit="setGTT(event, '${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})" style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                        <input type="number" id="trigger_price_ajax_${holding.instrument_token}" step="0.05" placeholder="Price" 
                                               style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" required>
                                        <button type="submit" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Set</button>
                                    </form>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                        <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="buyMore('${holding.instrument_token}', '${holding.trading_symbol}')">
                                            Buy More
                                        </button>
                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="sellSome('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell Some
                                        </button>
                                        <button class="btn" style="padding: 4px 8px; font-size: 11px; background-color: #dc3545; color: white;" onclick="sellAll('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell All
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Update current page tracker
                    currentHoldingsPage = data.page;
                    
                    // Update pagination controls
                    const total_pages = Math.ceil(data.total_count / data.per_page);
                    const paginationDiv = document.getElementById('holdingsPagination');
                    paginationDiv.innerHTML = '';
                    
                    if (data.page > 1) {
                        paginationDiv.innerHTML += `<button onclick="loadHoldingsPage(${data.page - 1})" 
                            style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">&laquo; Previous</button>`;
                    } else {
                        paginationDiv.innerHTML += `<span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">&laquo; Previous</span>`;
                    }
                    
                    paginationDiv.innerHTML += `<span style="margin: 0 10px; font-weight: 600;">Page ${data.page} of ${total_pages}</span>`;
                    
                    if (data.page < total_pages) {
                        paginationDiv.innerHTML += `<button onclick="loadHoldingsPage(${data.page + 1})" 
                            style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Next &raquo;</button>`;
                    } else {
                        paginationDiv.innerHTML += `<span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">Next &raquo;</span>`;
                    }
                    
                    // Scroll to top of holdings table
                    document.getElementById('holdingsTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Load sparklines for the displayed holdings
                    data.holdings.forEach(holding => {
                        loadSparkline(holding.trading_symbol);
                    });
                })
                .catch(error => {
                    console.error('Error fetching holdings:', error);
                });
        }
        
        // GTT management functions
        // Download functions
        function downloadHoldings(format) {
            const url = format === 'excel' ? '/api/download/holdings/excel' : '/api/download/holdings/pdf';
            window.location.href = url;
        }
        
        function downloadMFHoldings(format) {
            const url = format === 'excel' ? '/api/download/mf/excel' : '/api/download/mf/pdf';
            window.location.href = url;
        }
        
        function downloadPnlSummary(format) {
            const url = format === 'excel' ? '/api/download/pnl_summary/excel' : '/api/download/pnl_summary/pdf';
            window.location.href = url;
        }
        
        async function addGTTForAll(stopLossPercent) {
            // Show custom confirmation dialog
            const confirmationText = prompt(
                `‚ö†Ô∏è WARNING: This will add GTT orders with ${stopLossPercent}% stop-loss for ALL holdings.\n\n` +
                `This action will affect all your current holdings. Please type "I UNDERSTAND" to continue:`
            );
            
            if (confirmationText !== "I UNDERSTAND") {
                if (confirmationText !== null) {  // User clicked Cancel or typed something else
                    alert('Operation cancelled. You must type "I UNDERSTAND" exactly to proceed.');
                }
                return;
            }
            
            try {
                const response = await fetch(`/api/add_gtt_for_all?stop_loss_percentage=${stopLossPercent}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully added ${data.results.success.length} GTTs\nFailed: ${data.results.failed.length}\nSkipped: ${data.results.skipped.length}`);
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding GTT for all:', error);
                alert('Error adding GTTs. Please try again.');
            }
        }
        
        async function viewAllGTTs() {
            try {
                const response = await fetch('/api/get_all_gtts');
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                if (data.gtts && data.gtts.length > 0) {
                    let message = `Active GTT Orders (${data.gtts.length}):\n\n`;
                    data.gtts.forEach((gtt, index) => {
                        message += `${index + 1}. ${gtt.tradingsymbol || 'N/A'} - Trigger ID: ${gtt.trigger_id || gtt.id}\n`;
                    });
                    alert(message);
                } else {
                    alert('No active GTT orders found.');
                }
            } catch (error) {
                console.error('Error fetching GTTs:', error);
                alert('Error fetching GTTs. Please try again.');
            }
        }
        
        async function cancelGTT(triggerId, tradingSymbol) {
            if (!confirm(`Cancel GTT for ${tradingSymbol}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cancel_gtt/${triggerId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT cancelled successfully for ${tradingSymbol}`);
                    // Reload holdings to update GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to cancel GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling GTT:', error);
                alert('Error cancelling GTT. Please try again.');
            }
        }
        
        async function setGTT(event, instrumentToken, tradingSymbol, quantity) {
            event.preventDefault();
            const triggerInput = event.target.querySelector(`#trigger_price_${instrumentToken}`);
            const triggerPrice = triggerInput.value;
            
            if (!triggerPrice) {
                alert('Please enter a trigger price');
                return;
            }
            
            try {
                const response = await fetch('/api/set_gtt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        instrument_token: instrumentToken,
                        tradingsymbol: tradingSymbol,
                        quantity: quantity,
                        trigger_price: parseFloat(triggerPrice)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT set successfully for ${tradingSymbol}!\nTrigger ID: ${data.trigger_id}`);
                    triggerInput.value = '';
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to set GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error setting GTT:', error);
                alert('Error setting GTT. Please try again.');
            }
        }
        
        // Holdings action functions
        function buyMore(instrumentToken, tradingSymbol) {
            const quantity = prompt(`Enter quantity to buy for ${tradingSymbol}:`);
            if (quantity && quantity > 0) {
                // TODO: Implement buy order API call
                alert(`Buy order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Buy order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/buy_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
         
        function sellSome(instrumentToken, tradingSymbol, currentQuantity) {
            const quantity = prompt(`Enter quantity to sell for ${tradingSymbol} (max: ${currentQuantity}):`);
            if (quantity && quantity > 0 && quantity <= currentQuantity) {
                // TODO: Implement sell order API call
                alert(`Sell order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            } else if (quantity > currentQuantity) {
                alert('Quantity cannot exceed current holding');
            }
        }
        
        function sellAll(instrumentToken, tradingSymbol, quantity) {
            if (confirm(`Are you sure you want to sell all ${quantity} shares of ${tradingSymbol}?`)) {
                // TODO: Implement sell all API call
                alert(`Sell all order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell all order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_all', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
        
        // Load positions data
        function loadPositions() {
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading positions:', data.error);
                        document.getElementById('positionsTableBody').innerHTML = 
                            '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('positionsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.positions || data.positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No active positions</td></tr>';
                        return;
                    }
                    
                    data.positions.forEach(position => {
                        const pnlColor = position.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        const typeColor = position.position_type === 'LONG' ? '#28a745' : position.position_type === 'SHORT' ? '#dc3545' : '#6c757d';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.fetch_timestamp || ''}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; color: ${typeColor};">${position.position_type || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; font-size: 11px;">${position.trading_symbol || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.product || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.exchange || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">‚Çπ${position.average_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">
                                    <span style="${pnlColor}">‚Çπ${position.pnl.toFixed(2)}</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching positions:', error);
                    document.getElementById('positionsTableBody').innerHTML = 
                        '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                });
        }
        
        // Helper function to format numbers in Indian locale (lakhs/crores)
        function formatIndianNumber(num) {
            // Round to nearest integer
            const rounded = Math.round(num);
            
            // Format with Indian locale commas
            return rounded.toLocaleString('en-IN');
        }
        
        // Load P&L Summary sdfsdf
        function loadPnlSummary() {
            fetch('/api/today_pnl_summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading P&L summary:', data.error);
                        return;
                    }
                    
                    const tbody = document.getElementById('pnlSummaryTableBody');
                    tbody.innerHTML = '';
                    
                    const categories = [
                        { 
                            name: 'Equity Portfolio', 
                            todayValue: data.equity_pnl || 0.0,
                            overallValue: data.equity_overall_pnl || 0.0
                        },
                        { 
                            name: 'Mutual Fund Portfolio', 
                            todayValue: data.mf_pnl || 0.0,
                            overallValue: data.mf_overall_pnl || 0.0
                        },
                        { 
                            name: 'Intraday Trades', 
                            todayValue: data.intraday_pnl || 0.0,
                            overallValue: null // Intraday only has today's P&L
                        },
                        { 
                            name: 'Total', 
                            todayValue: data.total_today_pnl || 0.0,
                            overallValue: data.total_overall_pnl || 0.0,
                            isTotal: true 
                        }
                    ];
                    
                    categories.forEach(cat => {
                        const todayColor = cat.todayValue >= 0 ? '#28a745' : '#dc3545';
                        const overallColor = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? (cat.overallValue >= 0 ? '#28a745' : '#dc3545') 
                            : todayColor;
                        const style = cat.isTotal ? 'font-weight: bold; font-size: 14px; border-top: 2px solid #ddd;' : '';
                        const todayFormatted = formatIndianNumber(cat.todayValue);
                        const overallFormatted = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? formatIndianNumber(cat.overallValue) 
                            : '-';
                        
                        const row = `
                            <tr style="${style}">
                                <td style="padding: 12px; border: 1px solid #ddd; ${cat.isTotal ? 'font-weight: bold;' : ''}">${cat.name}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${todayColor}; font-weight: bold;">
                                    ${cat.todayValue >= 0 ? '+' : ''}‚Çπ${todayFormatted}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${overallColor}; font-weight: bold;">
                                    ${cat.overallValue !== null && cat.overallValue !== undefined 
                                        ? `${cat.overallValue >= 0 ? '+' : ''}‚Çπ${overallFormatted}`
                                        : '-'}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching P&L summary:', error);
                });
        }
        
        // Load Portfolio Chart
        let portfolioChartInstance = null;
        function loadPortfolioChart(days) {
            fetch(`/api/portfolio_history?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading portfolio history:', data.error);
                        return;
                    }
                    
                    const ctx = document.getElementById('portfolioChart').getContext('2d');
                    
                    // Destroy previous chart instance if it exists
                    if (portfolioChartInstance) {
                        portfolioChartInstance.destroy();
                    }
                    
                    // Prepare chart data
                    const labels = data.portfolio_history.map(item => {
                        const date = new Date(item.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    });
                    
                    const equityData = data.portfolio_history.map(item => item.equity || 0);
                    const mfData = data.portfolio_history.map(item => item.mutual_fund || 0);
                    const totalData = data.portfolio_history.map(item => item.total || 0);
                    
                    portfolioChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Equity',
                                    data: equityData,
                                    borderColor: 'rgb(40, 167, 69)',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Mutual Fund',
                                    data: mfData,
                                    borderColor: 'rgb(13, 110, 253)',
                                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Total Portfolio',
                                    data: totalData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ‚Çπ' + context.parsed.y.toLocaleString('en-IN', {maximumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return '‚Çπ' + value.toLocaleString('en-IN', {maximumFractionDigits: 0});
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching portfolio history:', error);
                });
        }
        
        // Load MF holdings data
        function loadMFHoldings() {
            fetch('/api/mf_holdings')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading MF holdings:', data.error);
                        document.getElementById('mfHoldingsTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('mfHoldingsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.mf_holdings || data.mf_holdings.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No MF holdings found</td></tr>';
                        return;
                    }
                    
                    data.mf_holdings.forEach(mf => {
                        const pnlColor = mf.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        const netChangeColor = mf.net_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                        const dayChangeColor = mf.day_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${mf.fund || mf.tradingsymbol || '-'}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Çπ${mf.invested_amount.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Çπ${mf.current_value.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${pnlColor}">‚Çπ${mf.pnl.toFixed(2)}</span>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${netChangeColor}">${mf.net_change_percentage >= 0 ? '+' : ''}${mf.net_change_percentage.toFixed(2)}%</span>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${dayChangeColor}">${mf.day_change_percentage >= 0 ? '+' : ''}${mf.day_change_percentage.toFixed(2)}%</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching MF holdings:', error);
                    document.getElementById('mfHoldingsTableBody').innerHTML = 
                        '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                });
        }
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            loadPositions();
            {% if show_holdings %}
            loadMFHoldings();
            loadPnlSummary();
            loadPortfolioChart(30);
            {% endif %}
            initializeRefreshSystem();
        });
    </script>

    <!-- Candlestick Chart Modal -->
    <div id="candlestickModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); padding: 20px; border: 1px solid #888; width: 80vw; height: 80vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                <h2 id="modalStockSymbol" style="margin: 0; font-size: 1.5em;">Stock Chart</h2>
                <button onclick="closeCandlestickModal()" style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 14px;">Close</button>
            </div>
            <div style="margin-bottom: 15px; flex-shrink: 0;">
                <label for="chartDays">Days to display:</label>
                <select id="chartDays" onchange="updateCandlestickChart()" style="padding: 5px 10px; margin-left: 10px;">
                    <option value="7">7 days</option>
                    <option value="15">15 days</option>
                    <option value="30">30 days</option>
                    <option value="60">60 days</option>
                    <option value="90" selected>90 days</option>
                </select>
            </div>
            <div style="flex: 1; overflow: hidden; position: relative;">
                <canvas id="candlestickChartCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentStockSymbol = '';
        let candlestickChart = null;

        function loadSparklines() {
            {% for holding in holdings_info.holdings %}
            loadSparkline('{{ holding.trading_symbol }}');
            {% endfor %}
        }

        function loadSparkline(symbol) {
            fetch(`/api/sparkline/${symbol}?days=30`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(`Error loading sparkline for ${symbol}:`, data.error);
                        return;
                    }
                    
                    // Try to find canvas with or without 'ajax-' prefix
                    let canvas = document.getElementById(`sparkline-${symbol}`);
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-ajax-${symbol}`);
                    }
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const prices = data.prices;
                    if (!prices || prices.length === 0) return;
                    
                    const width = canvas.width;
                    const height = canvas.height;
                    const padding = 5;
                    
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceRange = maxPrice - minPrice || 1;
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, width, height);
                    
                    // Determine color based on trend
                    const firstPrice = prices[0];
                    const lastPrice = prices[prices.length - 1];
                    const color = lastPrice >= firstPrice ? '#28a745' : '#dc3545';
                    
                    // Draw line
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    for (let i = 0; i < prices.length; i++) {
                        const x = padding + (i / (prices.length - 1)) * (width - 2 * padding);
                        const y = height - padding - ((prices[i] - minPrice) / priceRange) * (height - 2 * padding);
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    
                    ctx.stroke();
                })
                .catch(error => console.error(`Error loading sparkline for ${symbol}:`, error));
        }

        function showCandlestick(symbol) {
            currentStockSymbol = symbol;
            document.getElementById('modalStockSymbol').textContent = `${symbol} - Candlestick Chart`;
            document.getElementById('candlestickModal').style.display = 'block';
            updateCandlestickChart();
        }

        function closeCandlestickModal() {
            document.getElementById('candlestickModal').style.display = 'none';
            if (candlestickChart) {
                candlestickChart.destroy();
                candlestickChart = null;
            }
        }
        
        // Handle window resize to adjust chart size
        window.addEventListener('resize', function() {
            if (document.getElementById('candlestickModal').style.display !== 'none' && candlestickChart) {
                const canvas = document.getElementById('candlestickChartCanvas');
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                candlestickChart.resize();
            }
        });

        function updateCandlestickChart() {
            if (!currentStockSymbol) return;
            
            const days = document.getElementById('chartDays').value;
            
            fetch(`/api/candlestick/${currentStockSymbol}?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading candlestick data:', data.error);
                        return;
                    }
                    
                    console.log('Candlestick data received:', data);
                    console.log('First data point structure:', data.data[0]);
                    console.log('Sample data point:', JSON.stringify(data.data[0], null, 2));
                    
                    const ctx = document.getElementById('candlestickChartCanvas').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (candlestickChart) {
                        candlestickChart.destroy();
                    }
                    
                    // Prepare data for Chart.js Financial candlestick
                    // Data format: {x: timestamp, o: open, h: high, l: low, c: close}
                    const candlestickData = data.data.map(d => {
                        // Convert date string to timestamp
                        const timestamp = new Date(d.date).getTime();
                        return {
                            x: timestamp, o: d.open, h: d.high, l: d.low, c: d.close
                        };
                    });
                    
                    // Prepare indicator data for line charts
                    const sma20Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_20
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma50Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_50
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma200Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_200
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const supertrendData = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.supertrend,
                        direction: d.supertrend_direction
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    console.log('Candlestick data formatted:', candlestickData.slice(0, 5));
                    console.log('SMA 20 data:', sma20Data.slice(0, 5));
                    console.log('SMA 50 data:', sma50Data.slice(0, 5));
                    console.log('SMA 200 data:', sma200Data.slice(0, 5));
                    console.log('Supertrend data:', supertrendData.slice(0, 5));
                    
                    // Get the container dimensions
                    const container = ctx.canvas.parentElement;
                    ctx.canvas.width = container.clientWidth;
                    ctx.canvas.height = container.clientHeight;
                    
                    // Create candlestick chart using Chart.js Financial
                    try {
                    // First, create the candlestick chart
                    candlestickChart = new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: currentStockSymbol,
                                data: candlestickData
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: `${currentStockSymbol} - Last ${days} Days`
                                }
                            }
                        }
                    });
                    
                    // Add indicator datasets after chart creation
                    if (sma20Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 20',
                            data: sma20Data,
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma50Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 50',
                            data: sma50Data,
                            type: 'line',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma200Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 200',
                            data: sma200Data,
                            type: 'line',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (supertrendData.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'Supertrend',
                            data: supertrendData,
                            type: 'line',
                            borderColor: 'rgba(138, 43, 226, 1)',  // Default fallback
                            backgroundColor: 'rgba(138, 43, 226, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false,
                            segment: {
                                borderColor: (ctx) => {
                                    const segment = ctx.p0;
                                    // Get direction from the data point
                                    const dataIndex = ctx.p0DataIndex;
                                    const point = supertrendData[dataIndex];
                                    if (point && point.direction === 1) {
                                        return 'rgba(40, 167, 69, 1)';  // Green for uptrend
                                    } else {
                                        return 'rgba(220, 53, 69, 1)';  // Red for downtrend
                                    }
                                }
                            }
                        });
                    }
                    
                    // Update the chart to render the new datasets
                    candlestickChart.update();
                    console.log('Chart created successfully');
                    console.log('Chart datasets after update:', candlestickChart.data.datasets.length);
                    candlestickChart.data.datasets.forEach((ds, index) => {
                        console.log(`Dataset ${index}:`, ds.label, ds.type, 'data points:', ds.data.length);
                    });
                    } catch (error) {
                        console.error('Error creating chart:', error);
                        console.error(error.stack);
                    }
                })
                .catch(error => console.error('Error loading candlestick data:', error));
        }

        // Load sparklines after page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSparklines();
        });
    </script>
</body>
</html>
