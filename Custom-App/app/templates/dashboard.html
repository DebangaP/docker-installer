<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #4CAF50;
        }

        .status-offline {
            background-color: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-icon {
            font-size: 24px;
        }

        .tpo-chart-container {
            height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
        }

        .chart-placeholder {
            text-align: center;
            color: #666;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .backtest-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .backtest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .backtest-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .mode-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .mode-live {
            background: #d4edda;
            color: #155724;
        }

        .mode-backtest {
            background: #fff3cd;
            color: #856404;
        }

        .date-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-backtest {
            background: #17a2b8;
            color: white;
        }

        .btn-live {
            background: #28a745;
            color: white;
        }

        .analysis-info {
            background: rgba(23, 162, 184, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #17a2b8;
        }

        .analysis-info h4 {
            color: #17a2b8;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .grafana-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 0;
        }

        .tab-button {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab-button {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">📊 Trading Dashboard</div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span>Kite Token: {{ token_status }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="lastUpdateText">Last Update: {{ last_update }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="totalTicksText">Total Ticks today: {{ total_ticks }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="marginCash">Cash: ₹0</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="marginBalance">Balance: ₹0</span>
                </div>
                <div class="status-item">
                    <a href="/logout" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">
                        🚪 Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <div class="tab-nav-container">
            <button class="tab-button active" onclick="switchTab('live-market')">
                📊 Live Market
            </button>
            <button class="tab-button" onclick="switchTab('holdings')">
                💼 Holdings
            </button>
            <button class="tab-button" onclick="switchTab('gainers-losers')">
                📈 Stocks
            </button>
            <button class="tab-button" onclick="switchTab('utilities')">
                🔧 Utilities
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Live Market Tab Content -->
        <div id="live-market-tab" class="tab-content active">
        <!-- Backtesting Controls -->
        <div class="backtest-controls">
            <div class="backtest-header">
                <h3 class="backtest-title">📊 Analysis Mode</h3>
                <span id="modeIndicator" class="mode-indicator mode-live">LIVE MODE</span>
            </div>
            
            <div class="date-controls">
                <label for="analysisDate">Analysis Date:</label>
                <input type="date" id="analysisDate" class="date-input" />
                <button id="backtestBtn" class="btn btn-backtest">🔍 Backtest</button>
                <button id="liveBtn" class="btn btn-live">📡 Live Mode</button>
                <button id="refreshBtn" class="btn btn-secondary">🔄 Refresh Charts</button>
            </div>
            
            <div class="date-controls" style="margin-top: 10px;">
                <label for="refreshInterval">Auto Refresh:</label>
                <select id="refreshInterval" class="date-input" disabled="true">
                    <option value="5000">5 seconds</option>
                    <option value="10000" selected>10 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                    <option value="600000">10 minutes</option>
                    <option value="0">Manual only</option>
                </select>
                <span id="refreshStatus" style="margin-left: 10px; font-size: 12px; color: #666;">Next refresh in: <span id="countdown">10</span>s</span>
            </div>
            
        </div>

        <!-- Market Bias Analysis Section -->
        <div class="card" style="margin-bottom: 10px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">🎯 Market Bias Analysis</h3>
                <span class="card-icon" style="font-size: 20px;">📊</span>
            </div>
            <div class="metrics-grid" style="gap: 10px; margin-bottom: 10px;">
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasScore" style="font-size: 18px;">0.0</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Score</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasDirection" style="font-size: 18px;">Neutral</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Direction</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasStrength" style="font-size: 18px;">Weak</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Strength</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="riskLevel" style="font-size: 18px;">Medium</div>
                    <div class="metric-label" style="font-size: 11px;">Risk Level</div>
                </div>
            </div>
        </div>

        <!-- TPO Charts Section (full width) -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">📈 TPO Market Profile</h3>
                <span class="card-icon">📊</span>
            </div>
            <div class="tpo-chart-container" style="height: 600px;">
                <img id="tpoChartImage" src="" alt="TPO Charts" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
            </div>
        </div>

        <!-- Pre-market TPO Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #007bff; color: white;">
                <h3 class="card-title" style="color: white;">🌅 Pre-Market TPO Analysis (9:05 AM - 9:15 AM)</h3>
                <button onclick="loadPremarketAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #007bff; border: none; margin-left: 10px;">
                    🔄 Refresh Analysis
                </button>
            </div>
            <div id="premarketAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load pre-market TPO analysis
                </div>
            </div>
        </div>

        <!-- Order Flow Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #17a2b8; color: white;">
                <h3 class="card-title" style="color: white;">🌊 Order Flow Analysis</h3>
                <button onclick="loadOrderFlowAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #17a2b8; border: none; margin-left: 10px;">
                    🔄 Refresh Analysis
                </button>
            </div>
            <div id="orderFlowAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load order flow analysis
                </div>
            </div>
        </div>

        <!-- Footprint Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #28a745; color: white;">
                <h3 class="card-title" style="color: white;">📊 Footprint Analysis</h3>
                <button onclick="loadFootprintAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #28a745; border: none; margin-left: 10px;">
                    🔄 Refresh Analysis
                </button>
            </div>
            <div id="footprintAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load footprint analysis
                </div>
            </div>
        </div>

        <!-- Critical Micro Levels Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #ffc107; color: #333;">
                <h3 class="card-title" style="color: #333;">🎯 Critical Micro Levels</h3>
                <button onclick="loadMicroLevels()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #333; color: #ffc107; border: none; margin-left: 10px;">
                    🔄 Refresh Levels
                </button>
            </div>
            <div id="microLevelsContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Levels" to identify critical support/resistance levels
                </div>
            </div>
        </div>

        <!-- Options Chain Scanner Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px; background-color: #6f42c1; color: white;">
                <h3 class="card-title" style="font-size: 16px; color: white;">🔍 Options Chain Scanner</h3>
                <button onclick="loadOptionsScanner()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #6f42c1; border: none; margin-left: 10px;">
                    🔄 Scan Options
                </button>
            </div>
            <div style="padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Strategy Type:</label>
                        <select id="scannerStrategyType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="covered_call">Covered Call</option>
                            <option value="cash_secured_put">Cash-Secured Put</option>
                            <option value="iron_condor">Iron Condor</option>
                            <option value="strangle">Strangle</option>
                            <option value="straddle">Straddle</option>
                            <option value="vertical_spread">Vertical Spread</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Expiry:</label>
                        <input type="date" id="scannerExpiry" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Option Type:</label>
                        <select id="scannerOptionType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="">All</option>
                            <option value="CE">Call (CE)</option>
                            <option value="PE">Put (PE)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min IV Rank:</label>
                        <input type="number" id="scannerMinIVRank" value="50" min="0" max="100" step="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Max Days to Expiry:</label>
                        <input type="number" id="scannerMaxDays" value="60" min="1" max="365" step="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Liquidity Score:</label>
                        <input type="number" id="scannerMinLiquidity" value="0.5" min="0" max="1" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Volume:</label>
                        <input type="number" id="scannerMinVolume" value="0" min="0" step="100" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min OI:</label>
                        <input type="number" id="scannerMinOI" value="0" min="0" step="1000" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Strike:</label>
                        <input type="number" id="scannerMinStrike" step="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Max Strike:</label>
                        <input type="number" id="scannerMaxStrike" step="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                </div>
            </div>
            <div id="optionsScannerContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Configure filters above and click "Scan Options" to find candidates
                </div>
            </div>
        </div>

        <!-- TPO-Based Derivatives Suggestions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">🎯 TPO-Based Derivatives Suggestions</h3>
                <span class="card-icon" style="font-size: 20px;">💡</span>
                <button onclick="loadDerivativesSuggestions()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-left: 10px;">
                    🔄 Refresh Suggestions
                </button>
            </div>
            <div id="derivativesSuggestionsContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Suggestions" to load TPO-based trading suggestions
                </div>
            </div>
        </div>

        <!-- Futures Order Flow Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">📊 Nifty 50 Futures Order Flow - latest 2 ticks (Last Trading Day)</h3>
                <span class="card-icon" style="font-size: 20px;">📈</span>
            </div>
            <div class="tpo-chart-container" style="height: 200px; overflow-y: auto;">
                <table id="futuresOrderFlowTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Time</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Side</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Quantity</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Orders</th>
                        </tr>
                    </thead>
                    <tbody id="futuresOrderFlowBody">
                        <tr>
                            <td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading order flow data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Current Positions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">📊 Active Positions</h3>
                <span class="card-icon">📈</span>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Timestamp</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Type</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Symbol</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Product</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Exchange</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Avg. Price</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading positions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        </div>
        <!-- End Live Market Tab Content -->

        <!-- Stocks Tab Content -->
        <div id="gainers-losers-tab" class="tab-content">
            <!-- Gainers and Losers Section -->
            <div style="margin-bottom: 20px;">
                <!-- Top Gainers -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="justify-content: space-between; background-color: #28a745; color: white;">
                        <h3 class="card-title" style="color: white;">📈 Top 15 Gainers (Last Trading Day)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Symbol</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Sparkline (last 30D)</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Previous Price</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Current Price</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Change %</th>
                                </tr>
                            </thead>
                            <tbody id="gainersTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Losers -->
                <div class="card">
                    <div class="card-header" style="justify-content: space-between; background-color: #dc3545; color: white;">
                        <h3 class="card-title" style="color: white;">📉 Top 15 Losers (Last Trading Day)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Symbol</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Sparkline (last 30D)</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Previous Price</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Current Price</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Change %</th>
                                </tr>
                            </thead>
                            <tbody id="losersTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Stocks Tab Content -->

        <!-- Utilities Tab Content -->
        <div id="utilities-tab" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Export Data Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="background-color: #28a745; color: white;">
                        <h3 class="card-title" style="color: white;">📤 Export Data</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Type of Data (Table Name):</label>
                            <select id="exportTableName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="">-- Select Table --</option>
                                <option value="ticks">ticks</option>
                                <option value="futures_ticks">futures_ticks</option>
                                <option value="options_ticks">options_ticks</option>
                                <option value="holdings">holdings</option>
                                <option value="mf_holdings">mf_holdings</option>
                                <option value="positions">positions</option>
                                <option value="orders">orders</option>
                                <option value="trades">trades</option>
                                <option value="market_structure">market_structure</option>
                                <option value="rt_intraday_price">rt_intraday_price</option>
                                <option value="iv_history">iv_history</option>
                                <option value="market_depth">market_depth</option>
                                <option value="futures_tick_depth">futures_tick_depth</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">From Date:</label>
                                <input type="date" id="exportFromDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">To Date:</label>
                                <input type="date" id="exportToDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Columns (Leave empty for all columns):</label>
                            <input type="text" id="exportColumns" placeholder="e.g., id,instrument_token,last_price (comma-separated)" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <small style="color: #666; font-size: 11px;">Optional: Specify columns to export, separated by commas</small>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Export Format:</label>
                            <select id="exportFormat" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel (XLSX)</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        
                        <button onclick="exportData()" class="btn" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            📥 Export Data
                        </button>
                        
                        <div id="exportStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
                
                <!-- Import Data Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="background-color: #007bff; color: white;">
                        <h3 class="card-title" style="color: white;">📥 Import Data</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Type of Data (Table Name):</label>
                            <select id="importTableName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="">-- Select Table --</option>
                                <option value="ticks">ticks</option>
                                <option value="futures_ticks">futures_ticks</option>
                                <option value="options_ticks">options_ticks</option>
                                <option value="holdings">holdings</option>
                                <option value="mf_holdings">mf_holdings</option>
                                <option value="positions">positions</option>
                                <option value="orders">orders</option>
                                <option value="trades">trades</option>
                                <option value="market_structure">market_structure</option>
                                <option value="rt_intraday_price">rt_intraday_price</option>
                                <option value="iv_history">iv_history</option>
                                <option value="market_depth">market_depth</option>
                                <option value="futures_tick_depth">futures_tick_depth</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">CSV File:</label>
                            <input type="file" id="importCsvFile" accept=".csv" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <small style="color: #666; font-size: 11px;">Select a CSV file to import. On conflict, new data will be skipped (not updated).</small>
                        </div>
                        
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; font-weight: 600; color: #856404; margin-bottom: 5px;">⚠️ Import Behavior:</div>
                            <div style="font-size: 10px; color: #856404;">
                                • On conflict (duplicate rows), new data will be <strong>skipped</strong> (not updated)<br>
                                • CSV header row must match table column names<br>
                                • Data types must match table schema
                            </div>
                        </div>
                        
                        <button onclick="importData()" class="btn" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            📤 Import Data
                        </button>
                        
                        <div id="importStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                        
                        <div id="importPreview" style="margin-top: 15px; display: none;">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Preview (first 5 rows):</div>
                            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; font-size: 11px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Refresh Stock Price Data Section -->
            <div class="card" style="margin-bottom: 20px; margin-top: 20px;">
                <div class="card-header" style="background-color: #17a2b8; color: white;">
                    <h3 class="card-title" style="color: white;">🔄 Refresh Stock Price Data</h3>
                </div>
                <div style="padding: 15px;">
                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            This will fetch the latest stock price data from Yahoo Finance and update the <code>Database</code> table. 
                            The process will automatically determine the date range based on existing data.
                        </p>
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #d1ecf1; border-radius: 4px; border-left: 3px solid #17a2b8;">
                            <div style="font-size: 11px; font-weight: 600; color: #0c5460; margin-bottom: 5px;">ℹ️ Note:</div>
                            <div style="font-size: 10px; color: #0c5460;">
                                • This process may take several minutes depending on the number of stocks<br>
                                • The system will automatically skip stocks that already have the latest data<br>
                                • Existing records will be updated if new data is available
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="refreshStockPrices()" id="refreshStockPricesBtn" class="btn" style="width: 100%; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        🔄 Refresh Stock Prices
                    </button>
                    
                    <div id="refreshStockPricesStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
        </div>
        <!-- End Utilities Tab Content -->

        <!-- Holdings Tab Content -->
        <div id="holdings-tab" class="tab-content">
        {% if show_holdings %}
        <!-- Today's P&L Summary Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">📊 P&L Summary</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadPnlSummary('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as Excel">
                        📥 Excel
                    </button>
                    <button onclick="downloadPnlSummary('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as PDF">
                        📥 PDF
                    </button>
                    <span class="card-icon">💰</span>
                </div>
            </div>
            <div style="padding: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Category</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Today's P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Overall P&L</th>
                        </tr>
                    </thead>
                    <tbody id="pnlSummaryTableBody">
                        <tr>
                            <td colspan="3" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading P&L summary...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Portfolio Value Chart Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">📈 Total Portfolio Value</h3>
                <span class="card-icon">📊</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label for="portfolioDaysSelector" style="margin-right: 10px; font-size: 12px;">Days:</label>
                    <select id="portfolioDaysSelector" onchange="loadPortfolioChart(this.value)" style="padding: 5px 10px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="7">7 Days</option>
                        <option value="30" selected>30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">180 Days</option>
                        <option value="365">1 Year</option>
                    </select>
                </div>
                <canvas id="portfolioChart" style="max-height: 400px;"></canvas>
            </div>
        </div>

        <!-- Portfolio Hedging Recommendations Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">🛡️ Portfolio Hedging Recommendations</h3>
                <span class="card-icon" style="font-size: 20px;">🔒</span>
                <button onclick="loadPortfolioHedgeAnalysis()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-left: 10px;">
                    🔄 Refresh Analysis
                </button>
                <select id="hedgeRatioSelector" onchange="loadPortfolioHedgeAnalysis()" style="padding: 5px 10px; font-size: 12px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="0.25">25% Hedge</option>
                    <option value="0.5" selected>50% Hedge</option>
                    <option value="0.75">75% Hedge</option>
                    <option value="1.0">100% Hedge</option>
                </select>
                <select id="strategyTypeSelector" onchange="loadPortfolioHedgeAnalysis()" style="padding: 5px 10px; font-size: 12px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" selected>All Strategies</option>
                    <option value="futures">Futures</option>
                    <option value="puts">Protective Puts</option>
                    <option value="calls">Covered Calls</option>
                    <option value="collars">Collars</option>
                </select>
            </div>
            <div id="portfolioHedgeContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load portfolio hedge recommendations
                </div>
            </div>
        </div>

        <!-- Current Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">💼 Current Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        📥 Excel
                    </button>
                    <button onclick="downloadHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        📥 PDF
                    </button>
                    <button onclick="addGTTForAll(5)" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" disabled>
                        + Add GTT (5% SL)
                    </button>
                    <button onclick="addGTTForAll(10)" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" disabled>
                        + Add GTT (10% SL)
                    </button>
                    <button onclick="viewAllGTTs()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #6c757d; color: white;" disabled>
                        View GTTs
                    </button>
                </div>
            </div>
            <div style="padding: 12px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="holdingsSearch" style="font-weight: 600; font-size: 13px;">Search Stock:</label>
                    <input type="text" id="holdingsSearch" placeholder="Enter stock symbol..." 
                           style="flex: 1; max-width: 300px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                           oninput="searchHoldings()" onkeypress="if(event.key === 'Enter') event.preventDefault();">
                    <button onclick="clearHoldingsSearch()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #6c757d; color: white;" title="Clear search">
                        Clear
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead id="holdingsTableHeader">
                        <tr style="background-color: #f8f9fa;">
                            <th onclick="sortHoldings('trading_symbol')" style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; cursor: pointer; user-select: none;" id="header_trading_symbol">Symbol ↕</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Sparkline (last 30D)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Qty</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Avg. Price</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">LTP</th>
                            <th onclick="sortHoldings('invested_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_invested_amount">Invested Amount ↕</th>
                            <th onclick="sortHoldings('current_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_current_amount">Current Amount ↕</th>
                            <th onclick="sortHoldings('pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_pnl">Total P&L ↕</th>
                            <th onclick="sortHoldings('today_pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none;" id="header_today_pnl">Today's P&L ↕</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Existing GTT</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Set New GTT</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTableBody">
                        {% for holding in holdings_info.holdings %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <strong>{{ holding.trading_symbol }}</strong>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                <canvas id="sparkline-{{ holding.trading_symbol }}" width="120" height="40" onclick="showCandlestick('{{ holding.trading_symbol }}')" style="cursor: pointer;"></canvas>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {{ holding.quantity }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ₹{{ "%.2f"|format(holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ₹{{ "%.2f"|format(holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ₹{{ "%.2f"|format(holding.quantity * holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                ₹{{ "%.2f"|format(holding.quantity * holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {% if holding.pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold;">₹{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 10px; color: #28a745;">{{ "+%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold;">₹{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 10px; color: #dc3545;">{{ "%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                {%- if holding.today_pnl is defined -%}
                                    {% set today_pnl = holding.today_pnl %}
                                {%- else -%}
                                    {% set today_pnl = 0 %}
                                {%- endif -%}
                                {%- if holding.pct_change is defined -%}
                                    {% set pct_change = holding.pct_change %}
                                {%- else -%}
                                    {% set pct_change = 0 %}
                                {%- endif -%}
                                {% if today_pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold;">₹{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 10px; color: #28a745;">{{ "+%.2f"|format(pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold;">₹{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 10px; color: #dc3545;">{{ "%.2f"|format(pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">
                                {% if holding.existing_gtt %}
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: #28a745; font-weight: bold;">✓ Active</span>
                                    <span style="color: #666;">₹{{ "%.2f"|format(holding.existing_gtt.trigger_price) }}</span>
                                    <button onclick="cancelGTT({{ holding.existing_gtt.trigger_id }}, '{{ holding.trading_symbol }}')" 
                                            class="btn" style="padding: 2px 6px; font-size: 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        Cancel
                                    </button>
                                </div>
                                {% else %}
                                <span style="color: #999;">No GTT</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                <form onsubmit="setGTT(event, '{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})" style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                    <input type="number" id="trigger_price_{{ holding.instrument_token }}" step="0.05" placeholder="Price" 
                                           style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" required>
                                    <button type="submit" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Set</button>
                                </form>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="buyMore('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}')">
                                        Buy More
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="sellSome('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell Some
                                    </button>
                                    <button class="btn" style="padding: 4px 8px; font-size: 11px; background-color: #dc3545; color: white;" onclick="sellAll('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell All
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            {% set total_pages = (holdings_info.total_count / holdings_info.per_page) | round(0, 'ceil') | int %}
            <div id="holdingsPagination" style="display: flex; justify-content: center; align-items: center; padding: 20px; border-top: 1px solid #eee;">
                {% if total_pages > 1 %}
                    {% if holdings_info.page > 1 %}
                    <button onclick="loadHoldingsPage({{ holdings_info.page - 1 }})" 
                       style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">&laquo; Previous</button>
                    {% else %}
                    <span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">&laquo; Previous</span>
                    {% endif %}
                    <span style="margin: 0 10px; font-weight: 600;">Page {{ holdings_info.page }} of {{ total_pages }}</span>
                    {% if holdings_info.page < total_pages %}
                    <button onclick="loadHoldingsPage({{ holdings_info.page + 1 }})" 
                       style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Next &raquo;</button>
                    {% else %}
                    <span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">Next &raquo;</span>
                    {% endif %}
                {% else %}
                    <span style="margin: 0 10px; font-weight: 600;">Page 1 of 1</span>
                {% endif %}
            </div>
        </div>

        <!-- Mutual Fund Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">📊 Mutual Fund Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadMFHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        📥 Excel
                    </button>
                    <button onclick="downloadMFHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        📥 PDF
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">MF Name</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Invested Amount</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Current Value</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Net Change %</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Day Change %</th>
                        </tr>
                    </thead>
                    <tbody id="mfHoldingsTableBody">
                        <tr>
                            <td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading MF holdings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>  <!-- Close container div -->

    <!-- Load TPO chart renderer -->
    <script src="/static/tpo-charts.js"></script>
    
    <script>
        // IST market-hours helpers
        function getISTNow() {
            try {
                const fmt = new Intl.DateTimeFormat('en-GB', {
                    timeZone: 'Asia/Kolkata',
                    hour12: false,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
                const parts = fmt.formatToParts(new Date());
                const get = k => parts.find(p => p.type === k).value;
                return {
                    year: parseInt(get('year'), 10),
                    month: parseInt(get('month'), 10),
                    day: parseInt(get('day'), 10),
                    hour: parseInt(get('hour'), 10),
                    minute: parseInt(get('minute'), 10)
                };
            } catch (e) {
                const d = new Date();
                return { year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate(), hour: d.getHours(), minute: d.getMinutes() };
            }
        }

        function isWeekendIST() {
            try {
                const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Kolkata', weekday: 'short' });
                const wd = fmt.format(new Date());
                return wd === 'Sat' || wd === 'Sun';
            } catch (e) {
                const d = new Date();
                const wd = d.getDay();
                return wd === 0 || wd === 6;
            }
        }

        function isMarketClosedIST() {
            if (isWeekendIST()) return true;
            const t = getISTNow();
            if (t.hour > 15) return true;
            if (t.hour === 15 && t.minute >= 30) return true;
            return false;
        }
        // Global variables for market bias analysis
        let currentAnalysisDate = null;
        let marketBiasData = null;
        let refreshInterval = 30000; // Default 10 seconds
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = 10;
        
        // Initialize refresh system
        function initializeRefreshSystem() {
            // Check if countdown elements exist before initializing
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, delaying refresh system initialization');
                // Retry after a short delay
                setTimeout(initializeRefreshSystem, 100);
                return;
            }
            
            // Start the refresh timer
            startRefreshTimer();
            
            // Start countdown display
            startCountdown();
        }
        
        // Start refresh timer
        function startRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            if (refreshInterval > 0) {
                refreshTimer = setInterval(function() {
                    refreshDashboardData();
                }, refreshInterval);
            }
        }
        
        // Start countdown display
        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
                
                countdownTimer = setInterval(function() {
                    countdownValue--;
                    updateCountdownDisplay();
                    
                    if (countdownValue <= 0) {
                        countdownValue = Math.floor(refreshInterval / 1000);
                    }
                }, 1000);
            } else {
                updateCountdownDisplay();
            }
        }
        
        // Update countdown display
        function updateCountdownDisplay() {
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            // Check if elements exist before trying to update them
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, skipping update');
                return;
            }
            
            if (refreshInterval === 0) {
                countdownElement.textContent = 'Manual';
                refreshStatusElement.textContent = 'Auto refresh disabled';
            } else {
                countdownElement.textContent = countdownValue;
                refreshStatusElement.textContent = `Next refresh in: ${countdownValue}s`;
            }
        }
        
        // Refresh dashboard data
        function refreshDashboardData() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    // Update status indicators
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                });
            
            // Update margin data
            if (window.tpoChartRenderer && !isMarketClosedIST()) {
                window.tpoChartRenderer.loadMarginData();
            }
            
            // Refresh futures data
            fetch('/api/refresh_futures', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Futures data refreshed: ${data.fetched_count}/${data.total_symbols} symbols`);
                    } else {
                        console.error('Error refreshing futures data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error refreshing futures data:', error);
                });
            
            // Update market bias analysis and futures order flow
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            
            // Note: Derivatives suggestions refresh separately every minute (see below)
            
            // Only update holdings if enabled
            {% if show_holdings %}
            // Refresh holdings table with current page
            if (!isMarketClosedIST() && typeof currentHoldingsPage !== 'undefined') {
                loadHoldingsPage(currentHoldingsPage);
            }
            
            // Update MF holdings
            if (!isMarketClosedIST()) {
                loadMFHoldings();
            }
            
            // Update P&L Summary
            if (!isMarketClosedIST()) {
                loadPnlSummary();
            }
            
            // Update Portfolio Chart
            const daysSelector = document.getElementById('portfolioDaysSelector');
            if (daysSelector && !isMarketClosedIST()) {
                loadPortfolioChart(daysSelector.value || 30);
            }
            {% endif %}
        }

        function updateStatusIndicators(data) {
            // Update token status
            const tokenIndicator = document.querySelector('.status-item:nth-child(1) .status-indicator');
            tokenIndicator.className = `status-indicator ${data.token_valid ? 'status-online' : 'status-offline'}`;
            
            // Update tick status
            const tickIndicator = document.querySelector('.status-item:nth-child(2) .status-indicator');
            tickIndicator.className = `status-indicator ${data.tick_active ? 'status-online' : 'status-offline'}`;

            // Update Last Update text
            const lastUpdateEl = document.getElementById('lastUpdateText');
            if (lastUpdateEl && data.last_update) {
                lastUpdateEl.textContent = `Last Update: ${data.last_update}`;
            }

            // Update total ticks
            const totalTicksEl = document.getElementById('totalTicksText');
            if (totalTicksEl && typeof data.total_ticks !== 'undefined') {
                totalTicksEl.textContent = `Total Ticks today: ${data.total_ticks}`;
            }
        }
        
        // Load market bias analysis
        function loadMarketBiasAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || null;
            
            // Load market bias data
            fetch(`/api/market_bias${analysisDate ? '?analysis_date=' + analysisDate : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading market bias:', data.error);
                        return;
                    }
                    
                    marketBiasData = data.analysis;
                    updateMarketBiasDisplay();
                })
                .catch(error => {
                    console.error('Error fetching market bias:', error);
                });
        }
        
        // Load futures order flow data
        function loadFuturesOrderFlow() {
            fetch('/api/futures_order_flow')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading futures order flow:', data.error);
                        updateFuturesOrderFlowDisplay([]);
                        return;
                    }
                    
                    updateFuturesOrderFlowDisplay(data.order_flow);
                })
                .catch(error => {
                    console.error('Error fetching futures order flow:', error);
                    updateFuturesOrderFlowDisplay([]);
                });
        }
        
        // Update futures order flow display
        function updateFuturesOrderFlowDisplay(orderFlowData) {
            const tbody = document.getElementById('futuresOrderFlowBody');
            const titleElement = document.querySelector('#futuresOrderFlowTable').closest('.card').querySelector('.card-title');
            
            if (!orderFlowData || orderFlowData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No order flow data available for last trading day</td></tr>';
                // Reset title to default
                titleElement.textContent = '📊 Nifty 50 Futures Order Flow (Last Trading Day)';
                return;
            }
            
            let html = '';
            let tradingDate = '';
            
            // Get trading date from first order
            if (orderFlowData.length > 0 && orderFlowData[0].run_date) {
                tradingDate = orderFlowData[0].run_date;
                // Update the title with trading date
                titleElement.textContent = `📊 Nifty 50 Futures Order Flow (Last Trading Day - ${tradingDate})`;
            }
            
            orderFlowData.forEach((order, index) => {
                const sideClass = order.side === 'buy' ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                const sideText = order.side === 'buy' ? 'BUY' : 'SELL';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd; font-size: 12px;">${order.timestamp}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; ${sideClass}; font-size: 12px;">${sideText}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.quantity.toLocaleString()}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.orders}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Load pre-market analysis
        function loadPremarketAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/premarket_analysis';
            if (analysisDate) {
                url += `?analysis_date=${analysisDate}`;
            }
            
            document.getElementById('premarketAnalysisContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">Loading pre-market analysis...</div>';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        console.error('Error loading pre-market analysis:', data.error || 'Unknown error');
                        let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                            <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">⚠️ Missing Data</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                        `;
                        if (data.missing_data && data.missing_data.length > 0) {
                            data.missing_data.forEach(item => {
                                html += `<li style="margin-bottom: 3px;">${item}</li>`;
                            });
                        } else {
                            html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                        }
                        html += `</ul></div>`;
                        document.getElementById('premarketAnalysisContainer').innerHTML = html;
                        return;
                    }
                    
                    updatePremarketAnalysisDisplay(data);
                })
                .catch(error => {
                    console.error('Error fetching pre-market analysis:', error);
                    document.getElementById('premarketAnalysisContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading pre-market analysis</div>';
                });
        }
        
        // Update pre-market analysis display
        function updatePremarketAnalysisDisplay(data) {
            const container = document.getElementById('premarketAnalysisContainer');
            
            if (!data.success || !data.premarket_tpo) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No pre-market data available</div>';
                return;
            }
            
            const pm = data.premarket_tpo || {};
            const prior = data.prior_day_structure || {};
            const overnight = data.overnight_data || {};
            const gap = data.gap_analysis || {};
            const zones = data.key_zones || {};
            const bias = data.market_bias || {};
            const context = data.directional_context || {};
            const auction = data.auction_structure || {};
            
            let html = '';
            
            // Summary Section
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Opening Bias</div>
                        <div style="font-size: 20px; font-weight: bold;">${context.opening_bias || 'Neutral'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Gap Type</div>
                        <div style="font-size: 18px; font-weight: bold;">${gap.gap_type || 'No Gap'}</div>
                        ${gap.gap_size ? `<div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">${gap.gap_size.toFixed(2)} (${gap.gap_percentage.toFixed(2)}%)</div>` : ''}
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Market Bias</div>
                        <div style="font-size: 18px; font-weight: bold;">${bias.bias_direction || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">${bias.bias_strength || 'Weak'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Inventory Position</div>
                        <div style="font-size: 16px; font-weight: bold;">${gap.inventory_position || 'Neutral'}</div>
                    </div>
                </div>
            `;
            
            // Pre-market TPO Metrics
            html += `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">📊 Pre-Market TPO Metrics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #dc3545;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">POC</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.poc ? pm.poc.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VAH</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.value_area_high ? pm.value_area_high.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #dc3545;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VAL</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.value_area_low ? pm.value_area_low.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">IBH</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.initial_balance_high ? pm.initial_balance_high.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">IBL</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.initial_balance_low ? pm.initial_balance_low.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #6c757d;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VA Range</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.session_range ? pm.session_range.toFixed(2) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Prior Day Comparison
            if (prior.poc || prior.vah || prior.val) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">📅 Prior Day Comparison</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${prior.poc ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior POC</div><div style="font-size: 14px; font-weight: bold;">${prior.poc.toFixed(2)}</div></div>` : ''}
                            ${prior.vah ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior VAH</div><div style="font-size: 14px; font-weight: bold;">${prior.vah.toFixed(2)}</div></div>` : ''}
                            ${prior.val ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior VAL</div><div style="font-size: 14px; font-weight: bold;">${prior.val.toFixed(2)}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Overnight Data
            if (overnight.overnight_high || overnight.overnight_low) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">🌙 Overnight Data</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${overnight.overnight_high ? `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;"><div style="font-size: 11px; color: #666;">Overnight High</div><div style="font-size: 14px; font-weight: bold;">${overnight.overnight_high.toFixed(2)}</div></div>` : ''}
                            ${overnight.overnight_low ? `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;"><div style="font-size: 11px; color: #666;">Overnight Low</div><div style="font-size: 14px; font-weight: bold;">${overnight.overnight_low.toFixed(2)}</div></div>` : ''}
                            ${gap.gap_description ? `<div style="background: #d1ecf1; padding: 10px; border-radius: 5px; grid-column: 1/-1;"><div style="font-size: 11px; color: #666;">Gap Analysis</div><div style="font-size: 12px; font-weight: bold; margin-top: 5px;">${gap.gap_description}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Key Zones (Support/Resistance)
            if ((zones.support_levels && zones.support_levels.length > 0) || 
                (zones.resistance_levels && zones.resistance_levels.length > 0) ||
                (zones.pivot_levels && zones.pivot_levels.length > 0)) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">🎯 Key Zones (Support/Resistance)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Support Levels</div>
                                ${zones.support_levels && zones.support_levels.length > 0 ? 
                                    zones.support_levels.map(level => `
                                        <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                            <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Resistance Levels</div>
                                ${zones.resistance_levels && zones.resistance_levels.length > 0 ? 
                                    zones.resistance_levels.map(level => `
                                        <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                            <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #007bff; margin-bottom: 8px;">Pivot Levels</div>
                                ${zones.pivot_levels && zones.pivot_levels.length > 0 ? 
                                    zones.pivot_levels.map(level => `
                                        <div style="background: #d1ecf1; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #007bff;">
                                            <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Opening Expectations & Risk Factors
            if ((context.opening_expectations && context.opening_expectations.length > 0) ||
                (context.risk_factors && context.risk_factors.length > 0) ||
                (context.key_levels_to_watch && context.key_levels_to_watch.length > 0)) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">📋 Directional Context</h4>
                        ${context.opening_expectations && context.opening_expectations.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Opening Expectations:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                    ${context.opening_expectations.map(exp => `<li style="margin-bottom: 3px;">${exp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${context.risk_factors && context.risk_factors.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 5px;">Risk Factors:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #dc3545;">
                                    ${context.risk_factors.map(risk => `<li style="margin-bottom: 3px;">${risk}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${context.key_levels_to_watch && context.key_levels_to_watch.length > 0 ? `
                            <div>
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Key Levels to Watch:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                    ${context.key_levels_to_watch.map(level => `
                                        <li style="margin-bottom: 3px;">
                                            <strong>₹${level.level.toFixed(2)}</strong> (${level.type}) - ${level.significance}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Auction Structure
            if (auction.poc_strength || auction.balance_quality) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">⚖️ Auction Structure Basis</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${auction.value_area_range ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">VA Range</div><div style="font-size: 14px; font-weight: bold;">${auction.value_area_range.toFixed(2)}</div></div>` : ''}
                            ${auction.poc_strength ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">POC Strength</div><div style="font-size: 14px; font-weight: bold;">${auction.poc_strength}</div></div>` : ''}
                            ${auction.balance_quality ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Balance Quality</div><div style="font-size: 14px; font-weight: bold;">${auction.balance_quality}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Update market bias display
        function updateMarketBiasDisplay() {
            if (!marketBiasData) return;
            
            const comprehensiveBias = marketBiasData.comprehensive_bias;
            const recommendations = marketBiasData.trading_recommendations;
            
            // Update bias metrics
            document.getElementById('biasScore').textContent = comprehensiveBias.bias_score.toFixed(1);
            document.getElementById('biasDirection').textContent = comprehensiveBias.bias_direction;
            document.getElementById('biasStrength').textContent = comprehensiveBias.bias_strength;
            document.getElementById('riskLevel').textContent = recommendations.risk_level;
            
            // Color code the bias direction
            const biasDirectionElement = document.getElementById('biasDirection');
            biasDirectionElement.className = 'metric-value';
            if (comprehensiveBias.bias_direction === 'Bullish') {
                biasDirectionElement.style.color = '#28a745';
            } else if (comprehensiveBias.bias_direction === 'Bearish') {
                biasDirectionElement.style.color = '#dc3545';
            } else {
                biasDirectionElement.style.color = '#6c757d';
            }
            
            // Color code the bias strength
            const biasStrengthElement = document.getElementById('biasStrength');
            biasStrengthElement.className = 'metric-value';
            if (comprehensiveBias.bias_strength === 'Strong') {
                biasStrengthElement.style.color = '#dc3545';
            } else if (comprehensiveBias.bias_strength === 'Moderate') {
                biasStrengthElement.style.color = '#ffc107';
            } else {
                biasStrengthElement.style.color = '#6c757d';
            }
        }
        
        
        // Event listeners for analysis date changes
        document.getElementById('analysisDate').addEventListener('change', function() {
            try {
                loadMarketBiasAnalysis();
            } catch (error) {
                console.error('Error in analysis date change:', error);
            }
        });
        
        // Event listener for refresh interval changes
        document.getElementById('refreshInterval').addEventListener('change', function() {
            refreshInterval = parseInt(this.value);
            initializeRefreshSystem();
        });
        
        // Event listener for manual refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            refreshDashboardData();
            // Reset countdown
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
            }
        });
        
        document.getElementById('backtestBtn').addEventListener('click', function() {
            const analysisDate = document.getElementById('analysisDate').value;
            if (!analysisDate) {
                alert('Please select a date for backtesting');
                return;
            }
            
            // Update analysis date via API
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `date=${analysisDate}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'BACKTEST MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-backtest';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
            })
            .catch(error => {
                console.error('Error setting analysis date:', error);
            });
        });
        
        document.getElementById('liveBtn').addEventListener('click', function() {
            // Switch to live mode
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'date=live'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'LIVE MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-live';
                document.getElementById('analysisDate').value = '';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
            })
            .catch(error => {
                console.error('Error switching to live mode:', error);
            });
        });
        
        // Global variable for sort settings
        let sortColumn = 'trading_symbol';
        let sortDirection = 'asc';
        let currentHoldingsPage = {% if holdings_info %}{{ holdings_info.page }}{% else %}1{% endif %};
        let holdingsSearchTerm = '';
        
        // Search holdings function
        function searchHoldings() {
            const searchInput = document.getElementById('holdingsSearch');
            holdingsSearchTerm = searchInput ? searchInput.value.trim() : '';
            // Reset to first page when searching
            currentHoldingsPage = 1;
            loadHoldingsPage(1);
        }
        
        // Clear search function
        function clearHoldingsSearch() {
            const searchInput = document.getElementById('holdingsSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            holdingsSearchTerm = '';
            // Reset to first page when clearing
            currentHoldingsPage = 1;
            loadHoldingsPage(1);
        }
        
        // Sort holdings function
        function sortHoldings(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header indicators
            updateSortIndicators();
            
            // Reload first page with new sort
            loadHoldingsPage(1);
        }
        
        // Update sort indicators in table headers
        function updateSortIndicators() {
            const headers = ['header_trading_symbol', 'header_invested_amount', 'header_current_amount', 'header_pnl', 'header_today_pnl'];
            const labelMap = {
                'header_trading_symbol': 'Symbol',
                'header_invested_amount': 'Invested Amount',
                'header_current_amount': 'Current Amount',
                'header_pnl': 'Total P&L',
                'header_today_pnl': 'Today\'s P&L'
            };
            
            headers.forEach(headerId => {
                const header = document.getElementById(headerId);
                if (header) {
                    const column = headerId.replace('header_', '');
                    if (sortColumn === column) {
                        header.innerHTML = `${labelMap[headerId]} ${sortDirection === 'asc' ? '↑' : '↓'}`;
                    } else {
                        header.innerHTML = `${labelMap[headerId]} ↕`;
                    }
                }
            });
        }
        
        // Load holdings page via AJAX
        function loadHoldingsPage(page) {
            // Ensure sortColumn and sortDirection are defined
            const sortBy = sortColumn || 'trading_symbol';
            const sortDir = sortDirection || 'asc';
            // Build URL with search parameter
            let url = `/api/holdings?page=${page}&per_page=10&sort_by=${sortBy}&sort_dir=${sortDir}`;
            if (holdingsSearchTerm) {
                url += `&search=${encodeURIComponent(holdingsSearchTerm)}`;
            }
            // Pass sort parameters to API for server-side sorting
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading holdings:', data.error);
                        return;
                    }
                    
                    // Update table body (data is already sorted by server)
                    const tbody = document.getElementById('holdingsTableBody');
                    tbody.innerHTML = '';
                    
                    data.holdings.forEach(holding => {
                        const pnlClass = holding.pnl >= 0 ? '28a745' : 'dc3545';
                        const pnlColor = holding.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd;">
                                    <strong>${holding.trading_symbol}</strong>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-ajax-${holding.trading_symbol}" width="120" height="40" onclick="showCandlestick('${holding.trading_symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ${holding.quantity}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ₹${holding.average_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ₹${holding.last_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ₹${holding.invested_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    ₹${holding.current_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <div style="${pnlColor}">₹${holding.pnl.toFixed(2)}</div>
                                    <div style="font-size: 10px; ${holding.pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pnl_pct_change >= 0 ? '+' : ''}${holding.pnl_pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <div style="${holding.today_pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;'}">₹${holding.today_pnl.toFixed(2)}</div>
                                    <div style="font-size: 10px; ${holding.today_pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pct_change >= 0 ? '+' : ''}${holding.pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">
                                    ${holding.existing_gtt ? `
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <span style="color: #28a745; font-weight: bold;">✓ Active</span>
                                        <span style="color: #666;">₹${holding.existing_gtt.trigger_price.toFixed(2)}</span>
                                        <button onclick="cancelGTT(${holding.existing_gtt.trigger_id}, '${holding.trading_symbol}')" 
                                                class="btn" style="padding: 2px 6px; font-size: 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                            Cancel
                                        </button>
                                    </div>
                                    ` : `
                                    <span style="color: #999;">No GTT</span>
                                    `}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                    <form onsubmit="setGTT(event, '${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})" style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                        <input type="number" id="trigger_price_ajax_${holding.instrument_token}" step="0.05" placeholder="Price" 
                                               style="width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" required>
                                        <button type="submit" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Set</button>
                                    </form>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                        <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="buyMore('${holding.instrument_token}', '${holding.trading_symbol}')">
                                            Buy More
                                        </button>
                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="sellSome('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell Some
                                        </button>
                                        <button class="btn" style="padding: 4px 8px; font-size: 11px; background-color: #dc3545; color: white;" onclick="sellAll('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell All
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Update current page tracker
                    currentHoldingsPage = data.page;
                    
                    // Update pagination controls
                    const total_pages = Math.ceil(data.total_count / data.per_page);
                    const paginationDiv = document.getElementById('holdingsPagination');
                    paginationDiv.innerHTML = '';
                    
                    if (data.page > 1) {
                        paginationDiv.innerHTML += `<button onclick="loadHoldingsPage(${data.page - 1})" 
                            style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">&laquo; Previous</button>`;
                    } else {
                        paginationDiv.innerHTML += `<span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">&laquo; Previous</span>`;
                    }
                    
                    paginationDiv.innerHTML += `<span style="margin: 0 10px; font-weight: 600;">Page ${data.page} of ${total_pages}</span>`;
                    
                    if (data.page < total_pages) {
                        paginationDiv.innerHTML += `<button onclick="loadHoldingsPage(${data.page + 1})" 
                            style="padding: 8px 16px; margin: 0 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Next &raquo;</button>`;
                    } else {
                        paginationDiv.innerHTML += `<span style="padding: 8px 16px; margin: 0 5px; background-color: #999; color: white; border-radius: 5px; cursor: not-allowed;">Next &raquo;</span>`;
                    }
                    
                    // Load sparklines for the displayed holdings
                    data.holdings.forEach(holding => {
                        loadSparkline(holding.trading_symbol);
                    });
                })
                .catch(error => {
                    console.error('Error fetching holdings:', error);
                });
        }
        
        // Load gainers and losers data
        function loadGainersLosers() {
            // Load gainers
            fetch('/api/gainers')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading gainers:', data.error);
                        document.getElementById('gainersTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading gainers</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('gainersTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.gainers || data.gainers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No gainers data available</td></tr>';
                        return;
                    }
                    
                    const symbols = [];
                    data.gainers.forEach((gainer, index) => {
                        const symbol = gainer.scrip_id || '-';
                        symbols.push(symbol);
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666;">${index + 1}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-gainer-${symbol}" width="120" height="40" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">₹${gainer.previous_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 11px;">₹${gainer.current_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #28a745; font-size: 12px;">
                                    +${gainer.gain.toFixed(2)}%
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Load sparklines for gainers after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            if (symbol && symbol !== '-') {
                                loadSparkline(`gainer-${symbol}`);
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching gainers:', error);
                    document.getElementById('gainersTableBody').innerHTML = 
                        '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading gainers</td></tr>';
                });
            
            // Load losers
            fetch('/api/losers')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading losers:', data.error);
                        document.getElementById('losersTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading losers</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('losersTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.losers || data.losers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No losers data available</td></tr>';
                        return;
                    }
                    
                    const symbols = [];
                    data.losers.forEach((loser, index) => {
                        const symbol = loser.scrip_id || '-';
                        symbols.push(symbol);
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666;">${index + 1}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-loser-${symbol}" width="120" height="40" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">₹${loser.previous_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 11px;">₹${loser.current_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #dc3545; font-size: 12px;">
                                    ${loser.gain.toFixed(2)}%
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Load sparklines for losers after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            if (symbol && symbol !== '-') {
                                loadSparkline(`loser-${symbol}`);
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching losers:', error);
                    document.getElementById('losersTableBody').innerHTML = 
                        '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading losers</td></tr>';
                });
        }
        
        // GTT management functions
        // Download functions
        function downloadHoldings(format) {
            const url = format === 'excel' ? '/api/download/holdings/excel' : '/api/download/holdings/pdf';
            window.location.href = url;
        }
        
        function downloadMFHoldings(format) {
            const url = format === 'excel' ? '/api/download/mf/excel' : '/api/download/mf/pdf';
            window.location.href = url;
        }
        
        function downloadPnlSummary(format) {
            const url = format === 'excel' ? '/api/download/pnl_summary/excel' : '/api/download/pnl_summary/pdf';
            window.location.href = url;
        }
        
        async function addGTTForAll(stopLossPercent) {
            // Show custom confirmation dialog
            const confirmationText = prompt(
                `⚠️ WARNING: This will add GTT orders with ${stopLossPercent}% stop-loss for ALL holdings.\n\n` +
                `This action will affect all your current holdings. Please type "I UNDERSTAND" to continue:`
            );
            
            if (confirmationText !== "I UNDERSTAND") {
                if (confirmationText !== null) {  // User clicked Cancel or typed something else
                    alert('Operation cancelled. You must type "I UNDERSTAND" exactly to proceed.');
                }
                return;
            }
            
            try {
                const response = await fetch(`/api/add_gtt_for_all?stop_loss_percentage=${stopLossPercent}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully added ${data.results.success.length} GTTs\nFailed: ${data.results.failed.length}\nSkipped: ${data.results.skipped.length}`);
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding GTT for all:', error);
                alert('Error adding GTTs. Please try again.');
            }
        }
        
        async function viewAllGTTs() {
            try {
                const response = await fetch('/api/get_all_gtts');
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                if (data.gtts && data.gtts.length > 0) {
                    let message = `Active GTT Orders (${data.gtts.length}):\n\n`;
                    data.gtts.forEach((gtt, index) => {
                        message += `${index + 1}. ${gtt.tradingsymbol || 'N/A'} - Trigger ID: ${gtt.trigger_id || gtt.id}\n`;
                    });
                    alert(message);
                } else {
                    alert('No active GTT orders found.');
                }
            } catch (error) {
                console.error('Error fetching GTTs:', error);
                alert('Error fetching GTTs. Please try again.');
            }
        }
        
        async function cancelGTT(triggerId, tradingSymbol) {
            if (!confirm(`Cancel GTT for ${tradingSymbol}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cancel_gtt/${triggerId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT cancelled successfully for ${tradingSymbol}`);
                    // Reload holdings to update GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to cancel GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling GTT:', error);
                alert('Error cancelling GTT. Please try again.');
            }
        }
        
        async function setGTT(event, instrumentToken, tradingSymbol, quantity) {
            event.preventDefault();
            const triggerInput = event.target.querySelector(`#trigger_price_${instrumentToken}`);
            const triggerPrice = triggerInput.value;
            
            if (!triggerPrice) {
                alert('Please enter a trigger price');
                return;
            }
            
            try {
                const response = await fetch('/api/set_gtt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        instrument_token: instrumentToken,
                        tradingsymbol: tradingSymbol,
                        quantity: quantity,
                        trigger_price: parseFloat(triggerPrice)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT set successfully for ${tradingSymbol}!\nTrigger ID: ${data.trigger_id}`);
                    triggerInput.value = '';
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to set GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error setting GTT:', error);
                alert('Error setting GTT. Please try again.');
            }
        }
        
        // Holdings action functions
        function buyMore(instrumentToken, tradingSymbol) {
            const quantity = prompt(`Enter quantity to buy for ${tradingSymbol}:`);
            if (quantity && quantity > 0) {
                // TODO: Implement buy order API call
                alert(`Buy order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Buy order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/buy_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
         
        function sellSome(instrumentToken, tradingSymbol, currentQuantity) {
            const quantity = prompt(`Enter quantity to sell for ${tradingSymbol} (max: ${currentQuantity}):`);
            if (quantity && quantity > 0 && quantity <= currentQuantity) {
                // TODO: Implement sell order API call
                alert(`Sell order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            } else if (quantity > currentQuantity) {
                alert('Quantity cannot exceed current holding');
            }
        }
        
        function sellAll(instrumentToken, tradingSymbol, quantity) {
            if (confirm(`Are you sure you want to sell all ${quantity} shares of ${tradingSymbol}?`)) {
                // TODO: Implement sell all API call
                alert(`Sell all order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell all order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_all', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
        
        // Load positions data
        function loadPositions() {
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading positions:', data.error);
                        document.getElementById('positionsTableBody').innerHTML = 
                            '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('positionsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.positions || data.positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No active positions</td></tr>';
                        return;
                    }
                    
                    data.positions.forEach(position => {
                        const pnlColor = position.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        const typeColor = position.position_type === 'LONG' ? '#28a745' : position.position_type === 'SHORT' ? '#dc3545' : '#6c757d';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.fetch_timestamp || ''}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; color: ${typeColor};">${position.position_type || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; font-size: 11px;">${position.trading_symbol || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.product || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.exchange || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">₹${position.average_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">
                                    <span style="${pnlColor}">₹${position.pnl.toFixed(2)}</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching positions:', error);
                    document.getElementById('positionsTableBody').innerHTML = 
                        '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                });
        }
        
        // Helper function to format numbers in Indian locale (lakhs/crores)
        function formatIndianNumber(num) {
            // Round to nearest integer
            const rounded = Math.round(num);
            
            // Format with Indian locale commas
            return rounded.toLocaleString('en-IN');
        }
        
        // Load Derivatives Suggestions
        // Load Options Scanner
        function loadOptionsScanner() {
            const container = document.getElementById('optionsScannerContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Scanning options chain...</div>';
            
            // Get filter values
            const strategyType = document.getElementById('scannerStrategyType').value;
            const expiry = document.getElementById('scannerExpiry').value;
            const optionType = document.getElementById('scannerOptionType').value;
            const minIVRank = parseFloat(document.getElementById('scannerMinIVRank').value) || 50;
            const maxDays = parseInt(document.getElementById('scannerMaxDays').value) || 60;
            const minLiquidity = parseFloat(document.getElementById('scannerMinLiquidity').value) || 0.5;
            const minVolume = parseInt(document.getElementById('scannerMinVolume').value) || 0;
            const minOI = parseInt(document.getElementById('scannerMinOI').value) || 0;
            const minStrike = document.getElementById('scannerMinStrike').value ? parseFloat(document.getElementById('scannerMinStrike').value) : null;
            const maxStrike = document.getElementById('scannerMaxStrike').value ? parseFloat(document.getElementById('scannerMaxStrike').value) : null;
            
            // Build query string
            let url = `/api/options_scanner?strategy_type=${encodeURIComponent(strategyType)}`;
            url += `&min_iv_rank=${minIVRank}&max_iv_rank=100`;
            url += `&max_days_to_expiry=${maxDays}&min_days_to_expiry=7`;
            url += `&min_liquidity_score=${minLiquidity}`;
            url += `&min_volume=${minVolume}&min_oi=${minOI}`;
            
            if (expiry) url += `&expiry=${encodeURIComponent(expiry)}`;
            if (optionType) url += `&option_type=${encodeURIComponent(optionType)}`;
            if (minStrike !== null && maxStrike !== null) {
                url += `&strike_range_min=${minStrike}&strike_range_max=${maxStrike}`;
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Options scanner response:', data); // Debug log
                    
                    if (data.error || !data.success) {
                        console.error('Error loading options scanner:', data.error || 'Unknown error');
                        container.innerHTML = 
                            `<div style="text-align: center; padding: 20px; color: #dc3545;">
                                <strong>Error:</strong> ${data.error || 'No data available'}<br>
                                <small>Check console for details</small>
                            </div>`;
                        return;
                    }
                    
                    if (!data.candidates || data.candidates.length === 0) {
                        console.log('No candidates returned from scanner');
                        container.innerHTML = 
                            `<div style="text-align: center; padding: 20px; color: #666;">
                                No options found matching the criteria.<br>
                                <small>Try adjusting filters (e.g., lower IV Rank threshold, increase max days to expiry)</small>
                            </div>`;
                        return;
                    }
                    
                    displayOptionsScannerResults(data);
                })
                .catch(error => {
                    console.error('Error fetching options scanner:', error);
                    container.innerHTML = 
                        `<div style="text-align: center; padding: 20px; color: #dc3545;">
                            <strong>Error loading options scanner</strong><br>
                            <small>${error.message || 'Unknown error'}</small><br>
                            Check browser console for details.
                        </div>`;
                });
        }
        
        // Display Options Scanner Results
        function displayOptionsScannerResults(data) {
            console.log('Displaying scanner results:', data); // Debug log
            const container = document.getElementById('optionsScannerContainer');
            const candidates = data.candidates || [];
            
            if (!candidates || candidates.length === 0) {
                container.innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #666;">No candidates found matching the criteria</div>';
                return;
            }
            
            console.log(`Found ${candidates.length} candidates to display`);
            
            // Limit to top 5 candidates
            const top5Candidates = candidates.slice(0, 5);
            const totalFound = candidates.length;
            const displayCount = top5Candidates.length;
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 5px;">
                    <strong>Top ${displayCount} Options</strong> (showing latest ${displayCount} out of ${totalFound} total candidates) sorted by overall score
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background-color: #6f42c1; color: white;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Symbol</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Type</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Strike</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">IV (%)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">IV Rank</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Delta</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Gamma</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Theta</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Vega</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Rho</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Liquidity</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Score</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Days</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Moneyness</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            top5Candidates.forEach((candidate, index) => {
                const ivRank = candidate.iv_rank !== null ? candidate.iv_rank.toFixed(1) : 'N/A';
                const ivRankColor = candidate.iv_rank !== null ? 
                    (candidate.iv_rank >= 70 ? '#28a745' : candidate.iv_rank >= 50 ? '#ffc107' : '#dc3545') : '#6c757d';
                const scoreColor = candidate.overall_score >= 80 ? '#28a745' : candidate.overall_score >= 60 ? '#ffc107' : '#dc3545';
                const ivPercentage = candidate.implied_volatility !== undefined ? candidate.implied_volatility.toFixed(2) : 'N/A';
                const moneyness = candidate.moneyness || 'N/A';
                const moneynessColor = moneyness === 'ITM' ? '#28a745' : moneyness === 'ATM' ? '#ffc107' : '#6c757d';
                
                html += `
                    <tr style="background-color: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};">
                        <td style="padding: 6px 8px; border: 1px solid #ddd; font-weight: 600; font-size: 10px;">${candidate.tradingsymbol || 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">
                            <span style="padding: 2px 6px; border-radius: 3px; background-color: ${candidate.option_type === 'CE' ? '#d4edda' : '#f8d7da'}; color: ${candidate.option_type === 'CE' ? '#155724' : '#721c24'}; font-weight: 600; font-size: 10px;">
                                ${candidate.option_type}
                            </span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 10px;">₹${candidate.strike_price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">₹${candidate.last_price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px; font-weight: 600;">${ivPercentage}%</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${ivRankColor}; font-weight: 600; font-size: 10px;">${ivRank}%</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.delta !== undefined ? candidate.delta.toFixed(3) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.gamma !== undefined ? candidate.gamma.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${candidate.theta !== undefined && candidate.theta > 0 ? '#28a745' : '#dc3545'}; font-size: 10px;">
                            ${candidate.theta !== undefined ? `₹${candidate.theta.toFixed(4)}/d` : 'N/A'}
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.vega !== undefined ? candidate.vega.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.rho !== undefined ? candidate.rho.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">
                            <span style="color: ${candidate.liquidity_score >= 0.7 ? '#28a745' : candidate.liquidity_score >= 0.5 ? '#ffc107' : '#dc3545'};">
                                ${candidate.liquidity_score !== undefined ? candidate.liquidity_score.toFixed(2) : 'N/A'}
                            </span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${scoreColor}; font-weight: 600; font-size: 10px;">
                            ${candidate.overall_score !== undefined ? candidate.overall_score.toFixed(1) : 'N/A'}
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-size: 10px;">${candidate.days_to_expiry}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">
                            <span style="padding: 2px 6px; border-radius: 3px; background-color: ${moneynessColor === '#28a745' ? '#d4edda' : moneynessColor === '#ffc107' ? '#fff3cd' : '#e2e3e5'}; color: ${moneynessColor}; font-weight: 600; font-size: 9px;">
                                ${moneyness}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                ${totalFound > 5 ? `
                    <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border-radius: 5px; font-size: 11px; color: #856404;">
                        <strong>Note:</strong> Showing top 5 options out of ${totalFound} total candidates. Results are sorted by overall score.
                    </div>
                ` : ''}
            `;
            
            container.innerHTML = html;
        }
        
        function loadDerivativesSuggestions() {
            const container = document.getElementById('derivativesSuggestionsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading suggestions...</div>';
            
            fetch('/api/derivatives_suggestions')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load suggestions'}</div>`;
                        return;
                    }
                    
                    if (!data.suggestions || data.suggestions.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No suggestions available at this time</div>';
                        return;
                    }
                    
                    let html = `<div style="margin-bottom: 15px; font-size: 12px; color: #666;">
                        Analysis Date: ${data.analysis_date} | Current Price: ₹${data.current_price ? data.current_price.toFixed(2) : 'N/A'} | Total Suggestions: ${data.total_suggestions}
                    </div>`;
                    
                    data.suggestions.forEach((suggestion, index) => {
                        const actionColor = suggestion.action === 'BUY' ? '#28a745' : suggestion.action === 'SELL' ? '#dc3545' : '#ffc107';
                        const confidenceWidth = suggestion.confidence_score || 0;
                        
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <span style="font-weight: bold; font-size: 16px; color: ${actionColor};">
                                            ${suggestion.action} ${suggestion.derivative_type}
                                        </span>
                                        <span style="margin-left: 10px; color: #666;">${suggestion.instrument}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        ${suggestion.timestamp ? `<div style="font-size: 11px; color: #666; margin-bottom: 4px;">🕒 ${suggestion.timestamp}</div>` : ''}
                                        <div style="font-size: 12px; color: #666;">Confidence</div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 20px; width: 100px; position: relative; margin-top: 5px;">
                                            <div style="background: ${confidenceWidth >= 70 ? '#28a745' : confidenceWidth >= 40 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${confidenceWidth}%; border-radius: 10px; text-align: center; line-height: 20px; color: white; font-size: 10px; font-weight: bold;">
                                                ${confidenceWidth.toFixed(0)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; font-size: 12px;">
                                    <div><strong>Entry Level:</strong> ₹${suggestion.entry_level ? suggestion.entry_level.toFixed(2) : 'N/A'}</div>
                                    <div><strong>Stop Loss:</strong> ${suggestion.stop_loss ? '₹' + suggestion.stop_loss.toFixed(2) : 'N/A'}</div>
                                    <div><strong>Position Size:</strong> ${suggestion.position_size || 'N/A'}</div>
                                    ${suggestion.strike_price ? `<div><strong>Strike Price:</strong> ${suggestion.strike_price}</div>` : ''}
                                    ${suggestion.required_margin ? `
                                        <div style="grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 5px; border-left: 3px solid #ffc107;">
                                            <strong>💰 Required Margin/Money:</strong><br>
                                            ${suggestion.derivative_type === 'FUTURES' ? `
                                                Contract Value: ₹${suggestion.required_margin.contract_value ? suggestion.required_margin.contract_value.toFixed(2) : 'N/A'}<br>
                                                SPAN: ₹${suggestion.required_margin.span_margin ? suggestion.required_margin.span_margin.toFixed(2) : 'N/A'} | 
                                                Exposure: ₹${suggestion.required_margin.exposure_margin ? suggestion.required_margin.exposure_margin.toFixed(2) : 'N/A'}<br>
                                                <strong>Total Margin Required: ₹${suggestion.required_margin.total_margin ? suggestion.required_margin.total_margin.toFixed(2) : 'N/A'}</strong>
                                            ` : suggestion.required_margin.margin_type === 'Premium' ? `
                                                Premium per Lot: ₹${suggestion.estimated_premium ? (suggestion.estimated_premium * 50).toFixed(2) : 'N/A'}<br>
                                                <strong>Total Premium Required: ₹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            ` : suggestion.derivative_type === 'STRADDLE' ? `
                                                CALL Premium: ₹${suggestion.required_margin.call_premium ? suggestion.required_margin.call_premium.toFixed(2) : 'N/A'} | 
                                                PUT Premium: ₹${suggestion.required_margin.put_premium ? suggestion.required_margin.put_premium.toFixed(2) : 'N/A'}<br>
                                                <strong>Total Required: ₹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            ` : `
                                                <strong>Total Required: ₹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            `}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${suggestion.max_potential_profit !== undefined ? `
                                    <div style="background: #e8f5e9; padding: 8px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid #4caf50;">
                                        <strong style="font-size: 12px; color: #2e7d32;">Max Potential Profit:</strong> 
                                        <span style="font-size: 14px; font-weight: bold; color: #1b5e20;">₹${suggestion.max_potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                    </div>
                                ` : ''}
                                
                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 12px;">Target Levels:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${suggestion.target_levels ? suggestion.target_levels.map(t => {
                                            const profitDisplay = t.potential_profit !== undefined ? 
                                                ` - <strong style="color: #2e7d32;">Profit: ₹${t.potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>` : '';
                                            const straddleProfitDisplay = (t.call_profit !== undefined && t.put_profit !== undefined) ?
                                                ` - <strong style="color: #2e7d32;">CALL: ₹${t.call_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> / <strong style="color: #2e7d32;">PUT: ₹${t.put_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> (Total: ₹${t.potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})` : '';
                                            return `<li>₹${t.level.toFixed(2)} (${t.type}) - ${t.probability} probability${profitDisplay || straddleProfitDisplay}</li>`;
                                        }).join('') : '<li>No targets specified</li>'}
                                    </ul>
                                </div>
                                
                                <div style="background: #fff; padding: 10px; border-radius: 5px; font-size: 11px; color: #555; border-left: 3px solid ${actionColor};">
                                    <strong>Rationale:</strong> ${suggestion.rationale || 'No rationale provided'}
                                </div>
                                
                                ${suggestion.tpo_levels_used ? `
                                    <div style="margin-top: 10px; font-size: 11px; color: #666;">
                                        <strong>TPO Levels Used:</strong> 
                                        POC: ${suggestion.tpo_levels_used.poc ? '₹' + suggestion.tpo_levels_used.poc.toFixed(2) : 'N/A'},
                                        VAH: ${suggestion.tpo_levels_used.vah ? '₹' + suggestion.tpo_levels_used.vah.toFixed(2) : 'N/A'},
                                        VAL: ${suggestion.tpo_levels_used.val ? '₹' + suggestion.tpo_levels_used.val.toFixed(2) : 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching derivatives suggestions:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading suggestions</div>';
                });
        }
        
        // Load P&L Summary sdfsdf
        function loadPnlSummary() {
            fetch('/api/today_pnl_summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading P&L summary:', data.error);
                        return;
                    }
                    
                    const tbody = document.getElementById('pnlSummaryTableBody');
                    tbody.innerHTML = '';
                    
                    const categories = [
                        { 
                            name: 'Equity Portfolio', 
                            todayValue: data.equity_pnl || 0.0,
                            overallValue: data.equity_overall_pnl || 0.0
                        },
                        { 
                            name: 'Mutual Fund Portfolio', 
                            todayValue: data.mf_pnl || 0.0,
                            overallValue: data.mf_overall_pnl || 0.0
                        },
                        { 
                            name: 'Intraday Trades', 
                            todayValue: data.intraday_pnl || 0.0,
                            overallValue: null // Intraday only has today's P&L
                        },
                        { 
                            name: 'Total', 
                            todayValue: data.total_today_pnl || 0.0,
                            overallValue: data.total_overall_pnl || 0.0,
                            isTotal: true 
                        }
                    ];
                    
                    categories.forEach(cat => {
                        const todayColor = cat.todayValue >= 0 ? '#28a745' : '#dc3545';
                        const overallColor = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? (cat.overallValue >= 0 ? '#28a745' : '#dc3545') 
                            : todayColor;
                        const style = cat.isTotal ? 'font-weight: bold; font-size: 14px; border-top: 2px solid #ddd;' : '';
                        const todayFormatted = formatIndianNumber(cat.todayValue);
                        const overallFormatted = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? formatIndianNumber(cat.overallValue) 
                            : '-';
                        
                        const row = `
                            <tr style="${style}">
                                <td style="padding: 12px; border: 1px solid #ddd; ${cat.isTotal ? 'font-weight: bold;' : ''}">${cat.name}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${todayColor}; font-weight: bold;">
                                    ${cat.todayValue >= 0 ? '+' : ''}₹${todayFormatted}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${overallColor}; font-weight: bold;">
                                    ${cat.overallValue !== null && cat.overallValue !== undefined 
                                        ? `${cat.overallValue >= 0 ? '+' : ''}₹${overallFormatted}`
                                        : '-'}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching P&L summary:', error);
                });
        }
        
        // Load Portfolio Chart
        let portfolioChartInstance = null;
        function loadPortfolioChart(days) {
            fetch(`/api/portfolio_history?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading portfolio history:', data.error);
                        return;
                    }
                    
                    const ctx = document.getElementById('portfolioChart').getContext('2d');
                    
                    // Destroy previous chart instance if it exists
                    if (portfolioChartInstance) {
                        portfolioChartInstance.destroy();
                    }
                    
                    // Prepare chart data
                    const labels = data.portfolio_history.map(item => {
                        const date = new Date(item.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    });
                    
                    const equityData = data.portfolio_history.map(item => item.equity || 0);
                    const mfData = data.portfolio_history.map(item => item.mutual_fund || 0);
                    const totalData = data.portfolio_history.map(item => item.total || 0);
                    
                    portfolioChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Equity',
                                    data: equityData,
                                    borderColor: 'rgb(40, 167, 69)',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Mutual Fund',
                                    data: mfData,
                                    borderColor: 'rgb(13, 110, 253)',
                                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Total Portfolio',
                                    data: totalData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN', {maximumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN', {maximumFractionDigits: 0});
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching portfolio history:', error);
                });
        }
        
        // Load MF holdings data
        function loadMFHoldings() {
            fetch('/api/mf_holdings')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading MF holdings:', data.error);
                        document.getElementById('mfHoldingsTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('mfHoldingsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.mf_holdings || data.mf_holdings.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No MF holdings found</td></tr>';
                        return;
                    }
                    
                    data.mf_holdings.forEach(mf => {
                        const pnlColor = mf.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        const netChangeColor = mf.net_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                        const dayChangeColor = mf.day_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${mf.fund || mf.tradingsymbol || '-'}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">₹${mf.invested_amount.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">₹${mf.current_value.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${pnlColor}">₹${mf.pnl.toFixed(2)}</span>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${netChangeColor}">${mf.net_change_percentage >= 0 ? '+' : ''}${mf.net_change_percentage.toFixed(2)}%</span>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                    <span style="${dayChangeColor}">${mf.day_change_percentage >= 0 ? '+' : ''}${mf.day_change_percentage.toFixed(2)}%</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching MF holdings:', error);
                    document.getElementById('mfHoldingsTableBody').innerHTML = 
                        '<tr><td colspan="6" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                });
        }
        
        // Derivatives suggestions refresh timer (every 5 minutes)
        let derivativesSuggestionsTimer = null;
        
        function startDerivativesSuggestionsRefresh() {
            // Clear existing timer if any
            if (derivativesSuggestionsTimer) {
                clearInterval(derivativesSuggestionsTimer);
            }
            
            // Load immediately
            if (isMarketClosedIST()) {
                // Ensure no further refreshes after close
                derivativesSuggestionsTimer = null;
                return;
            }
            loadDerivativesSuggestions();
            
            // Then refresh every 5 minutes (300000 ms)
            derivativesSuggestionsTimer = setInterval(function() {
                if (isMarketClosedIST()) {
                    clearInterval(derivativesSuggestionsTimer);
                    derivativesSuggestionsTimer = null;
                    return;
                }
                loadDerivativesSuggestions();
            }, 300000);
        }
        
        // Load Portfolio Hedge Analysis
        function loadPortfolioHedgeAnalysis() {
            const container = document.getElementById('portfolioHedgeContainer');
            const hedgeRatio = document.getElementById('hedgeRatioSelector').value;
            const strategyType = document.getElementById('strategyTypeSelector').value;
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading hedge analysis...</div>';
            
            fetch(`/api/portfolio_hedge_analysis?target_hedge_ratio=${hedgeRatio}&strategy_type=${strategyType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load hedge analysis'}</div>`;
                        return;
                    }
                    
                    const metrics = data.portfolio_metrics || {};
                    const suggestions = data.hedge_suggestions || {};
                    const varMetrics = data.var_metrics || {};
                    
                    // Handle new response structure (strategies array)
                    const strategies = suggestions.strategies || [];
                    const diagnostics = suggestions.diagnostics || {};
                    
                    // Debug: Log what we received
                    console.log('Portfolio Hedge Analysis Response:', {
                        suggestions: suggestions,
                        diagnostics: diagnostics,
                        metrics: metrics
                    });
                    
                    let html = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Portfolio Value</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">₹${(metrics.portfolio_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Portfolio Beta</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${(metrics.beta || 0).toFixed(2)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Correlation with Nifty</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${((metrics.correlation || 0) * 100).toFixed(1)}%</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Hedge Effectiveness</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${(suggestions.hedge_effectiveness_score || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                    `;
                    
                    // Display summary metrics
                    if (suggestions.total_strategies > 0 || strategies.length > 0) {
                        html += `
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                                    <div><strong>Total Strategies:</strong> ${suggestions.total_strategies || strategies.length}</div>
                                    <div><strong>Total Hedge Value:</strong> ₹${(suggestions.total_hedge_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div><strong>Net Hedging Cost:</strong> ₹${(suggestions.net_hedging_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div><strong>Total Margin Required:</strong> ₹${(suggestions.total_margin_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Display all strategies
                    if (strategies.length > 0) {
                        // Group strategies by type
                        const groupedStrategies = {};
                        strategies.forEach(strategy => {
                            const type = strategy.strategy_type || 'OTHER';
                            if (!groupedStrategies[type]) {
                                groupedStrategies[type] = [];
                            }
                            groupedStrategies[type].push(strategy);
                        });
                        
                        Object.keys(groupedStrategies).forEach(strategyType => {
                            const typeStrategies = groupedStrategies[strategyType];
                            const typeName = typeStrategies[0].strategy_name || strategyType;
                            
                            html += `
                                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 15px 0; font-size: 14px;">🛡️ ${typeName} (${typeStrategies.length})</h4>
                            `;
                            
                            typeStrategies.forEach(strategy => {
                                html += `
                                    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 3px; border: 1px solid #ddd;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <strong style="font-size: 13px;">${strategy.instrument || (strategy.instruments && strategy.instruments.length > 0 ? 'Collar (Multiple)' : 'N/A')}</strong>
                                            <span style="color: ${strategy.direction === 'SHORT' ? '#dc3545' : '#28a745'}; font-weight: bold; font-size: 12px;">${strategy.direction || 'N/A'}</span>
                                        </div>
                                `;
                                
                                // Handle different strategy types
                                if (strategy.strategy_type === 'COLLAR' && strategy.instruments) {
                                    // Collar strategy has multiple instruments
                                    strategy.instruments.forEach(instr => {
                                        html += `
                                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; padding-left: 10px; border-left: 2px solid #ddd;">
                                                <strong>${instr.option_type} ${instr.strike_price}</strong> - ${instr.direction} ${instr.instrument}<br/>
                                                Premium: ${instr.direction === 'LONG' ? '₹' + (instr.total_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2}) : '₹' + (instr.total_income || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                            </div>
                                        `;
                                    });
                                    html += `
                                        <div style="font-size: 11px; color: #333; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                            <strong>Net Cost:</strong> ₹${(strategy.net_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}<br/>
                                            <strong>Margin Required:</strong> ₹${(strategy.margin_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}<br/>
                                            <strong>Coverage:</strong> ${(strategy.coverage_percentage || 0).toFixed(1)}%<br/>
                                            <div style="margin-top: 5px; font-style: italic; color: #666; font-size: 10px;">${strategy.rationale || ''}</div>
                                        </div>
                                    `;
                                } else {
                                    // Single instrument strategy
                                    html += `
                                        <div style="font-size: 11px; color: #666;">
                                            ${strategy.strike_price ? `<div><strong>Strike:</strong> ${strategy.strike_price} | <strong>Expiry:</strong> ${strategy.expiry || 'N/A'}</div>` : ''}
                                            <div><strong>Quantity:</strong> ${strategy.quantity || 0} lots (Lot Size: ${strategy.lot_size || 50})</div>
                                            ${strategy.entry_price ? `<div><strong>Entry Price:</strong> ₹${strategy.entry_price.toFixed(2)}</div>` : ''}
                                            ${strategy.total_premium ? `<div><strong>Premium Cost:</strong> ₹${strategy.total_premium.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.total_premium_income ? `<div><strong>Premium Income:</strong> ₹${strategy.total_premium_income.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.margin_required ? `<div><strong>Margin Required:</strong> ₹${strategy.margin_required.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.coverage_percentage ? `<div><strong>Coverage:</strong> ${strategy.coverage_percentage.toFixed(1)}%</div>` : ''}
                                            ${strategy.rationale ? `<div style="margin-top: 5px; font-style: italic; color: #666; font-size: 10px;">${strategy.rationale}</div>` : ''}
                                        </div>
                                    `;
                                }
                                
                                html += `</div>`;
                            });
                            
                            html += `</div>`;
                        });
                    } else if (suggestions.suggested_instruments && suggestions.suggested_instruments.length > 0) {
                        // Fallback for old format (backward compatibility)
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px;">🛡️ Recommended Hedge Strategy</h4>
                        `;
                        
                        suggestions.suggested_instruments.forEach(instrument => {
                            html += `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 3px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <strong>${instrument.instrument}</strong>
                                        <span style="color: #dc3545; font-weight: bold;">${instrument.direction}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <div>Quantity: ${instrument.quantity} (Lot Size: ${instrument.lot_size})</div>
                                        <div>Entry Price: ₹${instrument.entry_price.toFixed(2)}</div>
                                        <div>Hedge Value: ₹${instrument.hedge_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                        <div><strong>Estimated Margin Required: ₹${instrument.estimated_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></div>
                                        <div style="margin-top: 5px; font-style: italic; color: #666;">${instrument.rationale}</div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <div style="font-size: 12px;"><strong>Unhedged Exposure:</strong> ₹${(suggestions.unhedged_exposure || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div style="font-size: 12px;"><strong>Cost of Hedging:</strong> ₹${(suggestions.cost_of_hedging || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Show diagnostic information (diagnostics already defined at top of function)
                        const diagnosticMsg = suggestions.diagnostic_message || "No hedging strategies available";
                        
                        // Debug: Log diagnostics
                        console.log('No strategies found - Diagnostics:', diagnostics, 'Suggestions:', suggestions);
                        
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #856404;">⚠️ No Hedging Strategies Available</h4>
                                <div style="font-size: 12px; color: #856404; margin-bottom: 10px;">
                                    <strong>Issue:</strong> ${diagnosticMsg}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <strong>Data Status:</strong><br/>
                                    • Total Holdings: ${(diagnostics && diagnostics.holdings_count) || (suggestions.diagnostics && suggestions.diagnostics.holdings_count) || 0} (Equity: ${(diagnostics && diagnostics.equity_count) || (suggestions.diagnostics && suggestions.diagnostics.equity_count) || 0}, MF: ${(diagnostics && diagnostics.mf_count) || (suggestions.diagnostics && suggestions.diagnostics.mf_count) || 0})<br/>
                                    • Portfolio Value: ₹${((diagnostics && diagnostics.portfolio_value) || (suggestions.diagnostics && suggestions.diagnostics.portfolio_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} 
                                    (Equity: ₹${((diagnostics && diagnostics.equity_value) || (suggestions.diagnostics && suggestions.diagnostics.equity_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}, 
                                    MF: ₹${((diagnostics && diagnostics.mf_value) || (suggestions.diagnostics && suggestions.diagnostics.mf_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br/>
                                    • Beta: ${((diagnostics && diagnostics.beta) || (suggestions.diagnostics && suggestions.diagnostics.beta) || 0).toFixed(2)}<br/>
                                    • Nifty Price: ₹${((diagnostics && diagnostics.nifty_price) || (suggestions.diagnostics && suggestions.diagnostics.nifty_price) || 0).toFixed(2)}<br/>
                                    • Options Expiries Available: ${(diagnostics && diagnostics.expiries_available) || (suggestions.diagnostics && suggestions.diagnostics.expiries_available) || 0}<br/>
                                    <br/>
                                    <strong>Data Requirements:</strong><br/>
                                    • At least 1 holding with quantity > 0 (Equity and/or MF)<br/>
                                    • For Beta calculation: At least 10 days of historical OHLC data for equity holdings and Nifty 50<br/>
                                    • Current Nifty price available<br/>
                                    • For options strategies: At least 1 expiry date with options having volume ≥ 100 and OI ≥ 10,000<br/>
                                    <br/>
                                    <strong>Note:</strong> The analyzer now includes both Equity and Mutual Fund holdings. Beta is calculated using equity holdings only (MF holdings don't have daily historical prices), but total portfolio value includes both Equity and MF.
                                </div>
                            </div>
                        `;
                    }
                    
                    if (varMetrics.var_95) {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px;">📊 Value at Risk (VaR)</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <div>
                                        <div style="font-size: 11px; color: #666;">VaR (95% Confidence)</div>
                                        <div style="font-size: 16px; font-weight: bold;">₹${(varMetrics.var_95 || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #666;">VaR (99% Confidence)</div>
                                        <div style="font-size: 16px; font-weight: bold;">₹${(varMetrics.var_99 || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching portfolio hedge analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading hedge analysis</div>';
                });
        }
        
        // Load Margin Calculator
        function loadMarginCalculator() {
            const container = document.getElementById('availableMarginDisplay');
            if (!container) {
                console.warn('availableMarginDisplay element not found');
                return;
            }
            container.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">Loading margin data...</div>';
            
            fetch('/api/margin/available')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="color: #dc3545; font-size: 12px;">Error: ${data.error || 'Failed to load margin data'}</div>`;
                        return;
                    }
                    
                    const marginData = data.margin_data || {};
                    const utilizationPct = marginData.utilization_percentage || 0;
                    const utilizationColor = utilizationPct > 80 ? '#dc3545' : utilizationPct > 60 ? '#ffc107' : '#28a745';
                    
                    container.innerHTML = `
                        <div style="font-size: 12px;">
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Available Cash</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">₹${(marginData.available_cash || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Available Live Balance</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">₹${(marginData.available_live_balance || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Total Utilised</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">₹${(marginData.total_utilised || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div style="color: #666; margin-bottom: 5px;">Margin Utilization</div>
                                <div style="background: #e0e0e0; border-radius: 10px; height: 20px; position: relative; margin-top: 5px;">
                                    <div style="background: ${utilizationColor}; height: 100%; width: ${Math.min(100, utilizationPct)}%; border-radius: 10px; text-align: center; line-height: 20px; color: white; font-size: 10px; font-weight: bold;">
                                        ${utilizationPct.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching margin data:', error);
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Error loading margin data</div>';
                });
        }
        
        // Calculate Margin
        function calculateMargin() {
            const container = document.getElementById('marginCalculationResult');
            container.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">Calculating margin...</div>';
            
            const instrumentType = document.getElementById('marginInstrumentType').value;
            const instrumentToken = parseInt(document.getElementById('marginInstrumentToken').value);
            const quantity = parseInt(document.getElementById('marginQuantity').value);
            const entryPrice = parseFloat(document.getElementById('marginEntryPrice').value);
            const product = document.getElementById('marginProduct').value;
            
            if (!instrumentToken || !quantity || !entryPrice) {
                container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Please fill all required fields</div>';
                return;
            }
            
            let url = `/api/margin/calculate?instrument_token=${instrumentToken}&quantity=${quantity}&entry_price=${entryPrice}&instrument_type=${instrumentType}&product=${product}`;
            
            if (instrumentType === 'OPTIONS') {
                const strikePrice = parseFloat(document.getElementById('marginStrikePrice').value);
                const premium = parseFloat(document.getElementById('marginPremium').value);
                const optionType = document.getElementById('marginOptionType').value;
                const isLong = document.getElementById('marginIsLong').value === 'true';
                
                if (!strikePrice || !premium) {
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Strike price and premium are required for options</div>';
                    return;
                }
                
                url += `&strike_price=${strikePrice}&premium=${premium}&option_type=${optionType}&is_long=${isLong}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="color: #dc3545; font-size: 12px;">Error: ${data.error || 'Failed to calculate margin'}</div>`;
                        return;
                    }
                    
                    const calc = data.margin_calculation || {};
                    const check = data.margin_check || {};
                    const isSufficient = check.is_sufficient || false;
                    
                    let html = `
                        <div style="font-size: 12px;">
                            <div style="margin-bottom: 10px; padding: 10px; background: ${isSufficient ? '#d4edda' : '#f8d7da'}; border-radius: 5px; border-left: 4px solid ${isSufficient ? '#28a745' : '#dc3545'};">
                                <strong>Margin Status: ${isSufficient ? '✓ Sufficient' : '✗ Insufficient'}</strong>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Required Margin</div>
                                <div style="font-size: 16px; font-weight: bold;">₹${(calc.total_margin || calc.total_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            ${calc.span_margin ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">SPAN Margin: ₹${calc.span_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${calc.exposure_margin ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">Exposure Margin: ₹${calc.exposure_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${calc.contract_value ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">Contract Value: ₹${calc.contract_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${!isSufficient && check.shortfall ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                    <div style="color: #856404; font-size: 11px;">Shortfall: ₹${check.shortfall.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error calculating margin:', error);
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Error calculating margin</div>';
                });
        }
        
        // Toggle options fields based on instrument type
        document.addEventListener('DOMContentLoaded', function() {
            const instrumentTypeSelect = document.getElementById('marginInstrumentType');
            const optionsFields = document.getElementById('optionsFields');
            
            if (instrumentTypeSelect && optionsFields) {
                instrumentTypeSelect.addEventListener('change', function() {
                    optionsFields.style.display = this.value === 'OPTIONS' ? 'block' : 'none';
                });
            }
        });
        
        // Load Order Flow Analysis
        function loadOrderFlowAnalysis() {
            const container = document.getElementById('orderFlowAnalysisContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading order flow analysis...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/orderflow_analysis?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayOrderFlowAnalysis(data);
                })
                .catch(error => {
                    console.error('Error fetching order flow analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading order flow analysis</div>';
                });
        }
        
        // Display Order Flow Analysis
        function displayOrderFlowAnalysis(data) {
            const container = document.getElementById('orderFlowAnalysisContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">⚠️ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const trapped = data.trapped_traders || {};
            const divergences = data.volume_divergences || {};
            const exhaustion = data.exhaustion_signals || {};
            const pressure = data.pressure_analysis || {};
            const sentiment = data.overall_sentiment || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Overall Sentiment</div>
                        <div style="font-size: 20px; font-weight: bold;">${sentiment.sentiment || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Score: ${sentiment.sentiment_score || 0}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Buy/Sell Pressure</div>
                        <div style="font-size: 18px; font-weight: bold;">${pressure.pressure_direction || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Score: ${pressure.pressure_score || 0}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Trapped Traders</div>
                        <div style="font-size: 18px; font-weight: bold;">${trapped.count || 0}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Buyers: ${trapped.trapped_buyers_count || 0} | Sellers: ${trapped.trapped_sellers_count || 0}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Volume Divergences</div>
                        <div style="font-size: 18px; font-weight: bold;">${divergences.count || 0}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Bullish: ${divergences.bullish_divergences || 0} | Bearish: ${divergences.bearish_divergences || 0}</div>
                    </div>
                </div>
            `;
            
            // Trapped Traders Details
            if (trapped.trapped_buyers && trapped.trapped_buyers.length > 0 || trapped.trapped_sellers && trapped.trapped_sellers.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">⚠️ Trapped Traders</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Trapped Buyers (${trapped.trapped_buyers_count || 0})</div>
                                ${trapped.trapped_buyers && trapped.trapped_buyers.length > 0 ? 
                                    trapped.trapped_buyers.slice(0, 3).map(t => `
                                        <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                            <div style="font-size: 11px; font-weight: bold;">₹${t.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">Sell Vol: ${t.sell_volume} | ${t.severity}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None detected</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Trapped Sellers (${trapped.trapped_sellers_count || 0})</div>
                                ${trapped.trapped_sellers && trapped.trapped_sellers.length > 0 ? 
                                    trapped.trapped_sellers.slice(0, 3).map(t => `
                                        <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                            <div style="font-size: 11px; font-weight: bold;">₹${t.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">Buy Vol: ${t.buy_volume} | ${t.severity}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None detected</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Exhaustion Signals
            if (exhaustion.exhaustion_events && exhaustion.exhaustion_events.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">⚡ Exhaustion Signals (${exhaustion.count || 0})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${exhaustion.exhaustion_events.slice(0, 5).map(e => `
                                <div style="background: ${e.type === 'bullish_exhaustion' ? '#fff3cd' : '#d1ecf1'}; padding: 10px; border-radius: 5px; border-left: 3px solid ${e.type === 'bullish_exhaustion' ? '#ffc107' : '#17a2b8'};">
                                    <div style="font-size: 11px; font-weight: 600;">${e.type === 'bullish_exhaustion' ? '🔴 Bullish Exhaustion' : '🟢 Bearish Exhaustion'}</div>
                                    <div style="font-size: 12px; font-weight: bold; margin-top: 5px;">₹${e.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Volume: ${e.volume_multiple}x avg</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Sentiment Signals
            if (sentiment.signals && sentiment.signals.length > 0) {
                html += `
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Key Signals:</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                            ${sentiment.signals.map(signal => `<li style="margin-bottom: 3px;">${signal}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Load Footprint Analysis
        function loadFootprintAnalysis() {
            const container = document.getElementById('footprintAnalysisContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading footprint analysis...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/footprint_analysis?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayFootprintAnalysis(data);
                })
                .catch(error => {
                    console.error('Error fetching footprint analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading footprint analysis</div>';
                });
        }
        
        // Display Footprint Analysis
        function displayFootprintAnalysis(data) {
            const container = document.getElementById('footprintAnalysisContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">⚠️ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const levels = data.footprint_levels || [];
            const imbalances = data.imbalances || {};
            const hvn_lvn = data.hvn_lvn || {};
            const delta = data.delta || {};
            const priceRange = data.price_range || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Total Volume</div>
                        <div style="font-size: 14px; font-weight: bold;">${(data.total_volume || 0).toLocaleString()}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #007bff;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Net Buy Volume</div>
                        <div style="font-size: 14px; font-weight: bold; color: ${data.net_buy_volume > 0 ? '#28a745' : '#dc3545'};">
                            ${(data.net_buy_volume || 0).toLocaleString()}
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Delta Trend</div>
                        <div style="font-size: 14px; font-weight: bold;">${delta.delta_trend || 'Neutral'}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #6c757d;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Imbalance Zones</div>
                        <div style="font-size: 14px; font-weight: bold;">${imbalances.total_imbalance_zones || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #17a2b8;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">HVN Count</div>
                        <div style="font-size: 14px; font-weight: bold;">${hvn_lvn.hvn_count || 0}</div>
                    </div>
                </div>
            `;
            
            // Top Volume Imbalances
            if (imbalances.imbalances && imbalances.imbalances.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">⚖️ Volume Imbalances (Top 5)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${imbalances.imbalances.slice(0, 5).map(imb => `
                                <div style="background: ${imb.type === 'buy_imbalance' ? '#d4edda' : '#f8d7da'}; padding: 10px; border-radius: 5px; border-left: 3px solid ${imb.type === 'buy_imbalance' ? '#28a745' : '#dc3545'};">
                                    <div style="font-size: 11px; font-weight: 600;">₹${imb.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                        ${imb.type === 'buy_imbalance' ? 'Buy' : 'Sell'} Imbalance: ${imb.imbalance_ratio}%<br>
                                        Strength: ${imb.strength}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // HVN/LVN Levels
            if (hvn_lvn.hvn && hvn_lvn.hvn.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">📍 High Volume Nodes (HVN) - Potential S/R</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${hvn_lvn.hvn.slice(0, 5).map(hvn => `
                                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 11px; font-weight: 600;">₹${hvn.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Vol: ${hvn.volume.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Load Micro Levels
        function loadMicroLevels() {
            const container = document.getElementById('microLevelsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading critical micro levels...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/micro_levels?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayMicroLevels(data);
                })
                .catch(error => {
                    console.error('Error fetching micro levels:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading micro levels</div>';
                });
        }
        
        // Display Micro Levels
        function displayMicroLevels(data) {
            const container = document.getElementById('microLevelsContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">⚠️ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || data.message || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const currentPrice = data.current_price || 0;
            const support = data.support_levels || [];
            const resistance = data.resistance_levels || [];
            const pivots = data.pivot_levels || [];
            const allLevels = data.all_critical_levels || [];
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 5px;">
                    <strong>Current Price: ₹${currentPrice.toFixed(2)}</strong>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Support Levels (${support.length})</div>
                        ${support.length > 0 ? 
                            support.map(level => `
                                <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                    <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%<br>
                                        ${level.is_hvn ? '⭐ HVN' : ''}
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Resistance Levels (${resistance.length})</div>
                        ${resistance.length > 0 ? 
                            resistance.map(level => `
                                <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                    <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%<br>
                                        ${level.is_hvn ? '⭐ HVN' : ''}
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #007bff; margin-bottom: 8px;">Pivot Points (${pivots.length})</div>
                        ${pivots.length > 0 ? 
                            pivots.map(level => `
                                <div style="background: #d1ecf1; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #007bff;">
                                    <div style="font-size: 13px; font-weight: bold;">₹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                </div>
            `;
            
            // Top Critical Levels
            if (allLevels.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">🎯 Top Critical Levels (by Significance)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${allLevels.slice(0, 5).map(level => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid ${level.type === 'support' ? '#dc3545' : level.type === 'resistance' ? '#28a745' : '#007bff'};">
                                    <div style="font-size: 12px; font-weight: 600;">₹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                        Type: ${level.type} | Score: ${level.significance_score || 0}/100
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Export Data Function
        function exportData() {
            const tableName = document.getElementById('exportTableName').value;
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            const columns = document.getElementById('exportColumns').value.trim();
            const format = document.getElementById('exportFormat').value;
            const statusDiv = document.getElementById('exportStatus');
            
            if (!tableName) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a table name</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #666;">Preparing export...</span>';
            
            // Create form data
            const formData = new FormData();
            formData.append('table_name', tableName);
            if (fromDate) formData.append('from_date', fromDate);
            if (toDate) formData.append('to_date', toDate);
            if (columns) formData.append('columns', columns);
            formData.append('export_format', format);
            
            // Submit form to export endpoint
            fetch('/api/export_data', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Export failed');
                    });
                }
                
                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `${tableName}_${fromDate || 'all'}_${toDate || 'all'}.${format === 'excel' ? 'xlsx' : format === 'json' ? 'json' : 'csv'}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Download file
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    statusDiv.innerHTML = '<span style="color: #28a745;">✓ Export completed successfully!</span>';
                });
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Export failed'}</span>`;
            });
        }
        
        // Import Data Function
        function importData() {
            const tableName = document.getElementById('importTableName').value;
            const fileInput = document.getElementById('importCsvFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('importStatus');
            
            if (!tableName) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a table name</span>';
                return;
            }
            
            if (!file) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a CSV file</span>';
                return;
            }
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a CSV file</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #666;">Importing data...</span>';
            
            // Create form data
            const formData = new FormData();
            formData.append('table_name', tableName);
            formData.append('file', file);
            
            // Submit form to import endpoint
            fetch('/api/import_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error || !data.success) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${data.error || 'Import failed'}</span>`;
                    return;
                }
                
                statusDiv.innerHTML = `
                    <div style="color: #28a745;">
                        <strong>✓ Import completed!</strong><br>
                        <small>Total rows: ${data.total_rows || 0} | Inserted: ${data.rows_inserted || 0} | Skipped: ${data.rows_skipped || 0}</small>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error importing data:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Import failed'}</span>`;
            });
        }
        
        function refreshStockPrices() {
            const statusDiv = document.getElementById('refreshStockPricesStatus');
            const btn = document.getElementById('refreshStockPricesBtn');
            
            if (!statusDiv || !btn) {
                console.error('Required elements not found');
                return;
            }
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = '⏳ Refreshing...';
            statusDiv.innerHTML = '<span style="color: #666;">Starting stock price refresh process...</span>';
            
            // Call API endpoint
            fetch('/api/refresh_stock_prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = '🔄 Refresh Stock Prices';
                
                if (data.error || !data.success) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">❌ Error: ${data.error || data.message || 'Refresh failed'}</span>`;
                    if (data.errors && data.errors.length > 0) {
                        const errorList = data.errors.slice(0, 5).join('<br>');
                        statusDiv.innerHTML += `<div style="margin-top: 10px; font-size: 11px; color: #856404;">${errorList}</div>`;
                    }
                    return;
                }
                
                // Show success message with statistics
                let message = `<div style="color: #28a745;">`;
                message += `<strong>✓ ${data.message || 'Stock prices refreshed successfully!'}</strong><br>`;
                if (data.stocks_processed !== undefined && data.records_inserted !== undefined) {
                    message += `<small>Stocks processed: ${data.stocks_processed} | Records inserted/updated: ${data.records_inserted}</small>`;
                }
                message += `</div>`;
                
                if (data.errors && data.errors.length > 0) {
                    message += `<div style="margin-top: 10px; font-size: 11px; color: #856404;">`;
                    message += `<strong>⚠️ Some errors occurred:</strong><br>`;
                    message += data.errors.slice(0, 10).join('<br>');
                    if (data.errors.length > 10) {
                        message += `<br><small>... and ${data.errors.length - 10} more errors</small>`;
                    }
                    message += `</div>`;
                }
                
                statusDiv.innerHTML = message;
            })
            .catch(error => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = '🔄 Refresh Stock Prices';
                
                console.error('Error refreshing stock prices:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">❌ Error: ${error.message || 'Failed to refresh stock prices'}</span>`;
            });
        }
        
        // Preview CSV file before import
        document.getElementById('importCsvFile')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewDiv = document.getElementById('importPreview');
            const previewContent = document.getElementById('importPreviewContent');
            
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csv = event.target.result;
                    const lines = csv.split('\n').slice(0, 6); // First 5 data rows + header
                    
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 10px;">';
                    lines.forEach((line, index) => {
                        const cells = line.split(',');
                        html += '<tr>';
                        cells.forEach(cell => {
                            const cellContent = cell.trim().substring(0, 20); // Limit length
                            html += `<td style="padding: 4px; border: 1px solid #ddd; ${index === 0 ? 'font-weight: 600; background-color: #f8f9fa;' : ''}">${cellContent || '&nbsp;'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    previewContent.innerHTML = html;
                    previewDiv.style.display = 'block';
                };
                reader.readAsText(file);
            } else {
                previewDiv.style.display = 'none';
            }
        });
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            loadPositions();
            loadGainersLosers();
            loadPremarketAnalysis(); // Load pre-market analysis on page load
            loadOptionsScanner(); // Load options scanner on page load
            {% if show_holdings %}
            loadMFHoldings();
            loadPnlSummary();
            loadPortfolioChart(30);
            {% endif %}
            initializeRefreshSystem();
            
            // Start derivatives suggestions refresh (every 1 minute)
            startDerivativesSuggestionsRefresh();
        });

        // Tab Switching Functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Load tab-specific data when switching
                if (tabName === 'gainers-losers') {
                    loadGainersLosers();
                } else if (tabName === 'holdings') {
                    {% if show_holdings %}
                    // Load P&L, Portfolio chart, and Portfolio Hedge Analysis when Holdings tab is shown
                    loadPnlSummary();
                    const daysSelector = document.getElementById('portfolioDaysSelector');
                    if (daysSelector) {
                        loadPortfolioChart(daysSelector.value || 30);
                    }
                    // Load portfolio hedge analysis
                    loadPortfolioHedgeAnalysis();
                    {% endif %}
                } else if (tabName === 'live-market') {
                    // Load options scanner when Live Market tab is opened
                    const scannerContainer = document.getElementById('optionsScannerContainer');
                    if (scannerContainer && (scannerContainer.innerHTML.trim() === '' || 
                        scannerContainer.innerHTML.includes('Configure filters'))) {
                        loadOptionsScanner();
                    }
                }
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
    </script>
    
    <!-- End Holdings Tab Content -->

    <!-- Candlestick Chart Modal -->
    <div id="candlestickModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); padding: 20px; border: 1px solid #888; width: 80vw; height: 80vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                <h2 id="modalStockSymbol" style="margin: 0; font-size: 1.5em;">Stock Chart</h2>
                <button onclick="closeCandlestickModal()" style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 14px;">Close</button>
            </div>
            <div style="margin-bottom: 15px; flex-shrink: 0;">
                <label for="chartDays">Days to display:</label>
                <select id="chartDays" onchange="updateCandlestickChart()" style="padding: 5px 10px; margin-left: 10px;">
                    <option value="7">7 days</option>
                    <option value="15">15 days</option>
                    <option value="30">30 days</option>
                    <option value="60">60 days</option>
                    <option value="90" selected>90 days</option>
                </select>
            </div>
            <div style="flex: 1; overflow: hidden; position: relative;">
                <canvas id="candlestickChartCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentStockSymbol = '';
        let candlestickChart = null;

        function loadSparklines() {
            {% for holding in holdings_info.holdings %}
            loadSparkline('{{ holding.trading_symbol }}');
            {% endfor %}
        }

        function loadSparkline(symbolOrId) {
            // Extract actual symbol from ID if it's a prefixed ID (e.g., "gainer-RELIANCE" -> "RELIANCE")
            let symbol = symbolOrId;
            let canvasId = `sparkline-${symbolOrId}`;
            
            // Handle prefixed IDs like "gainer-RELIANCE" or "loser-RELIANCE" or "ajax-RELIANCE"
            const knownPrefixes = ['gainer', 'loser', 'ajax'];
            if (symbolOrId.includes('-')) {
                const parts = symbolOrId.split('-');
                if (parts.length >= 2 && knownPrefixes.includes(parts[0])) {
                    // Remove the known prefix to get the actual symbol
                    symbol = parts.slice(1).join('-');
                    canvasId = `sparkline-${symbolOrId}`;
                }
            }
            
            fetch(`/api/sparkline/${symbol}?days=30`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(`Error loading sparkline for ${symbol}:`, data.error);
                        return;
                    }
                    
                    // Try to find canvas with various ID patterns
                    let canvas = document.getElementById(`sparkline-${symbol}`);
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-ajax-${symbol}`);
                    }
                    if (!canvas && canvasId !== `sparkline-${symbol}`) {
                        canvas = document.getElementById(canvasId);
                    }
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const prices = data.prices;
                    if (!prices || prices.length === 0) return;
                    
                    const width = canvas.width;
                    const height = canvas.height;
                    const padding = 5;
                    
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceRange = maxPrice - minPrice || 1;
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, width, height);
                    
                    // Determine color based on trend
                    const firstPrice = prices[0];
                    const lastPrice = prices[prices.length - 1];
                    const color = lastPrice >= firstPrice ? '#28a745' : '#dc3545';
                    
                    // Draw line
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    for (let i = 0; i < prices.length; i++) {
                        const x = padding + (i / (prices.length - 1)) * (width - 2 * padding);
                        const y = height - padding - ((prices[i] - minPrice) / priceRange) * (height - 2 * padding);
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    
                    ctx.stroke();
                })
                .catch(error => console.error(`Error loading sparkline for ${symbol}:`, error));
        }

        function showCandlestick(symbol) {
            currentStockSymbol = symbol;
            document.getElementById('modalStockSymbol').textContent = `${symbol} - Candlestick Chart`;
            document.getElementById('candlestickModal').style.display = 'block';
            updateCandlestickChart();
        }

        function closeCandlestickModal() {
            document.getElementById('candlestickModal').style.display = 'none';
            if (candlestickChart) {
                candlestickChart.destroy();
                candlestickChart = null;
            }
        }
        
        // Handle window resize to adjust chart size
        window.addEventListener('resize', function() {
            if (document.getElementById('candlestickModal').style.display !== 'none' && candlestickChart) {
                const canvas = document.getElementById('candlestickChartCanvas');
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                candlestickChart.resize();
            }
        });

        function updateCandlestickChart() {
            if (!currentStockSymbol) return;
            
            const days = document.getElementById('chartDays').value;
            
            fetch(`/api/candlestick/${currentStockSymbol}?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading candlestick data:', data.error);
                        return;
                    }
                    
                    console.log('Candlestick data received:', data);
                    console.log('First data point structure:', data.data[0]);
                    console.log('Sample data point:', JSON.stringify(data.data[0], null, 2));
                    
                    const ctx = document.getElementById('candlestickChartCanvas').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (candlestickChart) {
                        candlestickChart.destroy();
                    }
                    
                    // Prepare data for Chart.js Financial candlestick
                    // Data format: {x: timestamp, o: open, h: high, l: low, c: close}
                    const candlestickData = data.data.map(d => {
                        // Convert date string to timestamp
                        const timestamp = new Date(d.date).getTime();
                        return {
                            x: timestamp, o: d.open, h: d.high, l: d.low, c: d.close
                        };
                    });
                    
                    // Prepare indicator data for line charts
                    const sma20Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_20
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma50Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_50
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma200Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_200
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const supertrendData = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.supertrend,
                        direction: d.supertrend_direction
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    console.log('Candlestick data formatted:', candlestickData.slice(0, 5));
                    console.log('SMA 20 data:', sma20Data.slice(0, 5));
                    console.log('SMA 50 data:', sma50Data.slice(0, 5));
                    console.log('SMA 200 data:', sma200Data.slice(0, 5));
                    console.log('Supertrend data:', supertrendData.slice(0, 5));
                    
                    // Get the container dimensions
                    const container = ctx.canvas.parentElement;
                    ctx.canvas.width = container.clientWidth;
                    ctx.canvas.height = container.clientHeight;
                    
                    // Create candlestick chart using Chart.js Financial
                    try {
                    // First, create the candlestick chart
                    candlestickChart = new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: currentStockSymbol,
                                data: candlestickData
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: `${currentStockSymbol} - Last ${days} Days`
                                }
                            }
                        }
                    });
                    
                    // Add indicator datasets after chart creation
                    if (sma20Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 20',
                            data: sma20Data,
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma50Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 50',
                            data: sma50Data,
                            type: 'line',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma200Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 200',
                            data: sma200Data,
                            type: 'line',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (supertrendData.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'Supertrend',
                            data: supertrendData,
                            type: 'line',
                            borderColor: 'rgba(138, 43, 226, 1)',  // Default fallback
                            backgroundColor: 'rgba(138, 43, 226, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false,
                            segment: {
                                borderColor: (ctx) => {
                                    const segment = ctx.p0;
                                    // Get direction from the data point
                                    const dataIndex = ctx.p0DataIndex;
                                    const point = supertrendData[dataIndex];
                                    if (point && point.direction === 1) {
                                        return 'rgba(40, 167, 69, 1)';  // Green for uptrend
                                    } else {
                                        return 'rgba(220, 53, 69, 1)';  // Red for downtrend
                                    }
                                }
                            }
                        });
                    }
                    
                    // Update the chart to render the new datasets
                    candlestickChart.update();
                    console.log('Chart created successfully');
                    console.log('Chart datasets after update:', candlestickChart.data.datasets.length);
                    candlestickChart.data.datasets.forEach((ds, index) => {
                        console.log(`Dataset ${index}:`, ds.label, ds.type, 'data points:', ds.data.length);
                    });
                    } catch (error) {
                        console.error('Error creating chart:', error);
                        console.error(error.stack);
                    }
                })
                .catch(error => console.error('Error loading candlestick data:', error));
        }

        // Load sparklines after page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSparklines();
        });
    </script>
</body>
</html>
