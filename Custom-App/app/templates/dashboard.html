<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 95%;
            width: 95%;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #4CAF50;
        }

        .status-offline {
            background-color: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 95%;
            width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-icon {
            font-size: 24px;
        }

        .tpo-chart-container {
            height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
        }

        .chart-placeholder {
            text-align: center;
            color: #666;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .backtest-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .backtest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .backtest-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .mode-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .mode-live {
            background: #d4edda;
            color: #155724;
        }

        .mode-backtest {
            background: #fff3cd;
            color: #856404;
        }

        .date-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-backtest {
            background: #17a2b8;
            color: white;
        }

        .btn-live {
            background: #28a745;
            color: white;
        }

        .analysis-info {
            background: rgba(23, 162, 184, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #17a2b8;
        }

        .analysis-info h4 {
            color: #17a2b8;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .grafana-iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-container {
            max-width: 80%;
            width: 80%;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 0;
        }

        .tab-button {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 1200px) {
            /* Stack gainers and losers vertically on smaller screens */
            #gainers-losers-tab > div:first-child {
                flex-direction: column !important;
            }
            
            #gainers-losers-tab > div:first-child > .card {
                width: 100% !important;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                width: 95%;
                max-width: 95%;
                flex-direction: column;
                gap: 15px;
            }
            
            .container {
                width: 95%;
                max-width: 95%;
            }
            
            .tab-nav-container {
                width: 95%;
                max-width: 95%;
            }
            
            /* Stack gainers and losers vertically on mobile */
            #gainers-losers-tab > div:first-child {
                flex-direction: column !important;
            }
            
            #gainers-losers-tab > div:first-child > .card {
                width: 100% !important;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab-button {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">ğŸ“Š Trading Dashboard</div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span>Kite Token: {{ token_status }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="lastUpdateText">Last Update: {{ last_update }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="totalTicksText">Total Ticks today: {{ total_ticks }}</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-online"></span>
                    <span id="marginBalance">Balance: â‚¹0</span>
                </div>
                <div class="status-item">
                    <a href="/logout" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">
                        ğŸšª Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <div class="tab-nav-container">
            <button class="tab-button active" onclick="switchTab('live-market')">
                ğŸ“Š Live Market
            </button>
            <button class="tab-button" onclick="switchTab('holdings')">
                ğŸ’¼ Holdings
            </button>
            <button class="tab-button" onclick="switchTab('gainers-losers')">
                ğŸ“ˆ Stocks
            </button>
            <button class="tab-button" onclick="switchTab('utilities')">
                ğŸ”§ Utilities
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Live Market Tab Content -->
        <div id="live-market-tab" class="tab-content active">
        <!-- Backtesting Controls -->
        <div class="backtest-controls">
            <div class="backtest-header">
                <h3 class="backtest-title">ğŸ“Š Analysis Mode</h3>
                <span id="modeIndicator" class="mode-indicator mode-live">LIVE MODE</span>
            </div>
            
            <div class="date-controls">
                <label for="analysisDate">Analysis Date:</label>
                <input type="date" id="analysisDate" class="date-input" />
                <button id="backtestBtn" class="btn btn-backtest">ğŸ” Backtest</button>
                <button id="liveBtn" class="btn btn-live">ğŸ“¡ Live Mode</button>
                <button id="refreshBtn" class="btn btn-secondary">ğŸ”„ Refresh Charts</button>
            </div>
            
            <div class="date-controls" style="margin-top: 10px;">
                <label for="refreshInterval">Auto Refresh:</label>
                <select id="refreshInterval" class="date-input" disabled="true">
                    <option value="5000">5 seconds</option>
                    <option value="10000" selected>10 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                    <option value="600000">10 minutes</option>
                    <option value="0">Manual only</option>
                </select>
                <span id="refreshStatus" style="margin-left: 10px; font-size: 12px; color: #666;">Next refresh in: <span id="countdown">10</span>s</span>
            </div>
            
        </div>

        <!-- Market Bias Analysis Section -->
        <div class="card" style="margin-bottom: 10px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ¯ Market Bias Analysis</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ“Š</span>
            </div>
            <div class="metrics-grid" style="gap: 10px; margin-bottom: 10px;">
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasScore" style="font-size: 18px;">0.0</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Score</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasDirection" style="font-size: 18px;">Neutral</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Direction</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="biasStrength" style="font-size: 18px;">Weak</div>
                    <div class="metric-label" style="font-size: 11px;">Bias Strength</div>
                </div>
                <div class="metric-card" style="padding: 12px;">
                    <div class="metric-value" id="riskLevel" style="font-size: 18px;">Medium</div>
                    <div class="metric-label" style="font-size: 11px;">Risk Level</div>
                </div>
            </div>
            <!-- Long-Term TPO Analysis Section -->
            <div id="longTermTPOSection" style="padding: 15px; border-top: 1px solid #e0e0e0; margin-top: 10px; display: none;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #333;">ğŸ“ˆ Long-Term TPO Analysis (20 Days)</div>
                <div class="metrics-grid" style="gap: 10px; margin-bottom: 10px;">
                    <div class="metric-card" style="padding: 10px; background-color: #f8f9fa;">
                        <div class="metric-value" id="longTermBiasScore" style="font-size: 16px; color: #6c757d;">N/A</div>
                        <div class="metric-label" style="font-size: 11px;">Long-Term Bias Score</div>
                    </div>
                    <div class="metric-card" style="padding: 10px; background-color: #f8f9fa;">
                        <div class="metric-value" id="longTermBiasDirection" style="font-size: 16px; color: #6c757d;">N/A</div>
                        <div class="metric-label" style="font-size: 11px;">Long-Term Direction</div>
                    </div>
                    <div class="metric-card" style="padding: 10px; background-color: #f8f9fa;">
                        <div class="metric-value" id="longTermBiasStrength" style="font-size: 16px; color: #6c757d;">N/A</div>
                        <div class="metric-label" style="font-size: 11px;">Long-Term Strength</div>
                    </div>
                    <div class="metric-card" style="padding: 10px; background-color: #f8f9fa;">
                        <div class="metric-value" id="longTermDaysAnalyzed" style="font-size: 16px; color: #6c757d;">N/A</div>
                        <div class="metric-label" style="font-size: 11px;">Days Analyzed</div>
                    </div>
                </div>
                <div id="longTermTPOFactors" style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Key Factors:</div>
                    <div id="longTermTPOFactorsList" style="color: #666;">No factors available</div>
                </div>
                <!-- Bear Trap Analysis Section -->
                <div id="bearTrapSection" style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107; display: none;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #856404;">âš ï¸ Potential Bear Traps</div>
                    <div id="bearTrapDetails" style="font-size: 11px; color: #856404;">
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- TPO Charts Section (full width) -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ˆ TPO Market Profile</h3>
                <span class="card-icon">ğŸ“Š</span>
            </div>
            <div class="tpo-chart-container" style="height: 600px; background-color: #000;">
                <img id="tpoChartImage" src="" alt="TPO Charts" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
            </div>
        </div>

        <!-- 5-Day TPO Chart Section (full width) -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“Š 5-Day TPO Market Profile with Volume Profile</h3>
                <span class="card-icon">ğŸ“ˆ</span>
                <button onclick="load5DayTPOChart()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #007bff; color: white; border: none; margin-left: 10px;">
                    ğŸ”„ Refresh Chart
                </button>
            </div>
            <div class="tpo-chart-container" style="height: 700px; background-color: #000;">
                <img id="tpo5DayChartImage" src="" alt="5-Day TPO Chart" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
            </div>
        </div>

        <!-- Pre-market TPO Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #007bff; color: white;">
                <h3 class="card-title" style="color: white;">ğŸŒ… Pre-Market TPO Analysis (9:05 AM - 9:15 AM)</h3>
                <button onclick="loadPremarketAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #007bff; border: none; margin-left: 10px;">
                    ğŸ”„ Refresh Analysis
                </button>
            </div>
            <div id="premarketAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load pre-market TPO analysis
                </div>
            </div>
        </div>

        <!-- Order Flow Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #17a2b8; color: white;">
                <h3 class="card-title" style="color: white;">ğŸŒŠ Order Flow Analysis</h3>
                <button onclick="loadOrderFlowAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #17a2b8; border: none; margin-left: 10px;">
                    ğŸ”„ Refresh Analysis
                </button>
            </div>
            <div id="orderFlowAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load order flow analysis
                </div>
            </div>
        </div>

        <!-- Footprint Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #28a745; color: white;">
                <h3 class="card-title" style="color: white;">ğŸ“Š Footprint Analysis</h3>
                <button onclick="loadFootprintAnalysis()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #28a745; border: none; margin-left: 10px;">
                    ğŸ”„ Refresh Analysis
                </button>
            </div>
            <div id="footprintAnalysisContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load footprint analysis
                </div>
            </div>
        </div>

        <!-- Critical Micro Levels Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="background-color: #ffc107; color: #333;">
                <h3 class="card-title" style="color: #333;">ğŸ¯ Critical Micro Levels</h3>
                <button onclick="loadMicroLevels()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #333; color: #ffc107; border: none; margin-left: 10px;">
                    ğŸ”„ Refresh Levels
                </button>
            </div>
            <div id="microLevelsContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Levels" to identify critical support/resistance levels
                </div>
            </div>
        </div>

        <!-- Options Chain Scanner Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px; background-color: #6f42c1; color: white;">
                <h3 class="card-title" style="font-size: 16px; color: white;">ğŸ” Options Chain Scanner</h3>
                <button onclick="loadOptionsScanner()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #6f42c1; border: none; margin-left: 10px;">
                    ğŸ”„ Scan Options
                </button>
            </div>
            <div style="padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Strategy Type:</label>
                        <select id="scannerStrategyType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="covered_call">Covered Call</option>
                            <option value="cash_secured_put">Cash-Secured Put</option>
                            <option value="iron_condor">Iron Condor</option>
                            <option value="strangle">Strangle</option>
                            <option value="straddle">Straddle</option>
                            <option value="vertical_spread">Vertical Spread</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Expiry:</label>
                        <input type="date" id="scannerExpiry" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Option Type:</label>
                        <select id="scannerOptionType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="">All</option>
                            <option value="CE">Call (CE)</option>
                            <option value="PE">Put (PE)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min IV Rank:</label>
                        <input type="number" id="scannerMinIVRank" value="50" min="0" max="100" step="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Max Days to Expiry:</label>
                        <input type="number" id="scannerMaxDays" value="60" min="1" max="365" step="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Liquidity Score:</label>
                        <input type="number" id="scannerMinLiquidity" value="0.5" min="0" max="1" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Volume:</label>
                        <input type="number" id="scannerMinVolume" value="0" min="0" step="100" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min OI:</label>
                        <input type="number" id="scannerMinOI" value="0" min="0" step="1000" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Min Strike:</label>
                        <input type="number" id="scannerMinStrike" step="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Max Strike:</label>
                        <input type="number" id="scannerMaxStrike" step="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                </div>
            </div>
            <div id="optionsScannerContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Configure filters above and click "Scan Options" to find candidates
                </div>
            </div>
        </div>

        <!-- Options OI Analysis Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px; background-color: #17a2b8; color: white;">
                <h3 class="card-title" style="font-size: 16px; color: white;">ğŸ“Š Top 5 Options by Open Interest</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showFullOIChart()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #17a2b8; border: none; cursor: pointer;">
                        ğŸ“Š View Chart for all options
                    </button>
                    <button onclick="loadTop5OIOptions()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #17a2b8; border: none; margin-left: 10px;">
                        ğŸ”„ Refresh OI Analysis
                    </button>
                </div>
            </div>
            <div id="top5OIContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh OI Analysis" to load top 5 options by Open Interest
                </div>
            </div>
            <!-- OI Chart Modal -->
            <div id="oiChartModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                <div id="oiChartModalContent" style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; height: 80vh; overflow: hidden; display: flex; flex-direction: column; position: relative; transition: none;">
                    <!-- Resize handles -->
                    <div class="resize-handle resize-handle-n" style="position: absolute; top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; z-index: 10; background: transparent;"></div>
                    <div class="resize-handle resize-handle-s" style="position: absolute; bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; z-index: 10; background: transparent;"></div>
                    <div class="resize-handle resize-handle-e" style="position: absolute; top: 0; bottom: 0; right: 0; width: 5px; cursor: ew-resize; z-index: 10; background: transparent;"></div>
                    <div class="resize-handle resize-handle-w" style="position: absolute; top: 0; bottom: 0; left: 0; width: 5px; cursor: ew-resize; z-index: 10; background: transparent;"></div>
                    <div class="resize-handle resize-handle-ne" style="position: absolute; top: 0; right: 0; width: 15px; height: 15px; cursor: nesw-resize; z-index: 11; background: transparent;"></div>
                    <div class="resize-handle resize-handle-nw" style="position: absolute; top: 0; left: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 11; background: transparent;"></div>
                    <div class="resize-handle resize-handle-se" style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 11; background: transparent;"></div>
                    <div class="resize-handle resize-handle-sw" style="position: absolute; bottom: 0; left: 0; width: 15px; height: 15px; cursor: nesw-resize; z-index: 11; background: transparent;"></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                        <h3 id="oiChartTitle" style="margin: 0; color: #17a2b8;">Open Interest Chart</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="zoomOIChart('in')" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;" title="Zoom In">ğŸ”+</button>
                            <button onclick="zoomOIChart('out')" style="background: #ffc107; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;" title="Zoom Out">ğŸ”-</button>
                            <button onclick="zoomOIChart('reset')" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;" title="Reset Zoom">â†º</button>
                            <button id="oiChartMaximizeBtn" onclick="toggleOIMaximize()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">â›¶ Maximize</button>
                            <button onclick="closeOIChart()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">âœ• Close</button>
                        </div>
                    </div>
                    <div id="oiChartContainer" style="text-align: center; padding: 10px; flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; position: relative;" onwheel="handleOIChartWheel(event)">
                        <div id="oiChartImageWrapper" style="position: relative; display: inline-block; overflow: auto;">
                            <div style="color: #666;">Loading chart...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Options Suggestions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ“Š Options Suggestions</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ“Š</span>
                <div style="display: inline-flex; align-items: center; margin-left: 10px; gap: 10px;">
                    <select id="optionsTimeframe" style="padding: 6px 12px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="5">5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="15" selected>15 minutes</option>
                        <option value="20">20 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="240">4 hours</option>
                        <option value="1">1 day</option>
                        <option value="3">3 days</option>
                        <option value="5">5 days</option>
                    </select>
                    <button onclick="loadOptionsSuggestions()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                        ğŸ”„ Refresh
                    </button>
                </div>
            </div>
            <div id="optionsSuggestionsContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh" to load options trading suggestions based on POC changes and order flow
                </div>
            </div>
        </div>

        <!-- Options Back-testing Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ”¬ Options Back-testing</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ”¬</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label style="font-size: 12px; margin-right: 5px;">Start Date:</label>
                        <input type="date" id="backtestStartDate" style="padding: 6px 12px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin-right: 5px;">End Date:</label>
                        <input type="date" id="backtestEndDate" style="padding: 6px 12px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin-right: 5px;">Strategy:</label>
                        <select id="backtestStrategyType" style="padding: 6px 12px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="all" selected>All Strategies</option>
                            <option value="single">Single Options</option>
                            <option value="spread">Spreads</option>
                            <option value="multi_leg">Multi-Leg</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; margin-right: 5px;">
                            <input type="checkbox" id="backtestShowOnlyProfitable" style="margin-right: 5px;">
                            Show Only Profitable
                        </label>
                    </div>
                    <div>
                        <label style="font-size: 12px; margin-right: 5px;">Min Profit:</label>
                        <input type="number" id="backtestMinProfit" step="0.01" placeholder="Optional" style="padding: 6px 12px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; width: 100px;">
                    </div>
                    <button onclick="runBacktest()" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                        â–¶ï¸ Run Back-test
                    </button>
                </div>
                <div id="backtestDataQualityIndicator" style="margin-bottom: 10px; padding: 10px; background-color: #fff3cd; border-radius: 5px; display: none;">
                    <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">Data Quality Indicator:</div>
                    <div id="dataQualityContent" style="font-size: 11px;"></div>
                </div>
                <div id="backtestResultsContainer" style="display: none;">
                    <div id="backtestMetricsPanel" style="margin-bottom: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;"></div>
                    <div id="backtestTradesTable" style="overflow-x: auto;"></div>
                </div>
                <div id="backtestLoading" style="display: none; text-align: center; padding: 20px; color: #666;">
                    Running back-test... This may take a few moments.
                </div>
            </div>
        </div>

        <!-- TPO-Based Derivatives Suggestions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ¯ TPO-Based Derivatives Suggestions</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ’¡</span>
                <button onclick="loadDerivativesSuggestions()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-left: 10px;">
                    ğŸ”„ Refresh Suggestions
                </button>
            </div>
            <div id="derivativesSuggestionsContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Suggestions" to load TPO-based trading suggestions
                </div>
            </div>
        </div>

        <!-- Futures Order Flow Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ“Š Nifty 50 Futures Order Flow - latest 2 ticks (Last Trading Day)</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ“ˆ</span>
            </div>
            <div class="tpo-chart-container" style="height: 200px; overflow-y: auto;">
                <table id="futuresOrderFlowTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Time</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Side</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Quantity</th>
                            <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Orders</th>
                        </tr>
                    </thead>
                    <tbody id="futuresOrderFlowBody">
                        <tr>
                            <td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading order flow data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Current Positions Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“Š Active Positions</h3>
                <span class="card-icon">ğŸ“ˆ</span>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Timestamp</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Type</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Symbol</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Product</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Exchange</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Avg. Price</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading positions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        </div>
        <!-- End Live Market Tab Content -->

        <!-- Stocks Tab Content -->
        <div id="gainers-losers-tab" class="tab-content">
            <!-- Gainers and Losers Section - Side by Side -->
            <div style="margin-bottom: 20px; display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
                <!-- Top Gainers -->
                <div class="card" style="flex: 1; min-width: 0;">
                    <div class="card-header" style="justify-content: space-between; background-color: #28a745; color: white; padding: 10px 15px;">
                        <h3 class="card-title" style="color: white; margin: 0; font-size: 16px;">ğŸ“ˆ Top 10 Gainers (Last Trading Day)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Rank</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Symbol</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Chart</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Prev Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Curr Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Change %</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Prophet Predicted Gain %</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Prophet Confidence</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Prediction Days</th>
                                </tr>
                            </thead>
                            <tbody id="gainersTableBody">
                                <tr>
                                    <td colspan="9" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Losers -->
                <div class="card" style="flex: 1; min-width: 0;">
                    <div class="card-header" style="justify-content: space-between; background-color: #dc3545; color: white; padding: 10px 15px;">
                        <h3 class="card-title" style="color: white; margin: 0; font-size: 16px;">ğŸ“‰ Top 10 Losers (Last Trading Day)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Rank</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Symbol</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Chart</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Prev Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Curr Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Change %</th>
                                </tr>
                            </thead>
                            <tbody id="losersTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Swing Trade Recommendations Section -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="background-color: #6f42c1; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title" style="color: white;">ğŸ¯ Swing Trade Recommendations </h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="swingTradePatternFilter" onchange="filterSwingTrades()" style="padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                                <option value="">All Patterns</option>
                                <option value="Pullback to Support">Pullback to Support</option>
                                <option value="Breakout from Consolidation">Breakout from Consolidation</option>
                                <option value="Golden Cross">Golden Cross</option>
                                <option value="Oversold Bounce">Oversold Bounce</option>
                                <option value="MACD Bullish Crossover">MACD Bullish Crossover</option>
                                <option value="Head and Shoulders">Head and Shoulders</option>
                                <option value="Double Top">Double Top</option>
                                <option value="Double Bottom">Double Bottom</option>
                                <option value="Cup and Handle">Cup and Handle</option>
                                <option value="Flag (Bullish)">Flag (Bullish)</option>
                                <option value="Flag (Bearish)">Flag (Bearish)</option>
                                <option value="Ascending Triangle">Ascending Triangle</option>
                                <option value="Descending Triangle">Descending Triangle</option>
                                <option value="Symmetrical Triangle (Bullish)">Symmetrical Triangle (Bullish)</option>
                                <option value="Symmetrical Triangle (Bearish)">Symmetrical Triangle (Bearish)</option>
                                <option value="Rounding Bottom">Rounding Bottom</option>
                                <option value="Bullish Engulfing">Bullish Engulfing</option>
                                <option value="Bearish Engulfing">Bearish Engulfing</option>
                            </select>
                            <select id="swingTradeGainFilter" onchange="filterSwingTrades()" style="padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                                <option value="">All Gains</option>
                                <option value="10-15">10-15%</option>
                                <option value="15-20">15-20%</option>
                                <option value="20+">20%+</option>
                            </select>
                            <button onclick="loadSwingTrades()" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                                ğŸ”„ Refresh
                            </button>
                            <button onclick="downloadSwingTrades('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                                ğŸ“¥ Excel
                            </button>
                            <button onclick="downloadSwingTrades('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                                ğŸ“¥ PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px;">
                        <strong>Filtering Criteria:</strong>
                        <span id="swingTradeFilterCriteria" style="margin-left: 10px; color: #666;">Loading...</span>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th onclick="sortSwingTrades('symbol')" style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none;" title="Click to sort by Symbol">
                                        Symbol <span id="sort-symbol-icon"></span>
                                    </th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Sparkline (last 90D)</th>
                                    <th onclick="sortSwingTrades('pattern')" style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none;" title="Click to sort by Pattern">
                                        Pattern(s) <span id="sort-pattern-icon"></span>
                                    </th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">Entry</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">Target</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">Stop Loss</th>
                                    <th onclick="sortSwingTrades('gain')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none;" title="Click to sort by Gain %">
                                        Gain % <span id="sort-gain-icon"></span>
                                    </th>
                                    <th onclick="sortSwingTrades('confidence')" style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none;" title="Click to sort by Confidence">
                                        Confidence <span id="sort-confidence-icon"></span>
                                    </th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">R/R</th>
                                    <th onclick="sortSwingTrades('ghost')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none; color: #87CEEB;" title="Click to sort by Ghost Prediction">
                                        Ghost Prediction (60D) <span id="sort-ghost-icon"></span>
                                    </th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;" title="Mean Absolute Percentage Error">MAPE (%)</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;" title="Root Mean Squared Error">RMSE</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Days</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 14px;">Rationale</th>
                                </tr>
                            </thead>
                            <tbody id="swingTradesTableBody">
                                <tr>
                                    <td colspan="14" style="padding: 15px; text-align: center; color: #666; font-size: 14px;">Click Refresh to load swing trade recommendations</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="swingTradePagination"></div>
                    <div id="swingTradesStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
            
            <!-- Top 20 Potential Gainers Section -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="background-color: #28a745; color: white;">
                    <h3 class="card-title" style="color: white;">ğŸš€ Top 20 Potential Gainers</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="color: white; font-size: 12px; margin-right: 5px;">Prediction Days:</label>
                        <select id="predictionDaysSelect" style="padding: 4px 8px; font-size: 12px; border: none; border-radius: 4px;">
                            <option value="30">30 Days</option>
                            <option value="60">60 Days</option>
                            <option value="90">90 Days</option>
                            <option value="180">180 Days</option>
                        </select>
                        <button onclick="generateProphetPredictionsWithDays()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #17a2b8; color: white; border: none;">
                            âš¡ Generate Predictions
                        </button>
                        <button onclick="loadTopGainers()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: white; color: #28a745; border: none;">
                            ğŸ”„ Refresh
                        </button>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div id="topGainersContainer" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Rank</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Symbol</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Sparkline (last 30D)</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Current Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Ghost Prediction (60D) Target</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Ghost Predicted Gain %</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Ghost Confidence</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Days in Leaderboard</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Prediction Days</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;" title="Mean Absolute Percentage Error">MAPE (%)</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;" title="Root Mean Squared Error">RMSE</th>
                                </tr>
                            </thead>
                            <tbody id="topGainersTableBody">
                                <tr>
                                    <td colspan="11" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Click Refresh to load top gainers</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="topGainersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; padding: 10px;"></div>
                    <div id="topGainersStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
            
            <!-- Stock Symbol Search Section -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="background-color: #17a2b8; color: white;">
                    <h3 class="card-title" style="color: white;">ğŸ” Search Stock Prediction</h3>
                </div>
                <div style="padding: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label style="font-size: 12px; font-weight: 600; margin-right: 5px;">Symbol:</label>
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="stockSymbolSearch" placeholder="Enter stock symbol (e.g., RELIANCE, TCS, INFY)" 
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                   oninput="handleSymbolSearch(this.value)" 
                                   onkeydown="handleSymbolSearchKeydown(event)"
                                   autocomplete="off">
                            <div id="symbolSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                        </div>
                        <button onclick="searchStockSymbol()" class="btn" style="padding: 8px 16px; font-size: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ” Search
                        </button>
                        <button onclick="clearStockSearch()" class="btn" style="padding: 8px 16px; font-size: 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            âœ• Clear
                        </button>
                    </div>
                    <div id="stockSearchContainer" style="display: none;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left; font-weight: 600; font-size: 12px;">Symbol</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Sparkline (last 30D)</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Current Price</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Ghost Prediction (60D) Target</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 12px;">Ghost Predicted Gain %</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Ghost Confidence</th>
                                    <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 12px;">Prediction Days</th>
                                </tr>
                            </thead>
                            <tbody id="stockSearchTableBody">
                            </tbody>
                        </table>
                        <div id="stockSearchStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Stocks Tab Content -->

        <!-- Utilities Tab Content -->
        <div id="utilities-tab" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Export Data Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="background-color: #28a745; color: white;">
                        <h3 class="card-title" style="color: white;">ğŸ“¤ Export Data</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Type of Data (Table Name):</label>
                            <select id="exportTableName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="">-- Select Table --</option>
                                <option value="ticks">ticks</option>
                                <option value="futures_ticks">futures_ticks</option>
                                <option value="options_ticks">options_ticks</option>
                                <option value="holdings">holdings</option>
                                <option value="mf_holdings">mf_holdings</option>
                                <option value="positions">positions</option>
                                <option value="orders">orders</option>
                                <option value="trades">trades</option>
                                <option value="market_structure">market_structure</option>
                                <option value="rt_intraday_price">rt_intraday_price</option>
                                <option value="iv_history">iv_history</option>
                                <option value="market_depth">market_depth</option>
                                <option value="futures_tick_depth">futures_tick_depth</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">From Date:</label>
                                <input type="date" id="exportFromDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">To Date:</label>
                                <input type="date" id="exportToDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Columns (Leave empty for all columns):</label>
                            <input type="text" id="exportColumns" placeholder="e.g., id,instrument_token,last_price (comma-separated)" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <small style="color: #666; font-size: 11px;">Optional: Specify columns to export, separated by commas</small>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Export Format:</label>
                            <select id="exportFormat" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel (XLSX)</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        
                        <button onclick="exportData()" class="btn" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            ğŸ“¥ Export Data
                        </button>
                        
                        <div id="exportStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
                
                <!-- Import Data Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="background-color: #007bff; color: white;">
                        <h3 class="card-title" style="color: white;">ğŸ“¥ Import Data</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Type of Data (Table Name):</label>
                            <select id="importTableName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="">-- Select Table --</option>
                                <option value="ticks">ticks</option>
                                <option value="futures_ticks">futures_ticks</option>
                                <option value="options_ticks">options_ticks</option>
                                <option value="holdings">holdings</option>
                                <option value="mf_holdings">mf_holdings</option>
                                <option value="positions">positions</option>
                                <option value="orders">orders</option>
                                <option value="trades">trades</option>
                                <option value="market_structure">market_structure</option>
                                <option value="rt_intraday_price">rt_intraday_price</option>
                                <option value="iv_history">iv_history</option>
                                <option value="market_depth">market_depth</option>
                                <option value="futures_tick_depth">futures_tick_depth</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">CSV File:</label>
                            <input type="file" id="importCsvFile" accept=".csv" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <small style="color: #666; font-size: 11px;">Select a CSV file to import. On conflict, new data will be skipped (not updated).</small>
                        </div>
                        
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; font-weight: 600; color: #856404; margin-bottom: 5px;">âš ï¸ Import Behavior:</div>
                            <div style="font-size: 10px; color: #856404;">
                                â€¢ On conflict (duplicate rows), new data will be <strong>skipped</strong> (not updated)<br>
                                â€¢ CSV header row must match table column names<br>
                                â€¢ Data types must match table schema
                            </div>
                        </div>
                        
                        <button onclick="importData()" class="btn" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            ğŸ“¤ Import Data
                        </button>
                        
                        <div id="importStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                        
                        <div id="importPreview" style="margin-top: 15px; display: none;">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Preview (first 5 rows):</div>
                            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; font-size: 11px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Refresh Stock Price Data Section -->
            <div class="card" style="margin-bottom: 20px; margin-top: 20px;">
                <div class="card-header" style="background-color: #17a2b8; color: white;">
                    <h3 class="card-title" style="color: white;">ğŸ”„ Refresh Stock Price Data</h3>
                </div>
                <div style="padding: 15px;">
                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            This will fetch the latest stock price data from Yahoo Finance and update the <code>Database</code> table. 
                            The process will automatically determine the date range based on existing data.
                        </p>
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #d1ecf1; border-radius: 4px; border-left: 3px solid #17a2b8;">
                            <div style="font-size: 11px; font-weight: 600; color: #0c5460; margin-bottom: 5px;">â„¹ï¸ Note:</div>
                            <div style="font-size: 10px; color: #0c5460;">
                                â€¢ This process may take several minutes depending on the number of stocks<br>
                                â€¢ The system will automatically skip stocks that already have the latest data<br>
                                â€¢ Existing records will be updated if new data is available
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="refreshStockPrices()" id="refreshStockPricesBtn" class="btn" style="width: 100%; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        ğŸ”„ Refresh Stock Prices
                    </button>
                    
                    <div id="refreshStockPricesStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
                
                <!-- Add New Stock Section -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="background-color: #17a2b8; color: white;">
                        <h3 class="card-title" style="color: white;">â• Add New Stock</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Stock Symbol (e.g., E2E):</label>
                            <input type="text" id="newStockSymbol" placeholder="Enter stock symbol" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-transform: uppercase;"
                                   maxlength="10">
                            <small style="color: #666; font-size: 11px;">Enter the stock symbol as it appears in NSE/BSE</small>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Yahoo Finance Code (e.g., E2E.NS):</label>
                            <input type="text" id="newStockYahooCode" placeholder="Enter Yahoo Finance code (e.g., E2E.NS)" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <small style="color: #666; font-size: 11px;">Yahoo Finance code format: SYMBOL.NS for NSE, SYMBOL.BO for BSE. You can find this on Yahoo Finance.</small>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Country:</label>
                            <select id="newStockCountry" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="IN">India (IN)</option>
                                <option value="">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Sector Code (Optional):</label>
                            <input type="text" id="newStockSector" placeholder="Enter sector code (e.g., PHARMA, IT, etc.)" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 4px; border-left: 3px solid #0066cc;">
                            <div style="font-size: 11px; color: #333; font-weight: 600; margin-bottom: 5px;">ğŸ“‹ What will happen:</div>
                            <ul style="font-size: 11px; color: #666; margin: 0; padding-left: 20px;">
                                <li>Stock will be added to master_scrips table</li>
                                <li>Historical price data for last 6 months will be fetched from Yahoo Finance</li>
                                <li>Price data will be inserted into rt_intraday_price table</li>
                                <li>This process may take a few minutes depending on data availability</li>
                            </ul>
                        </div>
                        
                        <button onclick="addNewStock()" id="addNewStockBtn" class="btn" style="width: 100%; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            â• Add Stock & Fetch Historical Data (6 Months)
                        </button>
                        
                        <div id="addStockStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
                
                <!-- Start KiteWS Section -->
                <div class="card" style="margin-bottom: 20px; margin-top: 20px;">
                    <div class="card-header" style="background-color: #6f42c1; color: white;">
                        <h3 class="card-title" style="color: white;">ğŸ“¡ Start Kite WebSocket (KiteWS)</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                This will start the Kite WebSocket connection to receive real-time tick data. 
                                The process will automatically run until 3:30 PM IST.
                            </p>
                            <div style="margin-bottom: 10px; padding: 10px; background-color: #e7d5ff; border-radius: 4px; border-left: 3px solid #6f42c1;">
                                <div style="font-size: 11px; font-weight: 600; color: #4a2c7a; margin-bottom: 5px;">â„¹ï¸ Note:</div>
                                <div style="font-size: 10px; color: #4a2c7a;">
                                    â€¢ KiteWS will run until 3:30 PM IST and then automatically stop<br>
                                    â€¢ If KiteWS is already running, you'll see a message indicating it's already active<br>
                                    â€¢ This is useful when the crontab doesn't start KiteWS automatically<br>
                                    â€¢ Tick data will be saved to the database in real-time
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="startKiteWS()" id="startKiteWSBtn" class="btn" style="width: 100%; padding: 10px; background-color: #6f42c1; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            ğŸš€ Start KiteWS (Runs until 3:30 PM IST)
                        </button>
                        
                        <div id="startKiteWSStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
                
                <!-- Cron Utilities Section -->
                <div class="card" style="margin-bottom: 20px; margin-top: 20px;">
                    <div class="card-header" style="background-color: #fd7e14; color: white;">
                        <h3 class="card-title" style="color: white;">âš™ï¸ Cron Utilities</h3>
                    </div>
                    <div style="padding: 15px;">
                        <div style="margin-bottom: 15px;">
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                Manual triggers for utilities that run automatically via crontab. Use these buttons if the crontab doesn't run them automatically.
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <button onclick="refreshHoldings()" id="refreshHoldingsBtn" class="btn" style="width: 100%; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ğŸ”„ Refresh Holdings
                            </button>
                            <button onclick="calculateTPO()" id="calculateTPOBtn" class="btn" style="width: 100%; padding: 8px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ğŸ“Š Calculate TPO
                            </button>
                            <button onclick="fetchOptions()" id="fetchOptionsBtn" class="btn" style="width: 100%; padding: 8px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ğŸ“ˆ Fetch Options
                            </button>
                            <button onclick="refreshSwingTrades()" id="refreshSwingTradesBtn" class="btn" style="width: 100%; padding: 8px; background-color: #20c997; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ğŸ¯ Refresh Swing Trades
                            </button>
                            <button onclick="refreshMFNAV()" id="refreshMFNAVBtn" class="btn" style="width: 100%; padding: 8px; background-color: #e83e8c; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ğŸ’° Refresh MF NAV
                            </button>
                        </div>
                        
                        <div id="cronUtilitiesStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Utilities Tab Content -->

        <!-- Holdings Tab Content -->
        <div id="holdings-tab" class="tab-content">
        {% if show_holdings %}
        <!-- Today's P&L Summary Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">ğŸ“Š P&L Summary</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadPnlSummary('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as Excel">
                        ğŸ“¥ Excel
                    </button>
                    <button onclick="downloadPnlSummary('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download Summary + Holdings as PDF">
                        ğŸ“¥ PDF
                    </button>
                    <span class="card-icon">ğŸ’°</span>
                </div>
            </div>
            <div style="padding: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Category</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Today's P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Overall P&L</th>
                        </tr>
                    </thead>
                    <tbody id="pnlSummaryTableBody">
                        <tr>
                            <td colspan="3" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading P&L summary...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Portfolio Value Chart Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ˆ Total Portfolio Value</h3>
                <span class="card-icon">ğŸ“Š</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label for="portfolioDaysSelector" style="margin-right: 10px; font-size: 12px;">Days:</label>
                    <select id="portfolioDaysSelector" onchange="loadPortfolioChart(this.value)" style="padding: 5px 10px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="7">7 Days</option>
                        <option value="30" selected>30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">180 Days</option>
                        <option value="365">1 Year</option>
                    </select>
                </div>
                <canvas id="portfolioChart" style="max-height: 400px;"></canvas>
            </div>
        </div>

        <!-- Portfolio Hedging Recommendations Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="padding: 15px 25px;">
                <h3 class="card-title" style="font-size: 16px;">ğŸ›¡ï¸ Portfolio Hedging Recommendations</h3>
                <span class="card-icon" style="font-size: 20px;">ğŸ”’</span>
                <button onclick="loadPortfolioHedgeAnalysis()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-left: 10px;">
                    ğŸ”„ Refresh Analysis
                </button>
                <select id="hedgeRatioSelector" onchange="loadPortfolioHedgeAnalysis()" style="padding: 5px 10px; font-size: 12px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="0.25">25% Hedge</option>
                    <option value="0.5" selected>50% Hedge</option>
                    <option value="0.75">75% Hedge</option>
                    <option value="1.0">100% Hedge</option>
                </select>
                <select id="strategyTypeSelector" onchange="loadPortfolioHedgeAnalysis()" style="padding: 5px 10px; font-size: 12px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" selected>All Strategies</option>
                    <option value="futures">Futures</option>
                    <option value="puts">Protective Puts</option>
                    <option value="calls">Covered Calls</option>
                    <option value="collars">Collars</option>
                </select>
            </div>
            <div id="portfolioHedgeContainer" style="padding: 15px;">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Click "Refresh Analysis" to load portfolio hedge recommendations
                </div>
            </div>
        </div>

        <!-- Current Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">ğŸ’¼ Current Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        ğŸ“¥ Excel
                    </button>
                    <button onclick="downloadHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        ğŸ“¥ PDF
                    </button>
                </div>
            </div>
            <div style="padding: 12px; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="holdingsSearch" style="font-weight: 600; font-size: 13px;">Search Stock:</label>
                    <input type="text" id="holdingsSearch" placeholder="Enter stock symbol..." 
                           style="flex: 1; max-width: 300px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                           onkeypress="if(event.key === 'Enter') { event.preventDefault(); searchHoldings(); }">
                    <button onclick="searchHoldings()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Search holdings">
                        ğŸ” Search
                    </button>
                    <button onclick="clearHoldingsSearch()" class="btn" style="padding: 6px 12px; font-size: 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Clear search">
                        âœ• Clear
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead id="holdingsTableHeader">
                        <tr style="background-color: #f8f9fa;">
                            <th onclick="sortHoldings('trading_symbol')" style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_trading_symbol">Symbol â†•</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Sparkline (last 30D)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Pattern</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">Qty</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">Avg. Price</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;">LTP</th>
                            <th onclick="sortHoldings('invested_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_invested_amount">Invested Amount â†•</th>
                            <th onclick="sortHoldings('current_amount')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_current_amount">Current Amount â†•</th>
                            <th onclick="sortHoldings('pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_pnl">Total P&L â†•</th>
                            <th onclick="sortHoldings('today_pnl')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_today_pnl">Today's P&L â†•</th>
                            <th onclick="sortHoldings('prophet_prediction_pct')" style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; cursor: pointer; user-select: none; font-size: 14px;" id="header_prophet_prediction_pct">Ghost Prediction (60D) â†•</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Confidence</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;" title="Mean Absolute Percentage Error">MAPE (%)</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 14px;" title="Root Mean Squared Error">RMSE</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; font-size: 14px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTableBody">
                        {% for holding in holdings_info.holdings %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; border: 1px solid #ddd; font-size: 14px;">
                                <strong>{{ holding.trading_symbol }}</strong>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                <canvas id="sparkline-{{ holding.trading_symbol }}" width="120" height="40" onclick="showCandlestick('{{ holding.trading_symbol }}')" style="cursor: pointer;"></canvas>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 12px; max-width: 150px; word-wrap: break-word;">
                                <span id="pattern-{{ holding.trading_symbol }}" style="color: #666;">Loading...</span>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                {{ holding.quantity }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                â‚¹{{ "%.2f"|format(holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                â‚¹{{ "%.2f"|format(holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                â‚¹{{ "%.2f"|format(holding.quantity * holding.average_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                â‚¹{{ "%.2f"|format(holding.quantity * holding.last_price) }}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                {% if holding.pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold; font-size: 14px;">â‚¹{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 12px; color: #28a745;">{{ "+%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold; font-size: 14px;">â‚¹{{ "%.2f"|format(holding.pnl) }}</div>
                                    <div style="font-size: 12px; color: #dc3545;">{{ "%.2f"|format(holding.pnl_pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                {%- if holding.today_pnl is defined -%}
                                    {% set today_pnl = holding.today_pnl %}
                                {%- else -%}
                                    {% set today_pnl = 0 %}
                                {%- endif -%}
                                {%- if holding.pct_change is defined -%}
                                    {% set pct_change = holding.pct_change %}
                                {%- else -%}
                                    {% set pct_change = 0 %}
                                {%- endif -%}
                                {% if today_pnl >= 0 %}
                                    <div style="color: #28a745; font-weight: bold; font-size: 14px;">â‚¹{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 12px; color: #28a745;">{{ "+%.2f"|format(pct_change) }}%</div>
                                {% else %}
                                    <div style="color: #dc3545; font-weight: bold; font-size: 14px;">â‚¹{{ "%.2f"|format(today_pnl) }}</div>
                                    <div style="font-size: 12px; color: #dc3545;">{{ "%.2f"|format(pct_change) }}%</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                {% if holding.prophet_prediction_pct is not none and holding.prophet_prediction_pct is defined %}
                                    {% set pred = holding.prophet_prediction_pct %}
                                    {% if pred is not none %}
                                        {% if pred >= 0 %}
                                            <div style="color: #28a745; font-weight: bold;">+{{ "%.2f"|format(pred) }}%</div>
                                        {% else %}
                                            <div style="color: #dc3545; font-weight: bold;">{{ "%.2f"|format(pred) }}%</div>
                                        {% endif %}
                                        {% if holding.prediction_days is defined and holding.prediction_days is not none %}
                                            {% if holding.prediction_days == 60 %}
                                                <div style="font-size: 11px; color: #666;">60D</div>
                                            {% else %}
                                                <div style="font-size: 11px; color: #666;">60D - N/A</div>
                                            {% endif %}
                                        {% else %}
                                            <div style="font-size: 11px; color: #666;">60D - N/A</div>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #999; font-size: 12px;">N/A</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #999; font-size: 12px;">N/A</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 13px;">
                                {% if holding.prophet_confidence is not none and holding.prophet_confidence is defined %}
                                    {% set conf = holding.prophet_confidence %}
                                    {% if conf is not none %}
                                        {% if conf >= 80 %}
                                            <span style="color: #28a745; font-weight: bold;">{{ "%.0f"|format(conf) }}%</span>
                                        {% elif conf >= 70 %}
                                            <span style="color: #ffc107; font-weight: bold;">{{ "%.0f"|format(conf) }}%</span>
                                        {% else %}
                                            <span style="color: #dc3545; font-weight: bold;">{{ "%.0f"|format(conf) }}%</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #999; font-size: 12px;">N/A</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #999; font-size: 12px;">N/A</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                {% if holding.prophet_cv_mape is not none and holding.prophet_cv_mape is defined %}
                                    {% set mape = holding.prophet_cv_mape %}
                                    {% if mape is not none and mape != float('inf') %}
                                        {% if mape < 50 %}
                                            <span style="color: #28a745;">{{ "%.2f"|format(mape) }}%</span>
                                        {% elif mape < 100 %}
                                            <span style="color: #ffc107;">{{ "%.2f"|format(mape) }}%</span>
                                        {% else %}
                                            <span style="color: #999;">{{ "%.2f"|format(mape) }}%</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #999; font-size: 12px;">N/A</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #999; font-size: 12px;">N/A</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                {% if holding.prophet_cv_rmse is not none and holding.prophet_cv_rmse is defined %}
                                    {% set rmse = holding.prophet_cv_rmse %}
                                    {% if rmse is not none and rmse != float('inf') %}
                                        <span style="color: #666;">{{ "%.2f"|format(rmse) }}</span>
                                    {% else %}
                                        <span style="color: #999; font-size: 12px;">N/A</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #999; font-size: 12px;">N/A</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-success" style="padding: 4px 8px; font-size: 13px;" onclick="buyMore('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}')">
                                        Buy More
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 13px;" onclick="sellSome('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell Some
                                    </button>
                                    <button class="btn" style="padding: 4px 8px; font-size: 13px; background-color: #dc3545; color: white;" onclick="sellAll('{{ holding.instrument_token }}', '{{ holding.trading_symbol }}', {{ holding.quantity }})">
                                        Sell All
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div id="holdingsPagination" style="display: flex; justify-content: center; align-items: center; padding: 20px; border-top: 1px solid #eee;"></div>
        </div>

        <!-- Mutual Fund Holdings Section -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="justify-content: space-between;">
                <h3 class="card-title">ğŸ“Š Mutual Fund Holdings</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadMFHoldings('excel')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="Download as Excel">
                        ğŸ“¥ Excel
                    </button>
                    <button onclick="downloadMFHoldings('pdf')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" title="Download as PDF">
                        ğŸ“¥ PDF
                    </button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600;">MF Name</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Invested Amount</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Current Value</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">P&L</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Net Change %</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Day Change %</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600;">Benchmark</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">1M vs BM</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">3M vs BM</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">6M vs BM</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">1Y vs BM</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Alpha</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: 600;">Beta</th>
                        </tr>
                    </thead>
                    <tbody id="mfHoldingsTableBody">
                        <tr>
                            <td colspan="13" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">Loading MF holdings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>  <!-- Close container div -->

    <!-- Load TPO chart renderer -->
    <script src="/static/tpo-charts.js"></script>
    
    <script>
        // IST market-hours helpers
        function getISTNow() {
            try {
                const fmt = new Intl.DateTimeFormat('en-GB', {
                    timeZone: 'Asia/Kolkata',
                    hour12: false,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
                const parts = fmt.formatToParts(new Date());
                const get = k => parts.find(p => p.type === k).value;
                return {
                    year: parseInt(get('year'), 10),
                    month: parseInt(get('month'), 10),
                    day: parseInt(get('day'), 10),
                    hour: parseInt(get('hour'), 10),
                    minute: parseInt(get('minute'), 10)
                };
            } catch (e) {
                const d = new Date();
                return { year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate(), hour: d.getHours(), minute: d.getMinutes() };
            }
        }

        function isWeekendIST() {
            try {
                const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Kolkata', weekday: 'short' });
                const wd = fmt.format(new Date());
                return wd === 'Sat' || wd === 'Sun';
            } catch (e) {
                const d = new Date();
                const wd = d.getDay();
                return wd === 0 || wd === 6;
            }
        }

        function isMarketClosedIST() {
            if (isWeekendIST()) return true;
            const t = getISTNow();
            if (t.hour > 15) return true;
            if (t.hour === 15 && t.minute >= 30) return true;
            return false;
        }
        
        // Track which tabs have been loaded
        const TabLoadTracker = {
            loaded: {
                'live-market': false,
                'holdings': false,
                'gainers-losers': false,
                'utilities': false
            },
            
            markLoaded(tabName) {
                this.loaded[tabName] = true;
            },
            
            isLoaded(tabName) {
                return this.loaded[tabName] || false;
            }
        };
        
        // Global variables for market bias analysis
        let currentAnalysisDate = null;
        let marketBiasData = null;
        let refreshInterval = 30000; // Default 10 seconds
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = 10;
        
        // Initialize refresh system
        function initializeRefreshSystem() {
            // Check if countdown elements exist before initializing
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, delaying refresh system initialization');
                // Retry after a short delay
                setTimeout(initializeRefreshSystem, 100);
                return;
            }
            
            // Start the refresh timer
            startRefreshTimer();
            
            // Start countdown display
            startCountdown();
        }
        
        // Start refresh timer
        function startRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            if (refreshInterval > 0) {
                refreshTimer = setInterval(function() {
                    refreshDashboardData();
                }, refreshInterval);
            }
        }
        
        // Start countdown display
        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
                
                countdownTimer = setInterval(function() {
                    countdownValue--;
                    updateCountdownDisplay();
                    
                    if (countdownValue <= 0) {
                        countdownValue = Math.floor(refreshInterval / 1000);
                    }
                }, 1000);
            } else {
                updateCountdownDisplay();
            }
        }
        
        // Update countdown display
        function updateCountdownDisplay() {
            const countdownElement = document.getElementById('countdown');
            const refreshStatusElement = document.getElementById('refreshStatus');
            
            // Check if elements exist before trying to update them
            if (!countdownElement || !refreshStatusElement) {
                console.warn('Countdown elements not found, skipping update');
                return;
            }
            
            if (refreshInterval === 0) {
                countdownElement.textContent = 'Manual';
                refreshStatusElement.textContent = 'Auto refresh disabled';
            } else {
                countdownElement.textContent = countdownValue;
                refreshStatusElement.textContent = `Next refresh in: ${countdownValue}s`;
            }
        }
        
        // Refresh dashboard data
        function refreshDashboardData() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    // Update status indicators
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                });
            
            // Update margin data
            if (window.tpoChartRenderer && !isMarketClosedIST()) {
                window.tpoChartRenderer.loadMarginData();
            }
            
            // Refresh futures data
            fetch('/api/refresh_futures', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Futures data refreshed: ${data.fetched_count}/${data.total_symbols} symbols`);
                    } else {
                        console.error('Error refreshing futures data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error refreshing futures data:', error);
                });
            
            // Update market bias analysis and futures order flow
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            
            // Note: Derivatives suggestions refresh separately every minute (see below)
            
            // Only update holdings if enabled AND the holdings tab has been loaded
            {% if show_holdings %}
            if (TabLoadTracker.isLoaded('holdings')) {
                // Refresh holdings table with current page
                if (!isMarketClosedIST() && typeof currentHoldingsPage !== 'undefined') {
                    loadHoldingsPage(currentHoldingsPage);
                }
                
                // Update MF holdings
                if (!isMarketClosedIST()) {
                    loadMFHoldings();
                }
                
                // Update P&L Summary
                if (!isMarketClosedIST()) {
                    loadPnlSummary();
                }
                
                // Update Portfolio Chart
                const daysSelector = document.getElementById('portfolioDaysSelector');
                if (daysSelector && !isMarketClosedIST()) {
                    loadPortfolioChart(daysSelector.value || 30);
                }
            }
            {% endif %}
        }

        function updateStatusIndicators(data) {
            // Update token status
            const tokenIndicator = document.querySelector('.status-item:nth-child(1) .status-indicator');
            tokenIndicator.className = `status-indicator ${data.token_valid ? 'status-online' : 'status-offline'}`;
            
            // Update tick status
            const tickIndicator = document.querySelector('.status-item:nth-child(2) .status-indicator');
            tickIndicator.className = `status-indicator ${data.tick_active ? 'status-online' : 'status-offline'}`;

            // Update Last Update text
            const lastUpdateEl = document.getElementById('lastUpdateText');
            if (lastUpdateEl && data.last_update) {
                lastUpdateEl.textContent = `Last Update: ${data.last_update}`;
            }

            // Update total ticks
            const totalTicksEl = document.getElementById('totalTicksText');
            if (totalTicksEl && typeof data.total_ticks !== 'undefined') {
                totalTicksEl.textContent = `Total Ticks today: ${data.total_ticks}`;
            }
        }
        
        // Load market bias analysis
        function loadMarketBiasAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || null;
            const url = `/api/market_bias${analysisDate ? '?analysis_date=' + analysisDate : ''}`;
            
            // Load market bias data with caching
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading market bias:', data.error);
                        return;
                    }
                    
                    marketBiasData = data.analysis;
                    updateMarketBiasDisplay();
                })
                .catch(error => {
                    console.error('Error fetching market bias:', error);
                });
        }
        
        // Load futures order flow data
        function loadFuturesOrderFlow() {
            fetch('/api/futures_order_flow')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading futures order flow:', data.error);
                        updateFuturesOrderFlowDisplay([]);
                        return;
                    }
                    
                    updateFuturesOrderFlowDisplay(data.order_flow);
                })
                .catch(error => {
                    console.error('Error fetching futures order flow:', error);
                    updateFuturesOrderFlowDisplay([]);
                });
        }
        
        // Update futures order flow display
        function updateFuturesOrderFlowDisplay(orderFlowData) {
            const tbody = document.getElementById('futuresOrderFlowBody');
            const titleElement = document.querySelector('#futuresOrderFlowTable').closest('.card').querySelector('.card-title');
            
            if (!orderFlowData || orderFlowData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No order flow data available for last trading day</td></tr>';
                // Reset title to default
                titleElement.textContent = 'ğŸ“Š Nifty 50 Futures Order Flow (Last Trading Day)';
                return;
            }
            
            let html = '';
            let tradingDate = '';
            
            // Get trading date from first order
            if (orderFlowData.length > 0 && orderFlowData[0].run_date) {
                tradingDate = orderFlowData[0].run_date;
                // Update the title with trading date
                titleElement.textContent = `ğŸ“Š Nifty 50 Futures Order Flow (Last Trading Day - ${tradingDate})`;
            }
            
            orderFlowData.forEach((order, index) => {
                const sideClass = order.side === 'buy' ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                const sideText = order.side === 'buy' ? 'BUY' : 'SELL';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd; font-size: 12px;">${order.timestamp}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; ${sideClass}; font-size: 12px;">${sideText}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.quantity.toLocaleString()}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${order.orders}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Load pre-market analysis
        function loadPremarketAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/premarket_analysis';
            if (analysisDate) {
                url += `?analysis_date=${analysisDate}`;
            }
            
            document.getElementById('premarketAnalysisContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">Loading pre-market analysis...</div>';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        console.error('Error loading pre-market analysis:', data.error || 'Unknown error');
                        let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                            <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">âš ï¸ Missing Data</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                        `;
                        if (data.missing_data && data.missing_data.length > 0) {
                            data.missing_data.forEach(item => {
                                html += `<li style="margin-bottom: 3px;">${item}</li>`;
                            });
                        } else {
                            html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                        }
                        html += `</ul></div>`;
                        document.getElementById('premarketAnalysisContainer').innerHTML = html;
                        return;
                    }
                    
                    updatePremarketAnalysisDisplay(data);
                })
                .catch(error => {
                    console.error('Error fetching pre-market analysis:', error);
                    document.getElementById('premarketAnalysisContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading pre-market analysis</div>';
                });
        }
        
        // Update pre-market analysis display
        function updatePremarketAnalysisDisplay(data) {
            const container = document.getElementById('premarketAnalysisContainer');
            
            if (!data.success || !data.premarket_tpo) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No pre-market data available</div>';
                return;
            }
            
            const pm = data.premarket_tpo || {};
            const prior = data.prior_day_structure || {};
            const overnight = data.overnight_data || {};
            const gap = data.gap_analysis || {};
            const zones = data.key_zones || {};
            const bias = data.market_bias || {};
            const context = data.directional_context || {};
            const auction = data.auction_structure || {};
            
            let html = '';
            
            // Summary Section
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Opening Bias</div>
                        <div style="font-size: 20px; font-weight: bold;">${context.opening_bias || 'Neutral'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Gap Type</div>
                        <div style="font-size: 18px; font-weight: bold;">${gap.gap_type || 'No Gap'}</div>
                        ${gap.gap_size ? `<div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">${gap.gap_size.toFixed(2)} (${gap.gap_percentage.toFixed(2)}%)</div>` : ''}
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Market Bias</div>
                        <div style="font-size: 18px; font-weight: bold;">${bias.bias_direction || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">${bias.bias_strength || 'Weak'}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Inventory Position</div>
                        <div style="font-size: 16px; font-weight: bold;">${gap.inventory_position || 'Neutral'}</div>
                    </div>
                </div>
            `;
            
            // Pre-market TPO Metrics
            html += `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ“Š Pre-Market TPO Metrics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #dc3545;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">POC</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.poc ? pm.poc.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VAH</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.value_area_high ? pm.value_area_high.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #dc3545;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VAL</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.value_area_low ? pm.value_area_low.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">IBH</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.initial_balance_high ? pm.initial_balance_high.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">IBL</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.initial_balance_low ? pm.initial_balance_low.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #6c757d;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">VA Range</div>
                            <div style="font-size: 14px; font-weight: bold;">${pm.session_range ? pm.session_range.toFixed(2) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Prior Day Comparison
            if (prior.poc || prior.vah || prior.val) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ“… Prior Day Comparison</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${prior.poc ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior POC</div><div style="font-size: 14px; font-weight: bold;">${prior.poc.toFixed(2)}</div></div>` : ''}
                            ${prior.vah ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior VAH</div><div style="font-size: 14px; font-weight: bold;">${prior.vah.toFixed(2)}</div></div>` : ''}
                            ${prior.val ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Prior VAL</div><div style="font-size: 14px; font-weight: bold;">${prior.val.toFixed(2)}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Overnight Data
            if (overnight.overnight_high || overnight.overnight_low) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸŒ™ Overnight Data</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${overnight.overnight_high ? `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;"><div style="font-size: 11px; color: #666;">Overnight High</div><div style="font-size: 14px; font-weight: bold;">${overnight.overnight_high.toFixed(2)}</div></div>` : ''}
                            ${overnight.overnight_low ? `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;"><div style="font-size: 11px; color: #666;">Overnight Low</div><div style="font-size: 14px; font-weight: bold;">${overnight.overnight_low.toFixed(2)}</div></div>` : ''}
                            ${gap.gap_description ? `<div style="background: #d1ecf1; padding: 10px; border-radius: 5px; grid-column: 1/-1;"><div style="font-size: 11px; color: #666;">Gap Analysis</div><div style="font-size: 12px; font-weight: bold; margin-top: 5px;">${gap.gap_description}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Key Zones (Support/Resistance)
            if ((zones.support_levels && zones.support_levels.length > 0) || 
                (zones.resistance_levels && zones.resistance_levels.length > 0) ||
                (zones.pivot_levels && zones.pivot_levels.length > 0)) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ¯ Key Zones (Support/Resistance)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Support Levels</div>
                                ${zones.support_levels && zones.support_levels.length > 0 ? 
                                    zones.support_levels.map(level => `
                                        <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                            <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Resistance Levels</div>
                                ${zones.resistance_levels && zones.resistance_levels.length > 0 ? 
                                    zones.resistance_levels.map(level => `
                                        <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                            <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #007bff; margin-bottom: 8px;">Pivot Levels</div>
                                ${zones.pivot_levels && zones.pivot_levels.length > 0 ? 
                                    zones.pivot_levels.map(level => `
                                        <div style="background: #d1ecf1; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #007bff;">
                                            <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">${level.type} - ${level.description}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None identified</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Opening Expectations & Risk Factors
            if ((context.opening_expectations && context.opening_expectations.length > 0) ||
                (context.risk_factors && context.risk_factors.length > 0) ||
                (context.key_levels_to_watch && context.key_levels_to_watch.length > 0)) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ“‹ Directional Context</h4>
                        ${context.opening_expectations && context.opening_expectations.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Opening Expectations:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                    ${context.opening_expectations.map(exp => `<li style="margin-bottom: 3px;">${exp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${context.risk_factors && context.risk_factors.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 5px;">Risk Factors:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #dc3545;">
                                    ${context.risk_factors.map(risk => `<li style="margin-bottom: 3px;">${risk}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${context.key_levels_to_watch && context.key_levels_to_watch.length > 0 ? `
                            <div>
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Key Levels to Watch:</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                    ${context.key_levels_to_watch.map(level => `
                                        <li style="margin-bottom: 3px;">
                                            <strong>â‚¹${level.level.toFixed(2)}</strong> (${level.type}) - ${level.significance}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Auction Structure
            if (auction.poc_strength || auction.balance_quality) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">âš–ï¸ Auction Structure Basis</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${auction.value_area_range ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">VA Range</div><div style="font-size: 14px; font-weight: bold;">${auction.value_area_range.toFixed(2)}</div></div>` : ''}
                            ${auction.poc_strength ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">POC Strength</div><div style="font-size: 14px; font-weight: bold;">${auction.poc_strength}</div></div>` : ''}
                            ${auction.balance_quality ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px;"><div style="font-size: 11px; color: #666;">Balance Quality</div><div style="font-size: 14px; font-weight: bold;">${auction.balance_quality}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Update market bias display
        function updateMarketBiasDisplay() {
            if (!marketBiasData) return;
            
            const comprehensiveBias = marketBiasData.comprehensive_bias;
            const recommendations = marketBiasData.trading_recommendations;
            const longTermAnalysis = marketBiasData.long_term_analysis;
            
            // Update bias metrics
            document.getElementById('biasScore').textContent = comprehensiveBias.bias_score.toFixed(1);
            document.getElementById('biasDirection').textContent = comprehensiveBias.bias_direction;
            document.getElementById('biasStrength').textContent = comprehensiveBias.bias_strength;
            document.getElementById('riskLevel').textContent = recommendations.risk_level;
            
            // Color code the bias direction
            const biasDirectionElement = document.getElementById('biasDirection');
            biasDirectionElement.className = 'metric-value';
            if (comprehensiveBias.bias_direction === 'Bullish') {
                biasDirectionElement.style.color = '#28a745';
            } else if (comprehensiveBias.bias_direction === 'Bearish') {
                biasDirectionElement.style.color = '#dc3545';
            } else {
                biasDirectionElement.style.color = '#6c757d';
            }
            
            // Color code the bias strength
            const biasStrengthElement = document.getElementById('biasStrength');
            biasStrengthElement.className = 'metric-value';
            if (comprehensiveBias.bias_strength === 'Strong') {
                biasStrengthElement.style.color = '#dc3545';
            } else if (comprehensiveBias.bias_strength === 'Moderate') {
                biasStrengthElement.style.color = '#ffc107';
            } else {
                biasStrengthElement.style.color = '#6c757d';
            }
            
            // Update Long-Term TPO Analysis section
            const longTermSection = document.getElementById('longTermTPOSection');
            if (longTermAnalysis && longTermAnalysis.analysis_quality !== 'Insufficient Data') {
                longTermSection.style.display = 'block';
                
                // Update long-term metrics
                document.getElementById('longTermBiasScore').textContent = longTermAnalysis.bias_score.toFixed(1);
                document.getElementById('longTermBiasDirection').textContent = longTermAnalysis.bias_direction;
                document.getElementById('longTermBiasStrength').textContent = longTermAnalysis.bias_strength;
                document.getElementById('longTermDaysAnalyzed').textContent = longTermAnalysis.num_days_analyzed || 'N/A';
                
                // Color code long-term bias direction
                const longTermDirectionElement = document.getElementById('longTermBiasDirection');
                if (longTermAnalysis.bias_direction === 'Bullish') {
                    longTermDirectionElement.style.color = '#28a745';
                } else if (longTermAnalysis.bias_direction === 'Bearish') {
                    longTermDirectionElement.style.color = '#dc3545';
                } else {
                    longTermDirectionElement.style.color = '#6c757d';
                }
                
                // Color code long-term bias strength
                const longTermStrengthElement = document.getElementById('longTermBiasStrength');
                if (longTermAnalysis.bias_strength === 'Strong') {
                    longTermStrengthElement.style.color = '#dc3545';
                } else if (longTermAnalysis.bias_strength === 'Moderate') {
                    longTermStrengthElement.style.color = '#ffc107';
                } else {
                    longTermStrengthElement.style.color = '#6c757d';
                }
                
                // Display long-term TPO factors
                const factorsList = document.getElementById('longTermTPOFactorsList');
                if (longTermAnalysis.bias_factors && longTermAnalysis.bias_factors.length > 0) {
                    factorsList.innerHTML = '<ul style="margin: 0; padding-left: 20px;">' + 
                        longTermAnalysis.bias_factors.map(factor => `<li style="margin-bottom: 5px;">${factor}</li>`).join('') + 
                        '</ul>';
                } else {
                    factorsList.textContent = 'No factors available';
                }
                
                // Display Bear Trap Analysis
                const bearTrapSection = document.getElementById('bearTrapSection');
                const bearTrapDetails = document.getElementById('bearTrapDetails');
                if (longTermAnalysis.bear_trap_analysis && longTermAnalysis.bear_trap_analysis.potential_bear_traps && longTermAnalysis.bear_trap_analysis.potential_bear_traps.length > 0) {
                    bearTrapSection.style.display = 'block';
                    
                    const traps = longTermAnalysis.bear_trap_analysis.potential_bear_traps;
                    let trapHtml = `<div style="margin-bottom: 10px;"><strong>Total Traps Detected: ${traps.length}</strong></div>`;
                    
                    traps.forEach((trap, index) => {
                        const trapDate = new Date(trap.date).toLocaleDateString();
                        const recoveryDate = new Date(trap.recovery_date).toLocaleDateString();
                        const confidenceColor = trap.confidence === 'High' ? '#dc3545' : '#ffc107';
                        
                        trapHtml += `
                            <div style="margin-bottom: 15px; padding: 10px; background-color: #fff; border-radius: 4px; border-left: 3px solid ${confidenceColor};">
                                <div style="font-weight: 600; margin-bottom: 5px; color: #856404;">
                                    Bear Trap #${index + 1} - ${trap.confidence} Confidence
                                </div>
                                <div style="font-size: 10px; line-height: 1.6;">
                                    <div><strong>Date:</strong> ${trapDate}</div>
                                    <div><strong>Support Level:</strong> ${trap.support_level.toFixed(2)} (${trap.support_type})</div>
                                    <div><strong>Breakdown Low:</strong> ${trap.breakdown_low.toFixed(2)}</div>
                                    <div><strong>Breakdown Volume:</strong> ${trap.breakdown_volume.toLocaleString()}</div>
                                    <div><strong>Recovery Date:</strong> ${recoveryDate} (${trap.recovery_bars_later} bar(s) later)</div>
                                    <div><strong>Recovery Close:</strong> ${trap.recovery_close.toFixed(2)}</div>
                                    <div><strong>Bullish Candle:</strong> ${trap.is_bullish_candle ? 'Yes âœ“' : 'No'}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    bearTrapDetails.innerHTML = trapHtml;
                } else {
                    bearTrapSection.style.display = 'none';
                }
            } else {
                longTermSection.style.display = 'none';
            }
        }
        
        
        // Event listeners for analysis date changes
        document.getElementById('analysisDate').addEventListener('change', function() {
            try {
                loadMarketBiasAnalysis();
            } catch (error) {
                console.error('Error in analysis date change:', error);
            }
        });
        
        // Event listener for refresh interval changes
        document.getElementById('refreshInterval').addEventListener('change', function() {
            refreshInterval = parseInt(this.value);
            initializeRefreshSystem();
        });
        
        // Event listener for manual refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            refreshDashboardData();
            // Reset countdown
            if (refreshInterval > 0) {
                countdownValue = Math.floor(refreshInterval / 1000);
                updateCountdownDisplay();
            }
        });
        
        document.getElementById('backtestBtn').addEventListener('click', function() {
            const analysisDate = document.getElementById('analysisDate').value;
            if (!analysisDate) {
                alert('Please select a date for backtesting');
                return;
            }
            
            // Update analysis date via API
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `date=${analysisDate}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'BACKTEST MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-backtest';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
                load5DayTPOChart(); // Reload 5-day TPO chart
            })
            .catch(error => {
                console.error('Error setting analysis date:', error);
            });
        });
        
        document.getElementById('liveBtn').addEventListener('click', function() {
            // Switch to live mode
            fetch('/api/analysis_date', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'date=live'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('modeIndicator').textContent = 'LIVE MODE';
                document.getElementById('modeIndicator').className = 'mode-indicator mode-live';
                document.getElementById('analysisDate').value = '';
                
                // Reload all charts and analysis
                loadMarketBiasAnalysis();
                if (window.tpoChartRenderer) {
                    window.tpoChartRenderer.loadTPOCharts();
                }
                load5DayTPOChart(); // Reload 5-day TPO chart
            })
            .catch(error => {
                console.error('Error switching to live mode:', error);
            });
        });
        
        // Load 5-Day TPO Chart
        function load5DayTPOChart() {
            const chartImage = document.getElementById('tpo5DayChartImage');
            if (!chartImage) return;
            
            chartImage.src = '';
            chartImage.style.display = 'none';
            
            fetch('/api/tpo_5day_chart')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.chart_image) {
                        chartImage.src = data.chart_image;
                        chartImage.style.display = 'block';
                    } else {
                        chartImage.alt = data.error || 'Failed to load 5-day TPO chart';
                        console.error('Error loading 5-day TPO chart:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching 5-day TPO chart:', error);
                    chartImage.alt = 'Error loading chart';
                });
        }
        
        // Global variable for sort settings
        let sortColumn = 'trading_symbol';
        let sortDirection = 'asc';
        let currentHoldingsPage = {% if holdings_info %}{{ holdings_info.page }}{% else %}1{% endif %};
        let holdingsSearchTerm = '';
        
        // Search holdings function
        function searchHoldings() {
            const searchInput = document.getElementById('holdingsSearch');
            holdingsSearchTerm = searchInput ? searchInput.value.trim() : '';
            // Reset to first page when searching
            currentHoldingsPage = 1;
            loadHoldingsPage(1);
        }
        
        // Clear search function
        function clearHoldingsSearch() {
            const searchInput = document.getElementById('holdingsSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            holdingsSearchTerm = '';
            // Reset to first page when clearing
            currentHoldingsPage = 1;
            loadHoldingsPage(1);
        }
        
        // Sort holdings function
        function sortHoldings(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header indicators
            updateSortIndicators();
            
            // Reload first page with new sort
            loadHoldingsPage(1);
        }
        
        // Update sort indicators in table headers
        function updateSortIndicators() {
            const headers = ['header_trading_symbol', 'header_invested_amount', 'header_current_amount', 'header_pnl', 'header_today_pnl', 'header_prophet_prediction_pct'];
            const labelMap = {
                'header_trading_symbol': 'Symbol',
                'header_invested_amount': 'Invested Amount',
                'header_current_amount': 'Current Amount',
                'header_pnl': 'Total P&L',
                'header_today_pnl': 'Today\'s P&L',
                'header_prophet_prediction_pct': 'Ghost Prediction (60D)'
            };
            
            headers.forEach(headerId => {
                const header = document.getElementById(headerId);
                if (header) {
                    const column = headerId.replace('header_', '');
                    if (sortColumn === column) {
                        header.innerHTML = `${labelMap[headerId]} ${sortDirection === 'asc' ? 'â†‘' : 'â†“'}`;
                    } else {
                        header.innerHTML = `${labelMap[headerId]} â†•`;
                    }
                }
            });
        }
        
        // Load holdings page via AJAX
        function loadHoldingsPage(page) {
            // Ensure sortColumn and sortDirection are defined
            const sortBy = sortColumn || 'trading_symbol';
            const sortDir = sortDirection || 'asc';
            // Build URL with search parameter
            let url = `/api/holdings?page=${page}&per_page=10&sort_by=${sortBy}&sort_dir=${sortDir}`;
            if (holdingsSearchTerm) {
                url += `&search=${encodeURIComponent(holdingsSearchTerm)}`;
            }
            // Pass sort parameters to API for server-side sorting
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading holdings:', data.error);
                        return;
                    }
                    
                    // Update table body (data is already sorted by server)
                    const tbody = document.getElementById('holdingsTableBody');
                    tbody.innerHTML = '';
                    
                    data.holdings.forEach(holding => {
                        const pnlClass = holding.pnl >= 0 ? '28a745' : 'dc3545';
                        const pnlColor = holding.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; border: 1px solid #ddd; font-size: 14px;">
                                    <strong>${holding.trading_symbol}</strong>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-ajax-${holding.trading_symbol}" width="120" height="40" onclick="showCandlestick('${holding.trading_symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 12px; max-width: 150px; word-wrap: break-word;">
                                    <span id="pattern-ajax-${holding.trading_symbol}" style="color: #666;">Loading...</span>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    ${holding.quantity}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    â‚¹${holding.average_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    â‚¹${holding.last_price.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    â‚¹${holding.invested_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    â‚¹${holding.current_amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    <div style="${pnlColor} font-size: 14px;">â‚¹${holding.pnl.toFixed(2)}</div>
                                    <div style="font-size: 12px; ${holding.pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pnl_pct_change >= 0 ? '+' : ''}${holding.pnl_pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 14px;">
                                    <div style="${holding.today_pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;'} font-size: 14px;">â‚¹${holding.today_pnl.toFixed(2)}</div>
                                    <div style="font-size: 12px; ${holding.today_pnl >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${holding.pct_change >= 0 ? '+' : ''}${holding.pct_change.toFixed(2)}%</div>
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                    ${holding.prophet_prediction_pct !== null && holding.prophet_prediction_pct !== undefined ? `
                                        ${holding.prophet_prediction_pct >= 0 ? 
                                            `<div style="color: #28a745; font-weight: bold;">+${holding.prophet_prediction_pct.toFixed(2)}%</div>` : 
                                            `<div style="color: #dc3545; font-weight: bold;">${holding.prophet_prediction_pct.toFixed(2)}%</div>`
                                        }
                                        <div style="font-size: 11px; color: #666;">${holding.prediction_days === 60 ? '60D' : '60D - N/A'}</div>
                                    ` : `<span style="color: #999; font-size: 12px;">N/A</span>`}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 13px;">
                                    ${holding.prophet_confidence !== null && holding.prophet_confidence !== undefined ? `
                                        ${holding.prophet_confidence >= 80 ? 
                                            `<span style="color: #28a745; font-weight: bold;">${holding.prophet_confidence.toFixed(0)}%</span>` :
                                            holding.prophet_confidence >= 70 ?
                                            `<span style="color: #ffc107; font-weight: bold;">${holding.prophet_confidence.toFixed(0)}%</span>` :
                                            `<span style="color: #dc3545; font-weight: bold;">${holding.prophet_confidence.toFixed(0)}%</span>`
                                        }
                                    ` : `<span style="color: #999; font-size: 12px;">N/A</span>`}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                    ${holding.prophet_cv_mape !== null && holding.prophet_cv_mape !== undefined && !isNaN(holding.prophet_cv_mape) && holding.prophet_cv_mape !== Infinity ? `
                                        ${holding.prophet_cv_mape < 50 ? 
                                            `<span style="color: #28a745;">${holding.prophet_cv_mape.toFixed(2)}%</span>` : 
                                            holding.prophet_cv_mape < 100 ? 
                                            `<span style="color: #ffc107;">${holding.prophet_cv_mape.toFixed(2)}%</span>` : 
                                            `<span style="color: #999;">${holding.prophet_cv_mape.toFixed(2)}%</span>`
                                        }
                                    ` : '<span style="color: #999; font-size: 12px;">N/A</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                                    ${holding.prophet_cv_rmse !== null && holding.prophet_cv_rmse !== undefined && !isNaN(holding.prophet_cv_rmse) && holding.prophet_cv_rmse !== Infinity ? `
                                        <span style="color: #666;">${holding.prophet_cv_rmse.toFixed(2)}</span>
                                    ` : '<span style="color: #999; font-size: 12px;">N/A</span>'}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                        <button class="btn btn-success" style="padding: 4px 8px; font-size: 13px;" onclick="buyMore('${holding.instrument_token}', '${holding.trading_symbol}')">
                                            Buy More
                                        </button>
                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 13px;" onclick="sellSome('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell Some
                                        </button>
                                        <button class="btn" style="padding: 4px 8px; font-size: 13px; background-color: #dc3545; color: white;" onclick="sellAll('${holding.instrument_token}', '${holding.trading_symbol}', ${holding.quantity})">
                                            Sell All
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Update current page tracker
                    currentHoldingsPage = data.page;
                    
                    // Update pagination controls (similar to Swing Predictions)
                    holdingsTotalCount = data.total_count;
                    holdingsPerPage = data.per_page;
                    updateHoldingsPagination(data.total_count, data.per_page, data.page);
                    
                    // Load sparklines for the displayed holdings using batch API
                    const holdingsSymbols = data.holdings.map(h => h.trading_symbol);
                    loadSparklinesBatch(holdingsSymbols);
                    
                    // Load patterns for holdings
                    loadHoldingsPatterns(data.holdings);
                })
                .catch(error => {
                    console.error('Error fetching holdings:', error);
                });
        }
        
        // Load patterns for holdings
        function loadHoldingsPatterns(holdings) {
            if (!holdings || holdings.length === 0) return;
            
            // Only load patterns if holdings tab has been loaded
            if (!TabLoadTracker.isLoaded('holdings')) {
                return;
            }
            
            // Get unique symbols
            const symbols = [...new Set(holdings.map(h => h.trading_symbol))];
            
            fetch('/api/holdings/patterns')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        console.error('Error loading holdings patterns:', data.error);
                        // Set "None" for all on error
                        symbols.forEach(symbol => {
                            const patternElements = [
                                document.getElementById(`pattern-${symbol}`),
                                document.getElementById(`pattern-ajax-${symbol}`)
                            ];
                            patternElements.forEach(elem => {
                                if (elem) {
                                    elem.textContent = 'Error';
                                    elem.style.color = '#dc3545';
                                }
                            });
                        });
                        return;
                    }
                    
                    const patternsMap = data.patterns || {};
                    
                    // Update pattern display for each holding
                    symbols.forEach(symbol => {
                        const patterns = patternsMap[symbol] || [];
                        const patternElements = [
                            document.getElementById(`pattern-${symbol}`),
                            document.getElementById(`pattern-ajax-${symbol}`)
                        ];
                        
                        patternElements.forEach(elem => {
                            if (elem) {
                                if (patterns.length > 0) {
                                    const patternText = patterns.join(', ');
                                    elem.textContent = patternText;
                                    elem.style.color = '#17a2b8';
                                    elem.title = patternText;
                                } else {
                                    elem.textContent = 'None';
                                    elem.style.color = '#999';
                                }
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading holdings patterns:', error);
                    // Set "Error" for all on error
                    symbols.forEach(symbol => {
                        const patternElements = [
                            document.getElementById(`pattern-${symbol}`),
                            document.getElementById(`pattern-ajax-${symbol}`)
                        ];
                        patternElements.forEach(elem => {
                            if (elem) {
                                elem.textContent = 'Error';
                                elem.style.color = '#dc3545';
                            }
                        });
                    });
                });
        }
        
        // Update Holdings pagination (similar to Swing Predictions)
        function updateHoldingsPagination(totalCount, perPage, currentPage) {
            const paginationDiv = document.getElementById('holdingsPagination');
            if (!paginationDiv) return;
            
            if (totalCount === 0) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalCount / perPage);
            
            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">';
            
            // Previous button
            html += `<button onclick="holdingsGoToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${currentPage === 1 ? '#e9ecef' : 'white'}; color: ${currentPage === 1 ? '#6c757d' : '#007bff'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 13px;">Previous</button>`;
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button onclick="holdingsGoToPage(1)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="holdingsGoToPage(${i})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: ${i === currentPage ? '#007bff' : 'white'}; color: ${i === currentPage ? 'white' : '#007bff'}; cursor: pointer; font-size: 13px; font-weight: ${i === currentPage ? 'bold' : 'normal'};">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
                html += `<button onclick="holdingsGoToPage(${totalPages})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="holdingsGoToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${currentPage === totalPages ? '#e9ecef' : 'white'}; color: ${currentPage === totalPages ? '#6c757d' : '#007bff'}; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 13px;">Next</button>`;
            
            // Page info
            html += `<span style="margin-left: 15px; font-size: 13px; color: #666;">Showing ${((currentPage - 1) * perPage) + 1}-${Math.min(currentPage * perPage, totalCount)} of ${totalCount} results</span>`;
            
            html += '</div>';
            paginationDiv.innerHTML = html;
        }
        
        let holdingsTotalCount = 0;
        let holdingsPerPage = 10;
        
        function holdingsGoToPage(page) {
            const totalPages = Math.ceil(holdingsTotalCount / holdingsPerPage);
            if (page >= 1 && page <= totalPages) {
                loadHoldingsPage(page);
            }
        }
        
        // Track latest timestamp for gainers/losers polling
        let lastKnownLatestTimestamp = null;
        let gainersLosersPollInterval = null;
        
        // Load gainers and losers data
        function loadGainersLosers() {
            // Load gainers without caching
            fetch('/api/gainers', {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Gainers API response:', data);
                    
                    if (data.error) {
                        console.error('Error loading gainers:', data.error);
                        document.getElementById('gainersTableBody').innerHTML = 
                            '<tr><td colspan="9" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Error loading gainers</td></tr>';
                        return;
                    }
                    
                    // Note: We'll update timestamp from the polling endpoint
                    
                    const tbody = document.getElementById('gainersTableBody');
                    tbody.innerHTML = '';
                    
                    console.log('Gainers data check:', {
                        hasGainers: !!data.gainers,
                        gainersType: typeof data.gainers,
                        gainersLength: data.gainers ? data.gainers.length : 'N/A',
                        gainers: data.gainers
                    });
                    
                    if (!data.gainers || data.gainers.length === 0) {
                        console.warn('No gainers data in response:', data);
                        tbody.innerHTML = '<tr><td colspan="9" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">No gainers data available</td></tr>';
                        return;
                    }
                    
                    const symbols = [];
                    data.gainers.forEach((gainer, index) => {
                        try {
                            const symbol = gainer.scrip_id || '-';
                            symbols.push(symbol);
                            const previousPrice = gainer.previous_price || 0;
                            const currentPrice = gainer.current_price || 0;
                            const gain = gainer.gain || 0;
                            
                            // Prophet prediction data
                            const prophetPredictionPct = gainer.prophet_prediction_pct;
                            const prophetConfidence = gainer.prophet_confidence;
                            const predictionDays = gainer.prediction_days;
                            
                            // Format Prophet prediction display
                            const prophetPredictionDisplay = (prophetPredictionPct !== null && prophetPredictionPct !== undefined) 
                                ? (prophetPredictionPct >= 0 
                                    ? `<div style="color: #28a745; font-weight: bold;">+${prophetPredictionPct.toFixed(2)}%</div>` 
                                    : `<div style="color: #dc3545; font-weight: bold;">${prophetPredictionPct.toFixed(2)}%</div>`)
                                : '<span style="color: #999; font-size: 12px;">N/A</span>';
                            
                            const prophetConfidenceDisplay = (prophetConfidence !== null && prophetConfidence !== undefined)
                                ? (prophetConfidence >= 80 
                                    ? `<span style="color: #28a745; font-weight: bold;">${prophetConfidence.toFixed(0)}%</span>`
                                    : prophetConfidence >= 70
                                    ? `<span style="color: #ffc107; font-weight: bold;">${prophetConfidence.toFixed(0)}%</span>`
                                    : `<span style="color: #dc3545; font-weight: bold;">${prophetConfidence.toFixed(0)}%</span>`)
                                : '<span style="color: #999; font-size: 12px;">N/A</span>';
                            
                            const predictionDaysDisplay = (predictionDays !== null && predictionDays !== undefined)
                                ? `${predictionDays} days`
                                : '<span style="color: #999; font-size: 12px;">N/A</span>';
                            
                            const row = `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666; font-size: 12px;">${index + 1}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">
                                        <canvas id="sparkline-gainer-${symbol}" width="100" height="35" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                                    </td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">â‚¹${Number(previousPrice).toFixed(2)}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 12px;">â‚¹${Number(currentPrice).toFixed(2)}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #28a745; font-size: 12px;">
                                        ${gain >= 0 ? '+' : ''}${Number(gain).toFixed(2)}%
                                    </td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${prophetPredictionDisplay}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">${prophetConfidenceDisplay}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">${predictionDaysDisplay}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        } catch (err) {
                            console.error('Error rendering gainer row:', err, gainer);
                        }
                    });
                    
                    // Load sparklines for gainers after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            if (symbol && symbol !== '-') {
                                loadSparkline(`gainer-${symbol}`);
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching gainers:', error);
                        document.getElementById('gainersTableBody').innerHTML = 
                            '<tr><td colspan="9" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Error loading gainers</td></tr>';
                });
            
            // Load losers without caching
            fetch('/api/losers', {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Losers API response:', data);
                    
                    if (data.error) {
                        console.error('Error loading losers:', data.error);
                        document.getElementById('losersTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Error loading losers</td></tr>';
                        return;
                    }
                    
                    // Note: We'll update timestamp from the polling endpoint
                    
                    const tbody = document.getElementById('losersTableBody');
                    tbody.innerHTML = '';
                    
                    console.log('Losers data check:', {
                        hasLosers: !!data.losers,
                        losersType: typeof data.losers,
                        losersLength: data.losers ? data.losers.length : 'N/A',
                        losers: data.losers
                    });
                    
                    if (!data.losers || data.losers.length === 0) {
                        console.warn('No losers data in response:', data);
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">No losers data available</td></tr>';
                        return;
                    }
                    
                    const symbols = [];
                    data.losers.forEach((loser, index) => {
                        try {
                            const symbol = loser.scrip_id || '-';
                            symbols.push(symbol);
                            const previousPrice = loser.previous_price || 0;
                            const currentPrice = loser.current_price || 0;
                            const gain = loser.gain || 0;
                            
                            const row = `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666; font-size: 12px;">${index + 1}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">
                                        <canvas id="sparkline-loser-${symbol}" width="100" height="35" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                                    </td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">â‚¹${Number(previousPrice).toFixed(2)}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; font-size: 12px;">â‚¹${Number(currentPrice).toFixed(2)}</td>
                                    <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #dc3545; font-size: 12px;">
                                        ${Number(gain).toFixed(2)}%
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        } catch (err) {
                            console.error('Error rendering loser row:', err, loser);
                        }
                    });
                    
                    // Load sparklines for losers after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            if (symbol && symbol !== '-') {
                                loadSparkline(`loser-${symbol}`);
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching losers:', error);
                        document.getElementById('losersTableBody').innerHTML = 
                            '<tr><td colspan="6" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Error loading losers</td></tr>';
                });
        }
        
        // Poll for updates in rt_intraday_price and refresh gainers/losers if new data is found
        function startGainersLosersPolling() {
            // Clear existing interval if any
            if (gainersLosersPollInterval) {
                clearInterval(gainersLosersPollInterval);
            }
            
            // Initialize timestamp immediately
            checkForRtIntradayPriceUpdates();
            
            // Poll every 30 seconds for updates
            gainersLosersPollInterval = setInterval(() => {
                checkForRtIntradayPriceUpdates();
            }, 30000); // 30 seconds
        }
        
        function stopGainersLosersPolling() {
            if (gainersLosersPollInterval) {
                clearInterval(gainersLosersPollInterval);
                gainersLosersPollInterval = null;
            }
        }
        
        function checkForRtIntradayPriceUpdates() {
            fetch('/api/rt_intraday_price/latest')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        console.error('Error checking for updates:', data.error);
                        return;
                    }
                    
                    const currentLatestTimestamp = data.latest_timestamp;
                    
                    // Debug logging
                    console.log('Polling check:', {
                        currentTimestamp: currentLatestTimestamp,
                        lastKnownTimestamp: lastKnownLatestTimestamp,
                        areEqual: currentLatestTimestamp === lastKnownLatestTimestamp
                    });
                    
                    // If we have a new latest_timestamp that's different from what we know, refresh
                    if (currentLatestTimestamp && lastKnownLatestTimestamp && currentLatestTimestamp !== lastKnownLatestTimestamp) {
                        console.log(`New data detected! Previous: ${lastKnownLatestTimestamp}, Current: ${currentLatestTimestamp}`);
                        console.log('Refreshing gainers and losers...');
                        loadGainersLosers();
                        // Update the timestamp after refreshing
                        lastKnownLatestTimestamp = currentLatestTimestamp;
                    } else if (currentLatestTimestamp && !lastKnownLatestTimestamp) {
                        // First time loading, store the timestamp
                        console.log('Initializing timestamp:', currentLatestTimestamp);
                        lastKnownLatestTimestamp = currentLatestTimestamp;
                    }
                })
                .catch(error => {
                    console.error('Error checking for rt_intraday_price updates:', error);
                });
        }
        
        // GTT management functions
        // Download functions
        function downloadHoldings(format) {
            const url = format === 'excel' ? '/api/download/holdings/excel' : '/api/download/holdings/pdf';
            window.location.href = url;
        }
        
        function downloadSwingTrades(format) {
            const url = format === 'excel' ? '/api/download/swing_trades/excel' : '/api/download/swing_trades/pdf';
            window.location.href = url;
        }
        
        function downloadMFHoldings(format) {
            const url = format === 'excel' ? '/api/download/mf/excel' : '/api/download/mf/pdf';
            window.location.href = url;
        }
        
        function downloadPnlSummary(format) {
            const url = format === 'excel' ? '/api/download/pnl_summary/excel' : '/api/download/pnl_summary/pdf';
            window.location.href = url;
        }
        
        async function addGTTForAll(stopLossPercent) {
            // Show custom confirmation dialog
            const confirmationText = prompt(
                `âš ï¸ WARNING: This will add GTT orders with ${stopLossPercent}% stop-loss for ALL holdings.\n\n` +
                `This action will affect all your current holdings. Please type "I UNDERSTAND" to continue:`
            );
            
            if (confirmationText !== "I UNDERSTAND") {
                if (confirmationText !== null) {  // User clicked Cancel or typed something else
                    alert('Operation cancelled. You must type "I UNDERSTAND" exactly to proceed.');
                }
                return;
            }
            
            try {
                const response = await fetch(`/api/add_gtt_for_all?stop_loss_percentage=${stopLossPercent}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully added ${data.results.success.length} GTTs\nFailed: ${data.results.failed.length}\nSkipped: ${data.results.skipped.length}`);
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding GTT for all:', error);
                alert('Error adding GTTs. Please try again.');
            }
        }
        
        async function viewAllGTTs() {
            try {
                const response = await fetch('/api/get_all_gtts');
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                if (data.gtts && data.gtts.length > 0) {
                    let message = `Active GTT Orders (${data.gtts.length}):\n\n`;
                    data.gtts.forEach((gtt, index) => {
                        message += `${index + 1}. ${gtt.tradingsymbol || 'N/A'} - Trigger ID: ${gtt.trigger_id || gtt.id}\n`;
                    });
                    alert(message);
                } else {
                    alert('No active GTT orders found.');
                }
            } catch (error) {
                console.error('Error fetching GTTs:', error);
                alert('Error fetching GTTs. Please try again.');
            }
        }
        
        async function cancelGTT(triggerId, tradingSymbol) {
            if (!confirm(`Cancel GTT for ${tradingSymbol}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cancel_gtt/${triggerId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT cancelled successfully for ${tradingSymbol}`);
                    // Reload holdings to update GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to cancel GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling GTT:', error);
                alert('Error cancelling GTT. Please try again.');
            }
        }
        
        async function setGTT(event, instrumentToken, tradingSymbol, quantity) {
            event.preventDefault();
            const triggerInput = event.target.querySelector(`#trigger_price_${instrumentToken}`);
            const triggerPrice = triggerInput.value;
            
            if (!triggerPrice) {
                alert('Please enter a trigger price');
                return;
            }
            
            try {
                const response = await fetch('/api/set_gtt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        instrument_token: instrumentToken,
                        tradingsymbol: tradingSymbol,
                        quantity: quantity,
                        trigger_price: parseFloat(triggerPrice)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`GTT set successfully for ${tradingSymbol}!\nTrigger ID: ${data.trigger_id}`);
                    triggerInput.value = '';
                    // Reload holdings to show updated GTT status
                    loadHoldingsPage(1);
                } else {
                    alert(`Failed to set GTT: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error setting GTT:', error);
                alert('Error setting GTT. Please try again.');
            }
        }
        
        // Holdings action functions
        function buyMore(instrumentToken, tradingSymbol) {
            const quantity = prompt(`Enter quantity to buy for ${tradingSymbol}:`);
            if (quantity && quantity > 0) {
                // TODO: Implement buy order API call
                alert(`Buy order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Buy order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/buy_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
         
        function sellSome(instrumentToken, tradingSymbol, currentQuantity) {
            const quantity = prompt(`Enter quantity to sell for ${tradingSymbol} (max: ${currentQuantity}):`);
            if (quantity && quantity > 0 && quantity <= currentQuantity) {
                // TODO: Implement sell order API call
                alert(`Sell order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_order', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            } else if (quantity > currentQuantity) {
                alert('Quantity cannot exceed current holding');
            }
        }
        
        function sellAll(instrumentToken, tradingSymbol, quantity) {
            if (confirm(`Are you sure you want to sell all ${quantity} shares of ${tradingSymbol}?`)) {
                // TODO: Implement sell all API call
                alert(`Sell all order: ${quantity} shares of ${tradingSymbol}`);
                console.log('Sell all order:', { instrumentToken, tradingSymbol, quantity });
                // Example: fetch('/api/sell_all', { method: 'POST', body: JSON.stringify({ instrumentToken, quantity }) });
            }
        }
        
        // Load positions data
        function loadPositions() {
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading positions:', data.error);
                        document.getElementById('positionsTableBody').innerHTML = 
                            '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('positionsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.positions || data.positions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No active positions</td></tr>';
                        return;
                    }
                    
                    data.positions.forEach(position => {
                        const pnlColor = position.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                        const typeColor = position.position_type === 'LONG' ? '#28a745' : position.position_type === 'SHORT' ? '#dc3545' : '#6c757d';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.fetch_timestamp || ''}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px; color: ${typeColor};">${position.position_type || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; font-size: 11px;">${position.trading_symbol || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.product || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${position.exchange || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">â‚¹${position.average_price.toFixed(2)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 11px;">
                                    <span style="${pnlColor}">â‚¹${position.pnl.toFixed(2)}</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching positions:', error);
                    document.getElementById('positionsTableBody').innerHTML = 
                        '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading positions data</td></tr>';
                });
        }
        
        // Helper function to format numbers in Indian locale (lakhs/crores)
        function formatIndianNumber(num) {
            // Round to nearest integer
            const rounded = Math.round(num);
            
            // Format with Indian locale commas
            return rounded.toLocaleString('en-IN');
        }
        
        // Load Derivatives Suggestions
        // Load Options Scanner
        function loadOptionsScanner() {
            const container = document.getElementById('optionsScannerContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Scanning options chain...</div>';
            
            // Get filter values
            const strategyType = document.getElementById('scannerStrategyType').value;
            const expiry = document.getElementById('scannerExpiry').value;
            const optionType = document.getElementById('scannerOptionType').value;
            const minIVRank = parseFloat(document.getElementById('scannerMinIVRank').value) || 50;
            const maxDays = parseInt(document.getElementById('scannerMaxDays').value) || 60;
            const minLiquidity = parseFloat(document.getElementById('scannerMinLiquidity').value) || 0.5;
            const minVolume = parseInt(document.getElementById('scannerMinVolume').value) || 0;
            const minOI = parseInt(document.getElementById('scannerMinOI').value) || 0;
            const minStrike = document.getElementById('scannerMinStrike').value ? parseFloat(document.getElementById('scannerMinStrike').value) : null;
            const maxStrike = document.getElementById('scannerMaxStrike').value ? parseFloat(document.getElementById('scannerMaxStrike').value) : null;
            
            // Build query string
            let url = `/api/options_scanner?strategy_type=${encodeURIComponent(strategyType)}`;
            url += `&min_iv_rank=${minIVRank}&max_iv_rank=100`;
            url += `&max_days_to_expiry=${maxDays}&min_days_to_expiry=7`;
            url += `&min_liquidity_score=${minLiquidity}`;
            url += `&min_volume=${minVolume}&min_oi=${minOI}`;
            
            if (expiry) url += `&expiry=${encodeURIComponent(expiry)}`;
            if (optionType) url += `&option_type=${encodeURIComponent(optionType)}`;
            if (minStrike !== null && maxStrike !== null) {
                url += `&strike_range_min=${minStrike}&strike_range_max=${maxStrike}`;
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Options scanner response:', data); // Debug log
                    
                    if (data.error || !data.success) {
                        console.error('Error loading options scanner:', data.error || 'Unknown error');
                        container.innerHTML = 
                            `<div style="text-align: center; padding: 20px; color: #dc3545;">
                                <strong>Error:</strong> ${data.error || 'No data available'}<br>
                                <small>Check console for details</small>
                            </div>`;
                        return;
                    }
                    
                    if (!data.candidates || data.candidates.length === 0) {
                        console.log('No candidates returned from scanner');
                        container.innerHTML = 
                            `<div style="text-align: center; padding: 20px; color: #666;">
                                No options found matching the criteria.<br>
                                <small>Try adjusting filters (e.g., lower IV Rank threshold, increase max days to expiry)</small>
                            </div>`;
                        return;
                    }
                    
                    displayOptionsScannerResults(data);
                })
                .catch(error => {
                    console.error('Error fetching options scanner:', error);
                    container.innerHTML = 
                        `<div style="text-align: center; padding: 20px; color: #dc3545;">
                            <strong>Error loading options scanner</strong><br>
                            <small>${error.message || 'Unknown error'}</small><br>
                            Check browser console for details.
                        </div>`;
                });
        }
        
        // Display Options Scanner Results
        function displayOptionsScannerResults(data) {
            console.log('Displaying scanner results:', data); // Debug log
            const container = document.getElementById('optionsScannerContainer');
            const candidates = data.candidates || [];
            
            if (!candidates || candidates.length === 0) {
                container.innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #666;">No candidates found matching the criteria</div>';
                return;
            }
            
            console.log(`Found ${candidates.length} candidates to display`);
            
            // Limit to top 5 candidates
            const top5Candidates = candidates.slice(0, 5);
            const totalFound = candidates.length;
            const displayCount = top5Candidates.length;
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 5px;">
                    <strong>Top ${displayCount} Options</strong> (showing latest ${displayCount} out of ${totalFound} total candidates) sorted by overall score
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background-color: #6f42c1; color: white;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Symbol</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Type</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Strike</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">IV (%)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">IV Rank</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Delta</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Gamma</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Theta</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Vega</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Rho</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Liquidity</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Score</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Days</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Moneyness</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">OI</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">OI Chart</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            top5Candidates.forEach((candidate, index) => {
                const ivRank = candidate.iv_rank !== null ? candidate.iv_rank.toFixed(1) : 'N/A';
                const ivRankColor = candidate.iv_rank !== null ? 
                    (candidate.iv_rank >= 70 ? '#28a745' : candidate.iv_rank >= 50 ? '#ffc107' : '#dc3545') : '#6c757d';
                const scoreColor = candidate.overall_score >= 80 ? '#28a745' : candidate.overall_score >= 60 ? '#ffc107' : '#dc3545';
                const ivPercentage = candidate.implied_volatility !== undefined ? candidate.implied_volatility.toFixed(2) : 'N/A';
                const moneyness = candidate.moneyness || 'N/A';
                const moneynessColor = moneyness === 'ITM' ? '#28a745' : moneyness === 'ATM' ? '#ffc107' : '#6c757d';
                
                html += `
                    <tr style="background-color: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};">
                        <td style="padding: 6px 8px; border: 1px solid #ddd; font-weight: 600; font-size: 10px;">${candidate.tradingsymbol || 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">
                            <span style="padding: 2px 6px; border-radius: 3px; background-color: ${candidate.option_type === 'CE' ? '#d4edda' : '#f8d7da'}; color: ${candidate.option_type === 'CE' ? '#155724' : '#721c24'}; font-weight: 600; font-size: 10px;">
                                ${candidate.option_type}
                            </span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 10px;">â‚¹${candidate.strike_price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">â‚¹${candidate.last_price.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px; font-weight: 600;">${ivPercentage}%</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${ivRankColor}; font-weight: 600; font-size: 10px;">${ivRank}%</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.delta !== undefined ? candidate.delta.toFixed(3) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.gamma !== undefined ? candidate.gamma.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${candidate.theta !== undefined && candidate.theta > 0 ? '#28a745' : '#dc3545'}; font-size: 10px;">
                            ${candidate.theta !== undefined ? `â‚¹${candidate.theta.toFixed(4)}/d` : 'N/A'}
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.vega !== undefined ? candidate.vega.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">${candidate.rho !== undefined ? candidate.rho.toFixed(4) : 'N/A'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px;">
                            <span style="color: ${candidate.liquidity_score >= 0.7 ? '#28a745' : candidate.liquidity_score >= 0.5 ? '#ffc107' : '#dc3545'};">
                                ${candidate.liquidity_score !== undefined ? candidate.liquidity_score.toFixed(2) : 'N/A'}
                            </span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; color: ${scoreColor}; font-weight: 600; font-size: 10px;">
                            ${candidate.overall_score !== undefined ? candidate.overall_score.toFixed(1) : 'N/A'}
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-size: 10px;">${candidate.days_to_expiry}</td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">
                            <span style="padding: 2px 6px; border-radius: 3px; background-color: ${moneynessColor === '#28a745' ? '#d4edda' : moneynessColor === '#ffc107' ? '#fff3cd' : '#e2e3e5'}; color: ${moneynessColor}; font-weight: 600; font-size: 9px;">
                                ${moneyness}
                            </span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right; font-size: 10px; font-weight: 600;" class="oi-cell" data-tradingsymbol="${candidate.tradingsymbol}">
                            <span class="oi-value">Loading...</span>
                        </td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">
                            <canvas id="oi-sparkline-${candidate.tradingsymbol}" width="100" height="30" style="cursor: pointer;" onclick="showOIChart('${candidate.tradingsymbol}', ${candidate.strike_price}, '${candidate.option_type}', '${candidate.expiry || ''}')"></canvas>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                ${totalFound > 5 ? `
                    <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border-radius: 5px; font-size: 11px; color: #856404;">
                        <strong>Note:</strong> Showing top 5 options out of ${totalFound} total candidates. Results are sorted by overall score.
                    </div>
                ` : ''}
            `;
            
            container.innerHTML = html;
            
            // Load OI data and sparklines for displayed options
            loadOIDataForOptions(top5Candidates);
        }
        
        function loadOptionsSuggestions() {
            const container = document.getElementById('optionsSuggestionsContainer');
            const timeframe = document.getElementById('optionsTimeframe').value;
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading suggestions...</div>';
            
            // Determine if it's minutes or days
            // Days are: 1, 3, 5 (from dropdown values)
            // Minutes are: 5, 10, 15, 20, 30, 60, 120, 240
            const isDays = (timeframe === '1' || timeframe === '3' || timeframe === '5');
            const apiUrl = isDays 
                ? `/api/intraday_options_suggestions?timeframe_minutes=15&timeframe_days=${timeframe}`  // Pass days parameter
                : `/api/intraday_options_suggestions?timeframe_minutes=${timeframe}`;
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load suggestions'}</div>`;
                        return;
                    }
                    
                    const shortTermSuggestions = data.short_term_suggestions || [];
                    const longTermSuggestions = data.long_term_suggestions || [];
                    const allSuggestions = [...shortTermSuggestions, ...longTermSuggestions];
                    
                    if (allSuggestions.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No suggestions available at this time</div>';
                        return;
                    }
                    
                    // Summary header
                    let html = `<div style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; font-size: 12px;">
                        <div><strong>Analysis Date:</strong> ${data.analysis_date} | <strong>Current Time:</strong> ${data.current_time}</div>
                        <div><strong>Current POC:</strong> â‚¹${data.current_poc ? data.current_poc.toFixed(2) : 'N/A'} | 
                             <strong>Current Price:</strong> â‚¹${data.current_price ? data.current_price.toFixed(2) : 'N/A'}</div>
                        <div><strong>POC Change:</strong> ${data.poc_change ? `${data.poc_change.direction} ${data.poc_change.change_pct ? data.poc_change.change_pct.toFixed(2) : '0.00'}% (${data.poc_change.strength})` : 'N/A'} | 
                             <strong>Order Flow:</strong> ${data.order_flow_sentiment || 'N/A'}</div>
                        <div><strong>Total Suggestions:</strong> ${allSuggestions.length} (${shortTermSuggestions.length} short-term, ${longTermSuggestions.length} long-term)</div>
                    </div>`;
                    
                    // Create table
                    html += `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                                <thead>
                                    <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Strategy/Type</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Symbol</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Strike</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Timeframe</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Entry</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Target</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Stop Loss</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">OI</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Volume</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Confidence</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Expiry</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    allSuggestions.forEach((suggestion, index) => {
                        const isMultiLeg = suggestion.strategy_type && (
                            suggestion.strategy_type.includes('Spread') ||
                            suggestion.strategy_type.includes('Collar') ||
                            suggestion.strategy_type.includes('Condor') ||
                            suggestion.strategy_type.includes('Straddle') ||
                            suggestion.strategy_type.includes('Protective')
                        );
                        
                        const optionColor = suggestion.option_type === 'CE' ? '#28a745' : 
                                          suggestion.option_type === 'PE' ? '#dc3545' : 
                                          suggestion.strategy_type ? '#6f42c1' : '#6c757d';
                        const confidenceColor = suggestion.confidence === 'High' ? '#dc3545' : 
                                               suggestion.confidence === 'Medium' ? '#ffc107' : '#6c757d';
                        
                        const strategyName = isMultiLeg ? suggestion.strategy_type : 
                                           `${suggestion.option_type || 'N/A'} ${suggestion.strike_price ? suggestion.strike_price.toFixed(0) : ''}`;
                        
                        html += `
                            <tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background-color: #f8f9fa;' : ''}">
                                <td style="padding: 10px; border: 1px solid #dee2e6;">
                                    <span style="font-weight: 600; color: ${optionColor};">${strategyName}</span>
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-size: 11px;">
                                    ${suggestion.symbol || 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                                    ${suggestion.strike_price ? suggestion.strike_price.toFixed(0) : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                                    ${suggestion.timeframe || 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">
                                    ${suggestion.entry_price ? 'â‚¹' + suggestion.entry_price.toFixed(2) : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; color: #28a745; font-weight: 600;">
                                    ${suggestion.target_price ? 'â‚¹' + suggestion.target_price.toFixed(2) : 
                                      suggestion.max_profit ? 'â‚¹' + suggestion.max_profit.toFixed(2) : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; color: #dc3545; font-weight: 600;">
                                    ${suggestion.stop_loss ? 'â‚¹' + suggestion.stop_loss.toFixed(2) : 
                                      suggestion.max_loss ? 'â‚¹' + Math.abs(suggestion.max_loss).toFixed(2) : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">
                                    ${suggestion.oi ? suggestion.oi.toLocaleString() : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">
                                    ${suggestion.volume ? suggestion.volume.toLocaleString() : 'N/A'}
                                </td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                                    <span style="background: ${confidenceColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">
                                        ${suggestion.confidence || 'Medium'} (${suggestion.confidence_score ? suggestion.confidence_score.toFixed(0) : '50'}%)
                                    </span>
                                </td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">
                                    ${suggestion.expiry ? new Date(suggestion.expiry).toLocaleDateString() : 'N/A'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching intraday options suggestions:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading suggestions</div>';
                });
        }
        
        function runBacktest() {
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const strategyType = document.getElementById('backtestStrategyType').value;
            const showOnlyProfitable = document.getElementById('backtestShowOnlyProfitable').checked;
            const minProfit = document.getElementById('backtestMinProfit').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Show loading
            document.getElementById('backtestLoading').style.display = 'block';
            document.getElementById('backtestResultsContainer').style.display = 'none';
            document.getElementById('backtestDataQualityIndicator').style.display = 'none';
            
            // Build API URL
            let url = `/api/options/backtest?start_date=${startDate}&end_date=${endDate}&strategy_type=${strategyType}&show_only_profitable=${showOnlyProfitable}`;
            if (minProfit) {
                url += `&min_profit=${minProfit}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('backtestLoading').style.display = 'none';
                    
                    if (data.error || !data.success) {
                        alert(`Error: ${data.error || 'Failed to run back-test'}`);
                        return;
                    }
                    
                    // Display data quality indicator
                    const metrics = data.metrics || {};
                    const dataQuality = metrics.data_quality || {};
                    if (dataQuality.generated_percentage > 0) {
                        const qualityDiv = document.getElementById('backtestDataQualityIndicator');
                        const qualityContent = document.getElementById('dataQualityContent');
                        qualityContent.innerHTML = `
                            <div style="margin-bottom: 5px;">
                                <strong>âš ï¸ Using generated data:</strong> ${dataQuality.generated_percentage.toFixed(1)}% of trades used Black-Scholes generated data
                            </div>
                            <div>
                                <strong>âœ“ Historical data:</strong> ${dataQuality.historical_percentage.toFixed(1)}% of trades used actual historical tick data
                            </div>
                            <div style="margin-top: 5px; font-size: 10px; color: #856404;">
                                Note: Results using generated data are estimates and may differ from actual market performance.
                            </div>
                        `;
                        qualityDiv.style.display = 'block';
                    }
                    
                    // Display metrics
                    displayBacktestMetrics(metrics);
                    
                    // Display trades table
                    displayBacktestTrades(data.trades || []);
                    
                    // Show results
                    document.getElementById('backtestResultsContainer').style.display = 'block';
                })
                .catch(error => {
                    document.getElementById('backtestLoading').style.display = 'none';
                    console.error('Error running back-test:', error);
                    alert('Error running back-test. Please check console for details.');
                });
        }
        
        function displayBacktestMetrics(metrics) {
            const panel = document.getElementById('backtestMetricsPanel');
            
            const winRateColor = metrics.win_rate >= 50 ? '#28a745' : '#dc3545';
            const totalPnLColor = metrics.total_profit_loss >= 0 ? '#28a745' : '#dc3545';
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 12px;">
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #007bff;">
                        <div style="color: #666; margin-bottom: 5px;">Total Trades</div>
                        <div style="font-size: 18px; font-weight: bold;">${metrics.total_trades || 0}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid ${winRateColor};">
                        <div style="color: #666; margin-bottom: 5px;">Win Rate</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${winRateColor};">${(metrics.win_rate || 0).toFixed(2)}%</div>
                        <div style="font-size: 10px; color: #666;">${metrics.win_count || 0} wins / ${metrics.loss_count || 0} losses</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid ${totalPnLColor};">
                        <div style="color: #666; margin-bottom: 5px;">Total P&L</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${totalPnLColor};">â‚¹${(metrics.total_profit_loss || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #6c757d;">
                        <div style="color: #666; margin-bottom: 5px;">Avg P&L per Trade</div>
                        <div style="font-size: 18px; font-weight: bold;">â‚¹${(metrics.avg_profit_loss || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #28a745;">
                        <div style="color: #666; margin-bottom: 5px;">Max Profit</div>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">â‚¹${(metrics.max_profit || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #dc3545;">
                        <div style="color: #666; margin-bottom: 5px;">Max Loss</div>
                        <div style="font-size: 18px; font-weight: bold; color: #dc3545;">â‚¹${(metrics.max_loss || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #17a2b8;">
                        <div style="color: #666; margin-bottom: 5px;">Sharpe Ratio</div>
                        <div style="font-size: 18px; font-weight: bold;">${(metrics.sharpe_ratio || 0).toFixed(2)}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <div style="color: #666; margin-bottom: 5px;">Profit Factor</div>
                        <div style="font-size: 18px; font-weight: bold;">${metrics.profit_factor === Infinity ? 'âˆ' : (metrics.profit_factor || 0).toFixed(2)}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #6f42c1;">
                        <div style="color: #666; margin-bottom: 5px;">Max Drawdown</div>
                        <div style="font-size: 18px; font-weight: bold; color: #dc3545;">â‚¹${(metrics.max_drawdown || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #20c997;">
                        <div style="color: #666; margin-bottom: 5px;">Confidence Score</div>
                        <div style="font-size: 18px; font-weight: bold;">${(metrics.confidence_score || 0).toFixed(0)}%</div>
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
        }
        
        function displayBacktestTrades(trades) {
            const tableDiv = document.getElementById('backtestTradesTable');
            
            if (trades.length === 0) {
                tableDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No trades found</div>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; background: white;">
                    <thead>
                        <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Entry Date</th>
                            <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Exit Date</th>
                            <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Symbol</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Type</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Strike</th>
                            <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Entry</th>
                            <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Exit</th>
                            <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">P&L</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Payoff</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Max Profit</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Max Loss</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">R/R</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Prob Profit</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Breakeven</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Margin</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Exit Reason</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Holding</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            trades.forEach((trade, index) => {
                const pnlColor = trade.profit_loss >= 0 ? '#28a745' : '#dc3545';
                const dataSourceBadge = trade.is_generated 
                    ? '<span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold;">âš ï¸ Gen</span>'
                    : '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold;">âœ“ Hist</span>';
                
                // Payoff sparkline
                const payoffSparklineId = `payoff-sparkline-${index}`;
                const payoffSparkline = trade.payoff_sparkline 
                    ? `<img id="${payoffSparklineId}" src="${trade.payoff_sparkline}" alt="Payoff" style="width: 60px; height: 30px; cursor: pointer;" title="Click to view full chart">`
                    : '<span style="color: #999; font-size: 9px;">N/A</span>';
                
                // Max Profit/Loss colors
                const maxProfitColor = (trade.max_profit || 0) >= 0 ? '#28a745' : '#dc3545';
                const maxLossColor = (trade.max_loss || 0) <= 0 ? '#dc3545' : '#28a745';
                
                // Risk/Reward ratio
                const rrRatio = trade.risk_reward_ratio || 0;
                const rrColor = rrRatio >= 2 ? '#28a745' : rrRatio >= 1 ? '#ffc107' : '#dc3545';
                
                // Probability of Profit
                const probProfit = trade.probability_of_profit || 0;
                const probColor = probProfit >= 60 ? '#28a745' : probProfit >= 40 ? '#ffc107' : '#dc3545';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 10px;">${trade.entry_date || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 10px;">${trade.exit_date || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold; font-size: 10px;">${trade.symbol || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px;">
                            <span style="color: ${trade.option_type === 'CE' ? '#28a745' : '#dc3545'}; font-weight: bold;">${trade.option_type || 'N/A'}</span>
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px;">${trade.strike_price || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px;">â‚¹${(trade.entry_price || 0).toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px;">â‚¹${(trade.exit_price || 0).toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px; color: ${pnlColor}; font-weight: bold;">
                            â‚¹${(trade.profit_loss || 0).toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px;">${payoffSparkline}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px; color: ${maxProfitColor};">
                            â‚¹${(trade.max_profit || 0).toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px; color: ${maxLossColor};">
                            â‚¹${(trade.max_loss || 0).toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px; color: ${rrColor}; font-weight: bold;">
                            ${rrRatio.toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px; color: ${probColor}; font-weight: bold;">
                            ${probProfit.toFixed(1)}%
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px;">
                            â‚¹${(trade.breakeven || 0).toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-size: 10px;">
                            â‚¹${(trade.estimated_margin || trade.estimated_premium || 0).toFixed(2)}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 9px; max-width: 120px; word-wrap: break-word;">
                            ${trade.exit_reason || 'N/A'}
                        </td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 10px;">${trade.holding_period || 0}d</td>
                    </tr>
                `;
            });
            
            // Store trades data for chart display
            window.backtestTrades = trades;
            
            html += `
                    </tbody>
                </table>
            `;
            
            tableDiv.innerHTML = html;
            
            // Add click handlers for payoff sparklines
            trades.forEach((trade, index) => {
                if (trade.payoff_sparkline) {
                    const sparklineId = `payoff-sparkline-${index}`;
                    const sparklineEl = document.getElementById(sparklineId);
                    if (sparklineEl) {
                        sparklineEl.addEventListener('click', function() {
                            showPayoffChart(index);
                        });
                    }
                }
            });
        }
        
        // Function to show full payoff chart in modal
        function showPayoffChart(tradeIndex) {
            const trade = window.backtestTrades && window.backtestTrades[tradeIndex];
            if (!trade || !trade.payoff_chart) {
                alert('Payoff chart not available for this trade');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;';
            content.onclick = function(e) { e.stopPropagation(); };
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">Payoff Chart - ${trade.symbol || 'Trade'}</h3>
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px;">Close</button>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>Max Profit:</strong> â‚¹${(trade.max_profit || 0).toFixed(2)}</div>
                        <div><strong>Max Loss:</strong> â‚¹${(trade.max_loss || 0).toFixed(2)}</div>
                        <div><strong>Risk/Reward:</strong> ${(trade.risk_reward_ratio || 0).toFixed(2)}</div>
                        <div><strong>Prob of Profit:</strong> ${(trade.probability_of_profit || 0).toFixed(1)}%</div>
                        <div><strong>Breakeven:</strong> â‚¹${(trade.breakeven || 0).toFixed(2)}</div>
                        <div><strong>Margin:</strong> â‚¹${(trade.estimated_margin || trade.estimated_premium || 0).toFixed(2)}</div>
                    </div>
                </div>
                <img src="${trade.payoff_chart}" alt="Payoff Chart" style="max-width: 100%; height: auto;">
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function loadDerivativesSuggestions() {
            const container = document.getElementById('derivativesSuggestionsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading suggestions...</div>';
            
            fetch('/api/derivatives_suggestions')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load suggestions'}</div>`;
                        return;
                    }
                    
                    if (!data.suggestions || data.suggestions.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No suggestions available at this time</div>';
                        return;
                    }
                    
                    let html = `<div style="margin-bottom: 15px; font-size: 12px; color: #666;">
                        Analysis Date: ${data.analysis_date} | Current Price: â‚¹${data.current_price ? data.current_price.toFixed(2) : 'N/A'} | Total Suggestions: ${data.total_suggestions}
                    </div>`;
                    
                    data.suggestions.forEach((suggestion, index) => {
                        const actionColor = suggestion.action === 'BUY' ? '#28a745' : suggestion.action === 'SELL' ? '#dc3545' : '#ffc107';
                        const confidenceWidth = suggestion.confidence_score || 0;
                        
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <span style="font-weight: bold; font-size: 16px; color: ${actionColor};">
                                            ${suggestion.action} ${suggestion.derivative_type}
                                        </span>
                                        <span style="margin-left: 10px; color: #666;">${suggestion.instrument}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        ${suggestion.timestamp ? `<div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸ•’ ${suggestion.timestamp}</div>` : ''}
                                        <div style="font-size: 12px; color: #666;">Confidence</div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 20px; width: 100px; position: relative; margin-top: 5px;">
                                            <div style="background: ${confidenceWidth >= 70 ? '#28a745' : confidenceWidth >= 40 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${confidenceWidth}%; border-radius: 10px; text-align: center; line-height: 20px; color: white; font-size: 10px; font-weight: bold;">
                                                ${confidenceWidth.toFixed(0)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; font-size: 12px;">
                                    <div><strong>Entry Level:</strong> â‚¹${suggestion.entry_level ? suggestion.entry_level.toFixed(2) : 'N/A'}</div>
                                    <div><strong>Stop Loss:</strong> ${suggestion.stop_loss ? 'â‚¹' + suggestion.stop_loss.toFixed(2) : 'N/A'}</div>
                                    <div><strong>Position Size:</strong> ${suggestion.position_size || 'N/A'}</div>
                                    ${suggestion.strike_price ? `<div><strong>Strike Price:</strong> ${suggestion.strike_price}</div>` : ''}
                                    ${suggestion.required_margin ? `
                                        <div style="grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 5px; border-left: 3px solid #ffc107;">
                                            <strong>ğŸ’° Required Margin/Money:</strong><br>
                                            ${suggestion.derivative_type === 'FUTURES' ? `
                                                Contract Value: â‚¹${suggestion.required_margin.contract_value ? suggestion.required_margin.contract_value.toFixed(2) : 'N/A'}<br>
                                                SPAN: â‚¹${suggestion.required_margin.span_margin ? suggestion.required_margin.span_margin.toFixed(2) : 'N/A'} | 
                                                Exposure: â‚¹${suggestion.required_margin.exposure_margin ? suggestion.required_margin.exposure_margin.toFixed(2) : 'N/A'}<br>
                                                <strong>Total Margin Required: â‚¹${suggestion.required_margin.total_margin ? suggestion.required_margin.total_margin.toFixed(2) : 'N/A'}</strong>
                                            ` : suggestion.required_margin.margin_type === 'Premium' ? `
                                                Premium per Lot: â‚¹${suggestion.estimated_premium ? (suggestion.estimated_premium * 50).toFixed(2) : 'N/A'}<br>
                                                <strong>Total Premium Required: â‚¹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            ` : suggestion.derivative_type === 'STRADDLE' ? `
                                                CALL Premium: â‚¹${suggestion.required_margin.call_premium ? suggestion.required_margin.call_premium.toFixed(2) : 'N/A'} | 
                                                PUT Premium: â‚¹${suggestion.required_margin.put_premium ? suggestion.required_margin.put_premium.toFixed(2) : 'N/A'}<br>
                                                <strong>Total Required: â‚¹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            ` : `
                                                <strong>Total Required: â‚¹${suggestion.required_margin.total_required ? suggestion.required_margin.total_required.toFixed(2) : 'N/A'}</strong>
                                            `}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${suggestion.max_potential_profit !== undefined ? `
                                    <div style="background: #e8f5e9; padding: 8px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid #4caf50;">
                                        <strong style="font-size: 12px; color: #2e7d32;">Max Potential Profit:</strong> 
                                        <span style="font-size: 14px; font-weight: bold; color: #1b5e20;">â‚¹${suggestion.max_potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                    </div>
                                ` : ''}
                                
                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 12px;">Target Levels:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${suggestion.target_levels ? suggestion.target_levels.map(t => {
                                            const profitDisplay = t.potential_profit !== undefined ? 
                                                ` - <strong style="color: #2e7d32;">Profit: â‚¹${t.potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>` : '';
                                            const straddleProfitDisplay = (t.call_profit !== undefined && t.put_profit !== undefined) ?
                                                ` - <strong style="color: #2e7d32;">CALL: â‚¹${t.call_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> / <strong style="color: #2e7d32;">PUT: â‚¹${t.put_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> (Total: â‚¹${t.potential_profit.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})` : '';
                                            return `<li>â‚¹${t.level.toFixed(2)} (${t.type}) - ${t.probability} probability${profitDisplay || straddleProfitDisplay}</li>`;
                                        }).join('') : '<li>No targets specified</li>'}
                                    </ul>
                                </div>
                                
                                <div style="background: #fff; padding: 10px; border-radius: 5px; font-size: 11px; color: #555; border-left: 3px solid ${actionColor};">
                                    <strong>Rationale:</strong> ${suggestion.rationale || 'No rationale provided'}
                                </div>
                                
                                ${suggestion.tpo_levels_used ? `
                                    <div style="margin-top: 10px; font-size: 11px; color: #666;">
                                        <strong>TPO Levels Used:</strong> 
                                        POC: ${suggestion.tpo_levels_used.poc ? 'â‚¹' + suggestion.tpo_levels_used.poc.toFixed(2) : 'N/A'},
                                        VAH: ${suggestion.tpo_levels_used.vah ? 'â‚¹' + suggestion.tpo_levels_used.vah.toFixed(2) : 'N/A'},
                                        VAL: ${suggestion.tpo_levels_used.val ? 'â‚¹' + suggestion.tpo_levels_used.val.toFixed(2) : 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching derivatives suggestions:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading suggestions</div>';
                });
        }
        
        // Load P&L Summary sdfsdf
        function loadPnlSummary() {
            fetch('/api/today_pnl_summary')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading P&L summary:', data.error);
                        return;
                    }
                    
                    const tbody = document.getElementById('pnlSummaryTableBody');
                    tbody.innerHTML = '';
                    
                    const categories = [
                        { 
                            name: 'Equity Portfolio', 
                            todayValue: data.equity_pnl || 0.0,
                            overallValue: data.equity_overall_pnl || 0.0
                        },
                        { 
                            name: 'Mutual Fund Portfolio', 
                            todayValue: data.mf_pnl || 0.0,
                            overallValue: data.mf_overall_pnl || 0.0
                        },
                        { 
                            name: 'Intraday Trades', 
                            todayValue: data.intraday_pnl || 0.0,
                            overallValue: null // Intraday only has today's P&L
                        },
                        { 
                            name: 'Total', 
                            todayValue: data.total_today_pnl || 0.0,
                            overallValue: data.total_overall_pnl || 0.0,
                            isTotal: true 
                        }
                    ];
                    
                    categories.forEach(cat => {
                        const todayColor = cat.todayValue >= 0 ? '#28a745' : '#dc3545';
                        const overallColor = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? (cat.overallValue >= 0 ? '#28a745' : '#dc3545') 
                            : todayColor;
                        const style = cat.isTotal ? 'font-weight: bold; font-size: 14px; border-top: 2px solid #ddd;' : '';
                        const todayFormatted = formatIndianNumber(cat.todayValue);
                        const overallFormatted = cat.overallValue !== null && cat.overallValue !== undefined 
                            ? formatIndianNumber(cat.overallValue) 
                            : '-';
                        
                        const row = `
                            <tr style="${style}">
                                <td style="padding: 12px; border: 1px solid #ddd; ${cat.isTotal ? 'font-weight: bold;' : ''}">${cat.name}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${todayColor}; font-weight: bold;">
                                    ${cat.todayValue >= 0 ? '+' : ''}â‚¹${todayFormatted}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${overallColor}; font-weight: bold;">
                                    ${cat.overallValue !== null && cat.overallValue !== undefined 
                                        ? `${cat.overallValue >= 0 ? '+' : ''}â‚¹${overallFormatted}`
                                        : '-'}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching P&L summary:', error);
                });
        }
        
        // Load Portfolio Chart
        let portfolioChartInstance = null;
        function loadPortfolioChart(days) {
            fetch(`/api/portfolio_history?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading portfolio history:', data.error);
                        return;
                    }
                    
                    const ctx = document.getElementById('portfolioChart').getContext('2d');
                    
                    // Destroy previous chart instance if it exists
                    if (portfolioChartInstance) {
                        portfolioChartInstance.destroy();
                    }
                    
                    // Prepare chart data
                    const labels = data.portfolio_history.map(item => {
                        const date = new Date(item.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    });
                    
                    const equityData = data.portfolio_history.map(item => item.equity || 0);
                    const mfData = data.portfolio_history.map(item => item.mutual_fund || 0);
                    const totalData = data.portfolio_history.map(item => item.total || 0);
                    
                    portfolioChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Equity',
                                    data: equityData,
                                    borderColor: 'rgb(40, 167, 69)',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Mutual Fund',
                                    data: mfData,
                                    borderColor: 'rgb(13, 110, 253)',
                                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Total Portfolio',
                                    data: totalData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': â‚¹' + context.parsed.y.toLocaleString('en-IN', {maximumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return 'â‚¹' + value.toLocaleString('en-IN', {maximumFractionDigits: 0});
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching portfolio history:', error);
                });
        }
        
        // Load MF holdings data
        function loadMFHoldings() {
            fetch('/api/mf_holdings')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading MF holdings:', data.error);
                        document.getElementById('mfHoldingsTableBody').innerHTML = 
                            '<tr><td colspan="13" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                        return;
                    }
                    
                    const tbody = document.getElementById('mfHoldingsTableBody');
                    tbody.innerHTML = '';
                    
                    if (!data.mf_holdings || data.mf_holdings.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="13" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">No MF holdings found</td></tr>';
                        return;
                    }
                    
                    // Fetch benchmark comparison data
                    fetch('/api/mf_benchmark_comparison')
                        .then(response => response.json())
                        .then(benchmarkData => {
                            // Create a map of MF symbol to benchmark metrics
                            const benchmarkMap = {};
                            if (benchmarkData.comparisons) {
                                benchmarkData.comparisons.forEach(comp => {
                                    if (comp.success) {
                                        benchmarkMap[comp.mf_symbol] = comp;
                                    }
                                });
                            }
                            
                            // Render MF holdings with benchmark data
                            data.mf_holdings.forEach(mf => {
                                const pnlColor = mf.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                                const netChangeColor = mf.net_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                                const dayChangeColor = mf.day_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                                
                                // Get benchmark metrics for this MF
                                const benchmarkMetrics = benchmarkMap[mf.tradingsymbol] || null;
                                
                                const formatExcessReturn = (value) => {
                                    if (value === null || value === undefined) return '-';
                                    const color = value >= 0 ? '#28a745' : '#dc3545';
                                    return `<span style="color: ${color};">${value >= 0 ? '+' : ''}${value.toFixed(2)}%</span>`;
                                };
                                
                                const formatMetric = (value, decimals = 2) => {
                                    if (value === null || value === undefined) return '-';
                                    return value.toFixed(decimals);
                                };
                                
                                const benchmarkName = benchmarkMetrics ? (benchmarkMetrics.benchmark_symbol || '-') : '-';
                                const excessReturns = benchmarkMetrics ? (benchmarkMetrics.excess_returns || {}) : {};
                                const alpha = benchmarkMetrics ? formatMetric(benchmarkMetrics.alpha, 2) : '-';
                                const beta = benchmarkMetrics ? formatMetric(benchmarkMetrics.beta, 2) : '-';
                                
                                const row = `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${mf.fund || mf.tradingsymbol || '-'}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">â‚¹${mf.invested_amount.toFixed(2)}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">â‚¹${mf.current_value.toFixed(2)}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${pnlColor}">â‚¹${mf.pnl.toFixed(2)}</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${netChangeColor}">${mf.net_change_percentage >= 0 ? '+' : ''}${mf.net_change_percentage.toFixed(2)}%</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${dayChangeColor}">${mf.day_change_percentage >= 0 ? '+' : ''}${mf.day_change_percentage.toFixed(2)}%</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${benchmarkName}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${formatExcessReturn(excessReturns['1M'])}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${formatExcessReturn(excessReturns['3M'])}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${formatExcessReturn(excessReturns['6M'])}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${formatExcessReturn(excessReturns['1Y'])}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${alpha}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${beta}</td>
                                    </tr>
                                `;
                                tbody.innerHTML += row;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching benchmark comparison:', error);
                            // Fallback: render without benchmark data
                            data.mf_holdings.forEach(mf => {
                                const pnlColor = mf.pnl >= 0 ? 'color: #28a745; font-weight: bold;' : 'color: #dc3545; font-weight: bold;';
                                const netChangeColor = mf.net_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                                const dayChangeColor = mf.day_change_percentage >= 0 ? 'color: #28a745;' : 'color: #dc3545;';
                                
                                const row = `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${mf.fund || mf.tradingsymbol || '-'}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">â‚¹${mf.invested_amount.toFixed(2)}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">â‚¹${mf.current_value.toFixed(2)}</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${pnlColor}">â‚¹${mf.pnl.toFixed(2)}</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${netChangeColor}">${mf.net_change_percentage >= 0 ? '+' : ''}${mf.net_change_percentage.toFixed(2)}%</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">
                                            <span style="${dayChangeColor}">${mf.day_change_percentage >= 0 ? '+' : ''}${mf.day_change_percentage.toFixed(2)}%</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 11px;">-</td>
                                    </tr>
                                `;
                                tbody.innerHTML += row;
                            });
                        });
                })
                .catch(error => {
                    console.error('Error fetching MF holdings:', error);
                    document.getElementById('mfHoldingsTableBody').innerHTML = 
                        '<tr><td colspan="13" style="padding: 15px; text-align: center; color: #dc3545; font-size: 12px;">Error loading MF holdings data</td></tr>';
                });
        }
        
        // Derivatives suggestions refresh timer (every 5 minutes)
        let derivativesSuggestionsTimer = null;
        
        function startDerivativesSuggestionsRefresh() {
            // Clear existing timer if any
            if (derivativesSuggestionsTimer) {
                clearInterval(derivativesSuggestionsTimer);
            }
            
            // Load immediately
            if (isMarketClosedIST()) {
                // Ensure no further refreshes after close
                derivativesSuggestionsTimer = null;
                return;
            }
            loadDerivativesSuggestions();
            
            // Then refresh every 5 minutes (300000 ms)
            derivativesSuggestionsTimer = setInterval(function() {
                if (isMarketClosedIST()) {
                    clearInterval(derivativesSuggestionsTimer);
                    derivativesSuggestionsTimer = null;
                    return;
                }
                loadDerivativesSuggestions();
            }, 300000);
        }
        
        // Load Portfolio Hedge Analysis
        function loadPortfolioHedgeAnalysis() {
            const container = document.getElementById('portfolioHedgeContainer');
            const hedgeRatio = document.getElementById('hedgeRatioSelector').value;
            const strategyType = document.getElementById('strategyTypeSelector').value;
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading hedge analysis...</div>';
            
            fetch(`/api/portfolio_hedge_analysis?target_hedge_ratio=${hedgeRatio}&strategy_type=${strategyType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load hedge analysis'}</div>`;
                        return;
                    }
                    
                    const metrics = data.portfolio_metrics || {};
                    const suggestions = data.hedge_suggestions || {};
                    const varMetrics = data.var_metrics || {};
                    
                    // Handle new response structure (strategies array)
                    const strategies = suggestions.strategies || [];
                    const diagnostics = suggestions.diagnostics || {};
                    
                    // Debug: Log what we received
                    console.log('Portfolio Hedge Analysis Response:', {
                        suggestions: suggestions,
                        diagnostics: diagnostics,
                        metrics: metrics
                    });
                    
                    let html = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Portfolio Value</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">â‚¹${(metrics.portfolio_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Portfolio Beta</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${(metrics.beta || 0).toFixed(2)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Correlation with Nifty</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${((metrics.correlation || 0) * 100).toFixed(1)}%</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Hedge Effectiveness</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;">${(suggestions.hedge_effectiveness_score || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                    `;
                    
                    // Display summary metrics
                    if (suggestions.total_strategies > 0 || strategies.length > 0) {
                        html += `
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                                    <div><strong>Total Strategies:</strong> ${suggestions.total_strategies || strategies.length}</div>
                                    <div><strong>Total Hedge Value:</strong> â‚¹${(suggestions.total_hedge_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div><strong>Net Hedging Cost:</strong> â‚¹${(suggestions.net_hedging_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div><strong>Total Margin Required:</strong> â‚¹${(suggestions.total_margin_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Display all strategies
                    if (strategies.length > 0) {
                        // Group strategies by type
                        const groupedStrategies = {};
                        strategies.forEach(strategy => {
                            const type = strategy.strategy_type || 'OTHER';
                            if (!groupedStrategies[type]) {
                                groupedStrategies[type] = [];
                            }
                            groupedStrategies[type].push(strategy);
                        });
                        
                        Object.keys(groupedStrategies).forEach(strategyType => {
                            const typeStrategies = groupedStrategies[strategyType];
                            const typeName = typeStrategies[0].strategy_name || strategyType;
                            
                            html += `
                                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 15px 0; font-size: 14px;">ğŸ›¡ï¸ ${typeName} (${typeStrategies.length})</h4>
                            `;
                            
                            typeStrategies.forEach(strategy => {
                                html += `
                                    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 3px; border: 1px solid #ddd;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <strong style="font-size: 13px;">${strategy.instrument || (strategy.instruments && strategy.instruments.length > 0 ? 'Collar (Multiple)' : 'N/A')}</strong>
                                            <span style="color: ${strategy.direction === 'SHORT' ? '#dc3545' : '#28a745'}; font-weight: bold; font-size: 12px;">${strategy.direction || 'N/A'}</span>
                                        </div>
                                `;
                                
                                // Handle different strategy types
                                if (strategy.strategy_type === 'COLLAR' && strategy.instruments) {
                                    // Collar strategy has multiple instruments
                                    strategy.instruments.forEach(instr => {
                                        html += `
                                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; padding-left: 10px; border-left: 2px solid #ddd;">
                                                <strong>${instr.option_type} ${instr.strike_price}</strong> - ${instr.direction} ${instr.instrument}<br/>
                                                Premium: ${instr.direction === 'LONG' ? 'â‚¹' + (instr.total_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2}) : 'â‚¹' + (instr.total_income || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                            </div>
                                        `;
                                    });
                                    html += `
                                        <div style="font-size: 11px; color: #333; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                            <strong>Net Cost:</strong> â‚¹${(strategy.net_cost || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}<br/>
                                            <strong>Margin Required:</strong> â‚¹${(strategy.margin_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}<br/>
                                            <strong>Coverage:</strong> ${(strategy.coverage_percentage || 0).toFixed(1)}%<br/>
                                            <div style="margin-top: 5px; font-style: italic; color: #666; font-size: 10px;">${strategy.rationale || ''}</div>
                                        </div>
                                    `;
                                } else {
                                    // Single instrument strategy
                                    html += `
                                        <div style="font-size: 11px; color: #666;">
                                            ${strategy.strike_price ? `<div><strong>Strike:</strong> ${strategy.strike_price} | <strong>Expiry:</strong> ${strategy.expiry || 'N/A'}</div>` : ''}
                                            <div><strong>Quantity:</strong> ${strategy.quantity || 0} lots (Lot Size: ${strategy.lot_size || 50})</div>
                                            ${strategy.entry_price ? `<div><strong>Entry Price:</strong> â‚¹${strategy.entry_price.toFixed(2)}</div>` : ''}
                                            ${strategy.total_premium ? `<div><strong>Premium Cost:</strong> â‚¹${strategy.total_premium.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.total_premium_income ? `<div><strong>Premium Income:</strong> â‚¹${strategy.total_premium_income.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.margin_required ? `<div><strong>Margin Required:</strong> â‚¹${strategy.margin_required.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>` : ''}
                                            ${strategy.coverage_percentage ? `<div><strong>Coverage:</strong> ${strategy.coverage_percentage.toFixed(1)}%</div>` : ''}
                                            ${strategy.rationale ? `<div style="margin-top: 5px; font-style: italic; color: #666; font-size: 10px;">${strategy.rationale}</div>` : ''}
                                        </div>
                                    `;
                                }
                                
                                html += `</div>`;
                            });
                            
                            html += `</div>`;
                        });
                    } else if (suggestions.suggested_instruments && suggestions.suggested_instruments.length > 0) {
                        // Fallback for old format (backward compatibility)
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ›¡ï¸ Recommended Hedge Strategy</h4>
                        `;
                        
                        suggestions.suggested_instruments.forEach(instrument => {
                            html += `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 3px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <strong>${instrument.instrument}</strong>
                                        <span style="color: #dc3545; font-weight: bold;">${instrument.direction}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <div>Quantity: ${instrument.quantity} (Lot Size: ${instrument.lot_size})</div>
                                        <div>Entry Price: â‚¹${instrument.entry_price.toFixed(2)}</div>
                                        <div>Hedge Value: â‚¹${instrument.hedge_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                        <div><strong>Estimated Margin Required: â‚¹${instrument.estimated_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></div>
                                        <div style="margin-top: 5px; font-style: italic; color: #666;">${instrument.rationale}</div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <div style="font-size: 12px;"><strong>Unhedged Exposure:</strong> â‚¹${(suggestions.unhedged_exposure || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div style="font-size: 12px;"><strong>Cost of Hedging:</strong> â‚¹${(suggestions.cost_of_hedging || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Show diagnostic information (diagnostics already defined at top of function)
                        const diagnosticMsg = suggestions.diagnostic_message || "No hedging strategies available";
                        
                        // Debug: Log diagnostics
                        console.log('No strategies found - Diagnostics:', diagnostics, 'Suggestions:', suggestions);
                        
                        html += `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #856404;">âš ï¸ No Hedging Strategies Available</h4>
                                <div style="font-size: 12px; color: #856404; margin-bottom: 10px;">
                                    <strong>Issue:</strong> ${diagnosticMsg}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <strong>Data Status:</strong><br/>
                                    â€¢ Total Holdings: ${(diagnostics && diagnostics.holdings_count) || (suggestions.diagnostics && suggestions.diagnostics.holdings_count) || 0} (Equity: ${(diagnostics && diagnostics.equity_count) || (suggestions.diagnostics && suggestions.diagnostics.equity_count) || 0}, MF: ${(diagnostics && diagnostics.mf_count) || (suggestions.diagnostics && suggestions.diagnostics.mf_count) || 0})<br/>
                                    â€¢ Portfolio Value: â‚¹${((diagnostics && diagnostics.portfolio_value) || (suggestions.diagnostics && suggestions.diagnostics.portfolio_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} 
                                    (Equity: â‚¹${((diagnostics && diagnostics.equity_value) || (suggestions.diagnostics && suggestions.diagnostics.equity_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}, 
                                    MF: â‚¹${((diagnostics && diagnostics.mf_value) || (suggestions.diagnostics && suggestions.diagnostics.mf_value) || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})<br/>
                                    â€¢ Beta: ${((diagnostics && diagnostics.beta) || (suggestions.diagnostics && suggestions.diagnostics.beta) || 0).toFixed(2)}<br/>
                                    â€¢ Nifty Price: â‚¹${((diagnostics && diagnostics.nifty_price) || (suggestions.diagnostics && suggestions.diagnostics.nifty_price) || 0).toFixed(2)}<br/>
                                    â€¢ Options Expiries Available: ${(diagnostics && diagnostics.expiries_available) || (suggestions.diagnostics && suggestions.diagnostics.expiries_available) || 0}<br/>
                                    <br/>
                                    <strong>Data Requirements:</strong><br/>
                                    â€¢ At least 1 holding with quantity > 0 (Equity and/or MF)<br/>
                                    â€¢ For Beta calculation: At least 10 days of historical OHLC data for equity holdings and Nifty 50<br/>
                                    â€¢ Current Nifty price available<br/>
                                    â€¢ For options strategies: At least 1 expiry date with options having volume â‰¥ 100 and OI â‰¥ 10,000<br/>
                                    <br/>
                                    <strong>Note:</strong> The analyzer now includes both Equity and Mutual Fund holdings. Beta is calculated using equity holdings only (MF holdings don't have daily historical prices), but total portfolio value includes both Equity and MF.
                                </div>
                            </div>
                        `;
                    }
                    
                    if (varMetrics.var_95) {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ“Š Value at Risk (VaR)</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <div>
                                        <div style="font-size: 11px; color: #666;">VaR (95% Confidence)</div>
                                        <div style="font-size: 16px; font-weight: bold;">â‚¹${(varMetrics.var_95 || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #666;">VaR (99% Confidence)</div>
                                        <div style="font-size: 16px; font-weight: bold;">â‚¹${(varMetrics.var_99 || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching portfolio hedge analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading hedge analysis</div>';
                });
        }
        
        // Load Margin Calculator
        function loadMarginCalculator() {
            const container = document.getElementById('availableMarginDisplay');
            if (!container) {
                console.warn('availableMarginDisplay element not found');
                return;
            }
            container.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">Loading margin data...</div>';
            
            fetch('/api/margin/available')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="color: #dc3545; font-size: 12px;">Error: ${data.error || 'Failed to load margin data'}</div>`;
                        return;
                    }
                    
                    const marginData = data.margin_data || {};
                    const utilizationPct = marginData.utilization_percentage || 0;
                    const utilizationColor = utilizationPct > 80 ? '#dc3545' : utilizationPct > 60 ? '#ffc107' : '#28a745';
                    
                    container.innerHTML = `
                        <div style="font-size: 12px;">
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Available Cash</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">â‚¹${(marginData.available_cash || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Available Live Balance</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">â‚¹${(marginData.available_live_balance || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Total Utilised</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">â‚¹${(marginData.total_utilised || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div style="color: #666; margin-bottom: 5px;">Margin Utilization</div>
                                <div style="background: #e0e0e0; border-radius: 10px; height: 20px; position: relative; margin-top: 5px;">
                                    <div style="background: ${utilizationColor}; height: 100%; width: ${Math.min(100, utilizationPct)}%; border-radius: 10px; text-align: center; line-height: 20px; color: white; font-size: 10px; font-weight: bold;">
                                        ${utilizationPct.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching margin data:', error);
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Error loading margin data</div>';
                });
        }
        
        // Calculate Margin
        function calculateMargin() {
            const container = document.getElementById('marginCalculationResult');
            container.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">Calculating margin...</div>';
            
            const instrumentType = document.getElementById('marginInstrumentType').value;
            const instrumentToken = parseInt(document.getElementById('marginInstrumentToken').value);
            const quantity = parseInt(document.getElementById('marginQuantity').value);
            const entryPrice = parseFloat(document.getElementById('marginEntryPrice').value);
            const product = document.getElementById('marginProduct').value;
            
            if (!instrumentToken || !quantity || !entryPrice) {
                container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Please fill all required fields</div>';
                return;
            }
            
            let url = `/api/margin/calculate?instrument_token=${instrumentToken}&quantity=${quantity}&entry_price=${entryPrice}&instrument_type=${instrumentType}&product=${product}`;
            
            if (instrumentType === 'OPTIONS') {
                const strikePrice = parseFloat(document.getElementById('marginStrikePrice').value);
                const premium = parseFloat(document.getElementById('marginPremium').value);
                const optionType = document.getElementById('marginOptionType').value;
                const isLong = document.getElementById('marginIsLong').value === 'true';
                
                if (!strikePrice || !premium) {
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Strike price and premium are required for options</div>';
                    return;
                }
                
                url += `&strike_price=${strikePrice}&premium=${premium}&option_type=${optionType}&is_long=${isLong}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="color: #dc3545; font-size: 12px;">Error: ${data.error || 'Failed to calculate margin'}</div>`;
                        return;
                    }
                    
                    const calc = data.margin_calculation || {};
                    const check = data.margin_check || {};
                    const isSufficient = check.is_sufficient || false;
                    
                    let html = `
                        <div style="font-size: 12px;">
                            <div style="margin-bottom: 10px; padding: 10px; background: ${isSufficient ? '#d4edda' : '#f8d7da'}; border-radius: 5px; border-left: 4px solid ${isSufficient ? '#28a745' : '#dc3545'};">
                                <strong>Margin Status: ${isSufficient ? 'âœ“ Sufficient' : 'âœ— Insufficient'}</strong>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #666; margin-bottom: 3px;">Required Margin</div>
                                <div style="font-size: 16px; font-weight: bold;">â‚¹${(calc.total_margin || calc.total_required || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            ${calc.span_margin ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">SPAN Margin: â‚¹${calc.span_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${calc.exposure_margin ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">Exposure Margin: â‚¹${calc.exposure_margin.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${calc.contract_value ? `
                                <div style="margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 11px;">Contract Value: â‚¹${calc.contract_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                            ${!isSufficient && check.shortfall ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                    <div style="color: #856404; font-size: 11px;">Shortfall: â‚¹${check.shortfall.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error calculating margin:', error);
                    container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Error calculating margin</div>';
                });
        }
        
        // Toggle options fields based on instrument type
        document.addEventListener('DOMContentLoaded', function() {
            const instrumentTypeSelect = document.getElementById('marginInstrumentType');
            const optionsFields = document.getElementById('optionsFields');
            
            if (instrumentTypeSelect && optionsFields) {
                instrumentTypeSelect.addEventListener('change', function() {
                    optionsFields.style.display = this.value === 'OPTIONS' ? 'block' : 'none';
                });
            }
        });
        
        // Load Order Flow Analysis
        function loadOrderFlowAnalysis() {
            const container = document.getElementById('orderFlowAnalysisContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading order flow analysis...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/orderflow_analysis?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayOrderFlowAnalysis(data);
                })
                .catch(error => {
                    console.error('Error fetching order flow analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading order flow analysis</div>';
                });
        }
        
        // Display Order Flow Analysis
        function displayOrderFlowAnalysis(data) {
            const container = document.getElementById('orderFlowAnalysisContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">âš ï¸ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const trapped = data.trapped_traders || {};
            const divergences = data.volume_divergences || {};
            const exhaustion = data.exhaustion_signals || {};
            const pressure = data.pressure_analysis || {};
            const sentiment = data.overall_sentiment || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Overall Sentiment</div>
                        <div style="font-size: 20px; font-weight: bold;">${sentiment.sentiment || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Score: ${sentiment.sentiment_score || 0}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Buy/Sell Pressure</div>
                        <div style="font-size: 18px; font-weight: bold;">${pressure.pressure_direction || 'Neutral'}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Score: ${pressure.pressure_score || 0}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Trapped Traders</div>
                        <div style="font-size: 18px; font-weight: bold;">${trapped.count || 0}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Buyers: ${trapped.trapped_buyers_count || 0} | Sellers: ${trapped.trapped_sellers_count || 0}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Volume Divergences</div>
                        <div style="font-size: 18px; font-weight: bold;">${divergences.count || 0}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 5px;">Bullish: ${divergences.bullish_divergences || 0} | Bearish: ${divergences.bearish_divergences || 0}</div>
                    </div>
                </div>
            `;
            
            // Trapped Traders Details
            if (trapped.trapped_buyers && trapped.trapped_buyers.length > 0 || trapped.trapped_sellers && trapped.trapped_sellers.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">âš ï¸ Trapped Traders</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Trapped Buyers (${trapped.trapped_buyers_count || 0})</div>
                                ${trapped.trapped_buyers && trapped.trapped_buyers.length > 0 ? 
                                    trapped.trapped_buyers.slice(0, 3).map(t => `
                                        <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                            <div style="font-size: 11px; font-weight: bold;">â‚¹${t.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">Sell Vol: ${t.sell_volume} | ${t.severity}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None detected</div>'
                                }
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Trapped Sellers (${trapped.trapped_sellers_count || 0})</div>
                                ${trapped.trapped_sellers && trapped.trapped_sellers.length > 0 ? 
                                    trapped.trapped_sellers.slice(0, 3).map(t => `
                                        <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                            <div style="font-size: 11px; font-weight: bold;">â‚¹${t.price.toFixed(2)}</div>
                                            <div style="font-size: 10px; color: #666;">Buy Vol: ${t.buy_volume} | ${t.severity}</div>
                                        </div>
                                    `).join('') : 
                                    '<div style="color: #999; font-size: 11px;">None detected</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Exhaustion Signals
            if (exhaustion.exhaustion_events && exhaustion.exhaustion_events.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">âš¡ Exhaustion Signals (${exhaustion.count || 0})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${exhaustion.exhaustion_events.slice(0, 5).map(e => `
                                <div style="background: ${e.type === 'bullish_exhaustion' ? '#fff3cd' : '#d1ecf1'}; padding: 10px; border-radius: 5px; border-left: 3px solid ${e.type === 'bullish_exhaustion' ? '#ffc107' : '#17a2b8'};">
                                    <div style="font-size: 11px; font-weight: 600;">${e.type === 'bullish_exhaustion' ? 'ğŸ”´ Bullish Exhaustion' : 'ğŸŸ¢ Bearish Exhaustion'}</div>
                                    <div style="font-size: 12px; font-weight: bold; margin-top: 5px;">â‚¹${e.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Volume: ${e.volume_multiple}x avg</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Sentiment Signals
            if (sentiment.signals && sentiment.signals.length > 0) {
                html += `
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">Key Signals:</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                            ${sentiment.signals.map(signal => `<li style="margin-bottom: 3px;">${signal}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Load Footprint Analysis
        function loadFootprintAnalysis() {
            const container = document.getElementById('footprintAnalysisContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading footprint analysis...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/footprint_analysis?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayFootprintAnalysis(data);
                })
                .catch(error => {
                    console.error('Error fetching footprint analysis:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading footprint analysis</div>';
                });
        }
        
        // Display Footprint Analysis
        function displayFootprintAnalysis(data) {
            const container = document.getElementById('footprintAnalysisContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">âš ï¸ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const levels = data.footprint_levels || [];
            const imbalances = data.imbalances || {};
            const hvn_lvn = data.hvn_lvn || {};
            const delta = data.delta || {};
            const priceRange = data.price_range || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Total Volume</div>
                        <div style="font-size: 14px; font-weight: bold;">${(data.total_volume || 0).toLocaleString()}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #007bff;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Net Buy Volume</div>
                        <div style="font-size: 14px; font-weight: bold; color: ${data.net_buy_volume > 0 ? '#28a745' : '#dc3545'};">
                            ${(data.net_buy_volume || 0).toLocaleString()}
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Delta Trend</div>
                        <div style="font-size: 14px; font-weight: bold;">${delta.delta_trend || 'Neutral'}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #6c757d;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Imbalance Zones</div>
                        <div style="font-size: 14px; font-weight: bold;">${imbalances.total_imbalance_zones || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #17a2b8;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">HVN Count</div>
                        <div style="font-size: 14px; font-weight: bold;">${hvn_lvn.hvn_count || 0}</div>
                    </div>
                </div>
            `;
            
            // Top Volume Imbalances
            if (imbalances.imbalances && imbalances.imbalances.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">âš–ï¸ Volume Imbalances (Top 5)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${imbalances.imbalances.slice(0, 5).map(imb => `
                                <div style="background: ${imb.type === 'buy_imbalance' ? '#d4edda' : '#f8d7da'}; padding: 10px; border-radius: 5px; border-left: 3px solid ${imb.type === 'buy_imbalance' ? '#28a745' : '#dc3545'};">
                                    <div style="font-size: 11px; font-weight: 600;">â‚¹${imb.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                        ${imb.type === 'buy_imbalance' ? 'Buy' : 'Sell'} Imbalance: ${imb.imbalance_ratio}%<br>
                                        Strength: ${imb.strength}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // HVN/LVN Levels
            if (hvn_lvn.hvn && hvn_lvn.hvn.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ“ High Volume Nodes (HVN) - Potential S/R</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${hvn_lvn.hvn.slice(0, 5).map(hvn => `
                                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 11px; font-weight: 600;">â‚¹${hvn.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Vol: ${hvn.volume.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Load Micro Levels
        function loadMicroLevels() {
            const container = document.getElementById('microLevelsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading critical micro levels...</div>';
            
            const analysisDate = document.getElementById('analysisDate').value || null;
            let url = '/api/micro_levels?start_time=09:15:00&end_time=15:30:00';
            if (analysisDate) {
                url += `&analysis_date=${analysisDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'No data available'}</div>`;
                        return;
                    }
                    displayMicroLevels(data);
                })
                .catch(error => {
                    console.error('Error fetching micro levels:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading micro levels</div>';
                });
        }
        
        // Auto-refresh for Order Flow Analysis, Footprint Analysis, and Critical Micro Levels
        let orderFlowAnalysisRefreshTimer = null;
        let footprintAnalysisRefreshTimer = null;
        let microLevelsRefreshTimer = null;
        let orderFlowAnalysisAutoRefreshStarted = false;
        let footprintAnalysisAutoRefreshStarted = false;
        let microLevelsAutoRefreshStarted = false;
        
        // Start auto-refresh for Order Flow Analysis
        function startOrderFlowAnalysisAutoRefresh() {
            const liveMarketTab = document.getElementById('live-market-tab');
            
            if (orderFlowAnalysisRefreshTimer) {
                clearInterval(orderFlowAnalysisRefreshTimer);
            }
            
            // Refresh every 5 minutes (300000 ms)
            orderFlowAnalysisRefreshTimer = setInterval(() => {
                if (liveMarketTab && liveMarketTab.classList.contains('active')) {
                    console.log('Auto-refreshing Order Flow Analysis (5-minute interval)...');
                    loadOrderFlowAnalysis();
                }
            }, 300000); // 5 minutes
            
            console.log('Order Flow Analysis auto-refresh started (every 5 minutes)');
        }
        
        // Stop auto-refresh for Order Flow Analysis
        function stopOrderFlowAnalysisAutoRefresh() {
            if (orderFlowAnalysisRefreshTimer) {
                clearInterval(orderFlowAnalysisRefreshTimer);
                orderFlowAnalysisRefreshTimer = null;
                console.log('Order Flow Analysis auto-refresh stopped');
            }
        }
        
        // Initialize auto-refresh for Order Flow Analysis
        function initOrderFlowAnalysisAutoRefresh() {
            if (!orderFlowAnalysisAutoRefreshStarted) {
                startOrderFlowAnalysisAutoRefresh();
                orderFlowAnalysisAutoRefreshStarted = true;
            }
        }
        
        // Start auto-refresh for Footprint Analysis
        function startFootprintAnalysisAutoRefresh() {
            const liveMarketTab = document.getElementById('live-market-tab');
            
            if (footprintAnalysisRefreshTimer) {
                clearInterval(footprintAnalysisRefreshTimer);
            }
            
            // Refresh every 5 minutes (300000 ms)
            footprintAnalysisRefreshTimer = setInterval(() => {
                if (liveMarketTab && liveMarketTab.classList.contains('active')) {
                    console.log('Auto-refreshing Footprint Analysis (5-minute interval)...');
                    loadFootprintAnalysis();
                }
            }, 300000); // 5 minutes
            
            console.log('Footprint Analysis auto-refresh started (every 5 minutes)');
        }
        
        // Stop auto-refresh for Footprint Analysis
        function stopFootprintAnalysisAutoRefresh() {
            if (footprintAnalysisRefreshTimer) {
                clearInterval(footprintAnalysisRefreshTimer);
                footprintAnalysisRefreshTimer = null;
                console.log('Footprint Analysis auto-refresh stopped');
            }
        }
        
        // Initialize auto-refresh for Footprint Analysis
        function initFootprintAnalysisAutoRefresh() {
            if (!footprintAnalysisAutoRefreshStarted) {
                startFootprintAnalysisAutoRefresh();
                footprintAnalysisAutoRefreshStarted = true;
            }
        }
        
        // Start auto-refresh for Critical Micro Levels
        function startMicroLevelsAutoRefresh() {
            const liveMarketTab = document.getElementById('live-market-tab');
            
            if (microLevelsRefreshTimer) {
                clearInterval(microLevelsRefreshTimer);
            }
            
            // Refresh every 5 minutes (300000 ms)
            microLevelsRefreshTimer = setInterval(() => {
                if (liveMarketTab && liveMarketTab.classList.contains('active')) {
                    console.log('Auto-refreshing Critical Micro Levels (5-minute interval)...');
                    loadMicroLevels();
                }
            }, 300000); // 5 minutes
            
            console.log('Critical Micro Levels auto-refresh started (every 5 minutes)');
        }
        
        // Stop auto-refresh for Critical Micro Levels
        function stopMicroLevelsAutoRefresh() {
            if (microLevelsRefreshTimer) {
                clearInterval(microLevelsRefreshTimer);
                microLevelsRefreshTimer = null;
                console.log('Critical Micro Levels auto-refresh stopped');
            }
        }
        
        // Initialize auto-refresh for Critical Micro Levels
        function initMicroLevelsAutoRefresh() {
            if (!microLevelsAutoRefreshStarted) {
                startMicroLevelsAutoRefresh();
                microLevelsAutoRefreshStarted = true;
            }
        }
        
        // Display Micro Levels
        function displayMicroLevels(data) {
            const container = document.getElementById('microLevelsContainer');
            
            // Show missing data if applicable
            if (data.error || !data.success) {
                let html = `<div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; border-left: 3px solid #ffc107; margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 600; color: #856404; margin-bottom: 10px;">âš ï¸ Missing Data</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #856404;">
                `;
                if (data.missing_data && data.missing_data.length > 0) {
                    data.missing_data.forEach(item => {
                        html += `<li style="margin-bottom: 3px;">${item}</li>`;
                    });
                } else {
                    html += `<li style="margin-bottom: 3px;">${data.error || data.message || 'No data available'}</li>`;
                }
                html += `</ul></div>`;
                container.innerHTML = html;
                return;
            }
            
            const currentPrice = data.current_price || 0;
            const support = data.support_levels || [];
            const resistance = data.resistance_levels || [];
            const pivots = data.pivot_levels || [];
            const allLevels = data.all_critical_levels || [];
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 5px;">
                    <strong>Current Price: â‚¹${currentPrice.toFixed(2)}</strong>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">Support Levels (${support.length})</div>
                        ${support.length > 0 ? 
                            support.map(level => `
                                <div style="background: #f8d7da; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                                    <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%<br>
                                        ${level.is_hvn ? 'â­ HVN' : ''}
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #28a745; margin-bottom: 8px;">Resistance Levels (${resistance.length})</div>
                        ${resistance.length > 0 ? 
                            resistance.map(level => `
                                <div style="background: #d4edda; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #28a745;">
                                    <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%<br>
                                        ${level.is_hvn ? 'â­ HVN' : ''}
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #007bff; margin-bottom: 8px;">Pivot Points (${pivots.length})</div>
                        ${pivots.length > 0 ? 
                            pivots.map(level => `
                                <div style="background: #d1ecf1; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #007bff;">
                                    <div style="font-size: 13px; font-weight: bold;">â‚¹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666;">
                                        Strength: ${level.strength} | Distance: ${level.distance_from_current}%
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="color: #999; font-size: 11px;">None identified</div>'
                        }
                    </div>
                </div>
            `;
            
            // Top Critical Levels
            if (allLevels.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">ğŸ¯ Top Critical Levels (by Significance)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${allLevels.slice(0, 5).map(level => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid ${level.type === 'support' ? '#dc3545' : level.type === 'resistance' ? '#28a745' : '#007bff'};">
                                    <div style="font-size: 12px; font-weight: 600;">â‚¹${level.price.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                        Type: ${level.type} | Score: ${level.significance_score || 0}/100
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Export Data Function
        function exportData() {
            const tableName = document.getElementById('exportTableName').value;
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            const columns = document.getElementById('exportColumns').value.trim();
            const format = document.getElementById('exportFormat').value;
            const statusDiv = document.getElementById('exportStatus');
            
            if (!tableName) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a table name</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #666;">Preparing export...</span>';
            
            // Create form data
            const formData = new FormData();
            formData.append('table_name', tableName);
            if (fromDate) formData.append('from_date', fromDate);
            if (toDate) formData.append('to_date', toDate);
            if (columns) formData.append('columns', columns);
            formData.append('export_format', format);
            
            // Submit form to export endpoint
            fetch('/api/export_data', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Export failed');
                    });
                }
                
                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `${tableName}_${fromDate || 'all'}_${toDate || 'all'}.${format === 'excel' ? 'xlsx' : format === 'json' ? 'json' : 'csv'}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Download file
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    statusDiv.innerHTML = '<span style="color: #28a745;">âœ“ Export completed successfully!</span>';
                });
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Export failed'}</span>`;
            });
        }
        
        // Import Data Function
        function importData() {
            const tableName = document.getElementById('importTableName').value;
            const fileInput = document.getElementById('importCsvFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('importStatus');
            
            if (!tableName) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a table name</span>';
                return;
            }
            
            if (!file) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a CSV file</span>';
                return;
            }
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please select a CSV file</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #666;">Importing data...</span>';
            
            // Create form data
            const formData = new FormData();
            formData.append('table_name', tableName);
            formData.append('file', file);
            
            // Submit form to import endpoint
            fetch('/api/import_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error || !data.success) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${data.error || 'Import failed'}</span>`;
                    return;
                }
                
                statusDiv.innerHTML = `
                    <div style="color: #28a745;">
                        <strong>âœ“ Import completed!</strong><br>
                        <small>Total rows: ${data.total_rows || 0} | Inserted: ${data.rows_inserted || 0} | Skipped: ${data.rows_skipped || 0}</small>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error importing data:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Import failed'}</span>`;
            });
        }
        
        function refreshStockPrices() {
            const statusDiv = document.getElementById('refreshStockPricesStatus');
            const btn = document.getElementById('refreshStockPricesBtn');
            
            if (!statusDiv || !btn) {
                console.error('Required elements not found');
                return;
            }
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = 'â³ Refreshing...';
            statusDiv.innerHTML = '<span style="color: #666;">Starting stock price refresh process...</span>';
            
            // Call API endpoint
            fetch('/api/refresh_stock_prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'ğŸ”„ Refresh Stock Prices';
                
                if (data.error || !data.success) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${data.error || data.message || 'Refresh failed'}</span>`;
                    if (data.errors && data.errors.length > 0) {
                        const errorList = data.errors.slice(0, 5).join('<br>');
                        statusDiv.innerHTML += `<div style="margin-top: 10px; font-size: 11px; color: #856404;">${errorList}</div>`;
                    }
                    return;
                }
                
                // Show success message with statistics
                let message = `<div style="color: #28a745;">`;
                message += `<strong>âœ“ ${data.message || 'Stock prices refreshed successfully!'}</strong><br>`;
                if (data.stocks_processed !== undefined && data.records_inserted !== undefined) {
                    message += `<small>Stocks processed: ${data.stocks_processed} | Records inserted/updated: ${data.records_inserted}</small>`;
                }
                message += `</div>`;
                
                if (data.errors && data.errors.length > 0) {
                    message += `<div style="margin-top: 10px; font-size: 11px; color: #856404;">`;
                    message += `<strong>âš ï¸ Some errors occurred:</strong><br>`;
                    message += data.errors.slice(0, 10).join('<br>');
                    if (data.errors.length > 10) {
                        message += `<br><small>... and ${data.errors.length - 10} more errors</small>`;
                    }
                    message += `</div>`;
                }
                
                statusDiv.innerHTML = message;
            })
            .catch(error => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'ğŸ”„ Refresh Stock Prices';
                
                console.error('Error refreshing stock prices:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message || 'Failed to refresh stock prices'}</span>`;
            });
        }
        
        function startKiteWS() {
            const statusDiv = document.getElementById('startKiteWSStatus');
            const btn = document.getElementById('startKiteWSBtn');
            
            if (!statusDiv || !btn) {
                console.error('Required elements not found');
                return;
            }
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = 'â³ Starting KiteWS...';
            statusDiv.innerHTML = '<span style="color: #666;">Starting KiteWS... This may take a few seconds.</span>';
            
            // Call API endpoint
            fetch('/api/start_kitews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'ğŸš€ Start KiteWS (Runs until 3:30 PM IST)';
                
                if (data.success) {
                    statusDiv.innerHTML = `<span style="color: #28a745;">âœ… ${data.message}</span><br>` +
                        `<span style="color: #666; font-size: 11px;">Started at: ${data.started_at}<br>` +
                        `Will run until: ${data.will_run_until}<br>` +
                        `Process ID: ${data.pid}</span>`;
                } else {
                    if (data.message && data.message.includes('already running')) {
                        statusDiv.innerHTML = `<span style="color: #ffc107;">âš ï¸ ${data.message}</span><br>` +
                            `<span style="color: #666; font-size: 11px;">Process ID: ${data.pid}</span>`;
                    } else {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${data.error || data.message || 'Failed to start KiteWS'}</span>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error starting KiteWS:', error);
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'ğŸš€ Start KiteWS (Runs until 3:30 PM IST)';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message || 'Failed to start KiteWS'}</span>`;
            });
        }
        
        function refreshHoldings() {
            const statusDiv = document.getElementById('cronUtilitiesStatus');
            const btn = document.getElementById('refreshHoldingsBtn');
            
            if (!statusDiv || !btn) return;
            
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.innerHTML = 'â³ Refreshing...';
            statusDiv.innerHTML = '<span style="color: #666;">Refreshing holdings from Kite API...</span>';
            
            fetch('/api/refresh_holdings', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ”„ Refresh Holdings';
                statusDiv.innerHTML = data.success 
                    ? `<span style="color: #28a745;">âœ… ${data.message}</span>`
                    : `<span style="color: #dc3545;">âŒ Error: ${data.error || 'Failed'}</span>`;
            })
            .catch(error => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ”„ Refresh Holdings';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message}</span>`;
            });
        }
        
        function calculateTPO() {
            const statusDiv = document.getElementById('cronUtilitiesStatus');
            const btn = document.getElementById('calculateTPOBtn');
            
            if (!statusDiv || !btn) return;
            
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.innerHTML = 'â³ Calculating...';
            statusDiv.innerHTML = '<span style="color: #666;">Starting TPO calculation...</span>';
            
            fetch('/api/calculate_tpo', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ“Š Calculate TPO';
                statusDiv.innerHTML = data.success 
                    ? `<span style="color: #28a745;">âœ… ${data.message}</span><br><span style="color: #666; font-size: 11px;">Process ID: ${data.pid}</span>`
                    : `<span style="color: #dc3545;">âŒ Error: ${data.error || 'Failed'}</span>`;
            })
            .catch(error => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ“Š Calculate TPO';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message}</span>`;
            });
        }
        
        function fetchOptions() {
            const statusDiv = document.getElementById('cronUtilitiesStatus');
            const btn = document.getElementById('fetchOptionsBtn');
            
            if (!statusDiv || !btn) return;
            
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.innerHTML = 'â³ Fetching...';
            statusDiv.innerHTML = '<span style="color: #666;">Fetching options data from Kite API...</span>';
            
            fetch('/api/fetch_options', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ“ˆ Fetch Options';
                statusDiv.innerHTML = data.success 
                    ? `<span style="color: #28a745;">âœ… ${data.message}</span>${data.options_fetched ? `<br><span style="color: #666; font-size: 11px;">Options fetched: ${data.options_fetched}</span>` : ''}`
                    : `<span style="color: #dc3545;">âŒ Error: ${data.error || 'Failed'}</span>`;
            })
            .catch(error => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ“ˆ Fetch Options';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message}</span>`;
            });
        }
        
        function refreshSwingTrades() {
            const statusDiv = document.getElementById('cronUtilitiesStatus');
            const btn = document.getElementById('refreshSwingTradesBtn');
            
            if (!statusDiv || !btn) return;
            
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.innerHTML = 'â³ Refreshing...';
            statusDiv.innerHTML = '<span style="color: #666;">Refreshing swing trade recommendations...</span>';
            
            fetch('/api/refresh_swing_trades', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ¯ Refresh Swing Trades';
                statusDiv.innerHTML = data.success 
                    ? `<span style="color: #28a745;">âœ… ${data.message}</span>`
                    : `<span style="color: #dc3545;">âŒ Error: ${data.error || 'Failed'}</span>`;
            })
            .catch(error => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ¯ Refresh Swing Trades';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message}</span>`;
            });
        }
        
        function refreshMFNAV() {
            const statusDiv = document.getElementById('cronUtilitiesStatus');
            const btn = document.getElementById('refreshMFNAVBtn');
            
            if (!statusDiv || !btn) return;
            
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.innerHTML = 'â³ Refreshing...';
            statusDiv.innerHTML = '<span style="color: #666;">Refreshing MF NAV data...</span>';
            
            fetch('/api/refresh_mf_nav', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ’° Refresh MF NAV';
                statusDiv.innerHTML = data.success 
                    ? `<span style="color: #28a745;">âœ… ${data.message}</span><br><span style="color: #666; font-size: 11px;">MFs processed: ${data.mfs_processed || 0}, Records inserted: ${data.records_inserted || 0}</span>`
                    : `<span style="color: #dc3545;">âŒ Error: ${data.error || 'Failed'}</span>`;
            })
            .catch(error => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ğŸ’° Refresh MF NAV';
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message}</span>`;
            });
        }
        
        function addNewStock() {
            const statusDiv = document.getElementById('addStockStatus');
            const btn = document.getElementById('addNewStockBtn');
            const symbolInput = document.getElementById('newStockSymbol');
            const yahooCodeInput = document.getElementById('newStockYahooCode');
            const countrySelect = document.getElementById('newStockCountry');
            const sectorInput = document.getElementById('newStockSector');
            
            if (!statusDiv || !btn || !symbolInput || !yahooCodeInput) {
                console.error('Required elements not found');
                return;
            }
            
            const symbol = symbolInput.value.trim().toUpperCase();
            const yahooCode = yahooCodeInput.value.trim();
            const country = countrySelect.value.trim() || 'IN';
            const sector = sectorInput.value.trim() || null;
            
            // Validation
            if (!symbol) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">âŒ Please enter a stock symbol</span>';
                return;
            }
            
            if (!yahooCode) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">âŒ Please enter a Yahoo Finance code</span>';
                return;
            }
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = 'â³ Adding Stock & Fetching Data...';
            statusDiv.innerHTML = '<span style="color: #666;">Adding stock to database and fetching 6 months of historical data... This may take a few minutes.</span>';
            
            // Call API endpoint
            fetch('/api/add_new_stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    symbol: symbol,
                    yahoo_code: yahooCode,
                    country: country,
                    sector_code: sector
                })
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'â• Add Stock & Fetch Historical Data (6 Months)';
                
                if (data.error || !data.success) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${data.error || data.message || 'Failed to add stock'}</span>`;
                    return;
                }
                
                // Show success message with statistics
                let message = `<div style="color: #28a745;">`;
                message += `<strong>âœ“ ${data.message || 'Stock added successfully!'}</strong><br>`;
                if (data.records_inserted !== undefined) {
                    message += `<small>Historical records inserted: ${data.records_inserted}</small>`;
                }
                if (data.date_range) {
                    message += `<br><small>Date range: ${data.date_range.start || 'N/A'} to ${data.date_range.end || 'N/A'}</small>`;
                }
                message += `</div>`;
                
                statusDiv.innerHTML = message;
                
                // Clear form fields
                symbolInput.value = '';
                yahooCodeInput.value = '';
                sectorInput.value = '';
                countrySelect.value = 'IN';
            })
            .catch(error => {
                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = 'â• Add Stock & Fetch Historical Data (6 Months)';
                
                console.error('Error adding stock:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ Error: ${error.message || 'Failed to add stock'}</span>`;
            });
        }
        
        // Preview CSV file before import
        document.getElementById('importCsvFile')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewDiv = document.getElementById('importPreview');
            const previewContent = document.getElementById('importPreviewContent');
            
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csv = event.target.result;
                    const lines = csv.split('\n').slice(0, 6); // First 5 data rows + header
                    
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 10px;">';
                    lines.forEach((line, index) => {
                        const cells = line.split(',');
                        html += '<tr>';
                        cells.forEach(cell => {
                            const cellContent = cell.trim().substring(0, 20); // Limit length
                            html += `<td style="padding: 4px; border: 1px solid #ddd; ${index === 0 ? 'font-weight: 600; background-color: #f8f9fa;' : ''}">${cellContent || '&nbsp;'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    previewContent.innerHTML = html;
                    previewDiv.style.display = 'block';
                };
                reader.readAsText(file);
            } else {
                previewDiv.style.display = 'none';
            }
        });
        
        // Load OI data for options in scanner table
        function loadOIDataForOptions(candidates) {
            candidates.forEach(candidate => {
                if (candidate.tradingsymbol) {
                    // Load OI value
                    fetch(`/api/options_data?instrument_token=${candidate.instrument_token}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.option_data) {
                                const oiCell = document.querySelector(`.oi-cell[data-tradingsymbol="${candidate.tradingsymbol}"] .oi-value`);
                                if (oiCell) {
                                    const oi = data.option_data.oi || 0;
                                    oiCell.textContent = formatIndianNumber(oi);
                                    oiCell.style.color = oi > 1000000 ? '#28a745' : oi > 500000 ? '#ffc107' : '#6c757d';
                                }
                            }
                        })
                        .catch(error => console.error('Error loading OI:', error));
                    
                    // Load OI sparkline
                    loadOISparkline(candidate.tradingsymbol, candidate.strike_price, candidate.option_type, candidate.expiry);
                }
            });
        }
        
        // Show Full OI Chart (all options, top 50)
        function showFullOIChart() {
            const modal = document.getElementById('oiChartModal');
            const title = document.getElementById('oiChartTitle');
            const container = document.getElementById('oiChartContainer');
            
            // Open in maximized state by default
            oiChartMaximized = true;
            updateOIModalSize();
            
            title.textContent = 'Open Interest Chart - Top 50 Strikes';
            const imageWrapper = document.getElementById('oiChartImageWrapper');
            imageWrapper.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading chart...</div>';
            modal.style.display = 'block';
            
            // Initialize resize handles
            setTimeout(() => initOIChartResize(), 100);
            
            // Fetch full OI chart (no specific symbol filter)
            let url = `/api/options_oi_analysis?include_chart=true&top_n=50`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        imageWrapper.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load chart'}</div>`;
                        return;
                    }
                    
                    if (data.chart_image) {
                        imageWrapper.innerHTML = `<img id="oiChartImage" src="${data.chart_image}" style="max-width: none; max-height: none; width: 100%; height: auto; object-fit: contain; transition: transform 0.1s;" alt="OI Chart" />`;
                        // Reset zoom when new image loads
                        oiChartZoomLevel = 1;
                        updateOIChartZoom();
                    } else {
                        imageWrapper.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No chart data available</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading OI chart:', error);
                    imageWrapper.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading chart: ${error.message}</div>`;
                });
        }
        
        // Load OI sparkline chart - shows OI gain/loss for specific option only
        function loadOISparkline(tradingsymbol, strike, optionType, expiry, canvasIdOverride = null) {
            const canvasId = canvasIdOverride || `oi-sparkline-${tradingsymbol}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            // Get historical OI data for this specific option only
            let expiryStr = null;
            if (expiry) {
                if (typeof expiry === 'string' && expiry.includes('-')) {
                    expiryStr = expiry.split('T')[0]; // Already in YYYY-MM-DD format
                } else if (expiry instanceof Date) {
                    expiryStr = expiry.toISOString().split('T')[0];
                }
            }
            
            let url = `/api/options_oi_history?tradingsymbol=${encodeURIComponent(tradingsymbol)}&strike_price=${strike}&option_type=${optionType}&days=7`;
            if (expiryStr) {
                url += `&expiry=${expiryStr}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.oi_history && data.oi_history.length > 0) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Extract OI values over time
                        const oiValues = data.oi_history.map(item => item.oi || 0);
                        
                        if (oiValues.length === 0) return;
                        
                        // Calculate min and max OI for scaling
                        const minOI = Math.min(...oiValues);
                        const maxOI = Math.max(...oiValues);
                        const oiRange = maxOI - minOI || 1; // Avoid division by zero
                        
                        // Draw sparkline as a line chart showing OI change over time
                        const padding = 2;
                        const chartWidth = canvas.width - (padding * 2);
                        const chartHeight = canvas.height - (padding * 2);
                        
                        // Create path for filled area
                        ctx.beginPath();
                        ctx.moveTo(padding, padding + chartHeight); // Start at bottom left
                        
                        oiValues.forEach((oi, index) => {
                            const x = padding + (index / (oiValues.length - 1 || 1)) * chartWidth;
                            const y = padding + chartHeight - ((oi - minOI) / oiRange) * chartHeight;
                            ctx.lineTo(x, y);
                        });
                        
                        ctx.lineTo(padding + chartWidth, padding + chartHeight); // Bottom right
                        ctx.closePath(); // Close the path
                        
                        // Fill area under the line
                        ctx.fillStyle = optionType === 'CE' ? 'rgba(40, 167, 69, 0.2)' : 'rgba(220, 53, 69, 0.2)';
                        ctx.fill();
                        
                        // Draw the line on top
                        ctx.beginPath();
                        oiValues.forEach((oi, index) => {
                            const x = padding + (index / (oiValues.length - 1 || 1)) * chartWidth;
                            const y = padding + chartHeight - ((oi - minOI) / oiRange) * chartHeight;
                            
                            if (index === 0) {
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        });
                        
                        ctx.strokeStyle = optionType === 'CE' ? '#28a745' : '#dc3545';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Draw a dot at the latest OI value
                        if (oiValues.length > 0) {
                            const lastOI = oiValues[oiValues.length - 1];
                            const lastX = padding + chartWidth;
                            const lastY = padding + chartHeight - ((lastOI - minOI) / oiRange) * chartHeight;
                            
                            ctx.fillStyle = optionType === 'CE' ? '#28a745' : '#dc3545';
                            ctx.beginPath();
                            ctx.arc(lastX, lastY, 3, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                    } else {
                        // No data - show placeholder
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#999';
                        ctx.font = '8px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                    }
                })
                .catch(error => {
                    console.error('Error loading OI sparkline:', error);
                    // Show error placeholder
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#dc3545';
                    ctx.font = '8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Error', canvas.width / 2, canvas.height / 2);
                });
        }
        
        // Load Top 5 OI Options
        function loadTop5OIOptions() {
            const container = document.getElementById('top5OIContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading top 5 options by Open Interest...</div>';
            
            fetch('/api/options_oi_analysis?top_n=5&include_chart=false')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load OI data'}</div>`;
                        return;
                    }
                    
                    if (!data.oi_data || data.oi_data.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No OI data available</div>';
                        return;
                    }
                    
                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 5px;">
                            <strong>Top 5 Options by Open Interest</strong> (Total OI: ${formatIndianNumber(data.summary.total_oi)})
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background-color: #17a2b8; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 11px;">Symbol</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Type</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Strike</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">OI</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Volume</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">Price</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.oi_data.slice(0, 5).forEach((option, index) => {
                        const optionTypeColor = option.option_type === 'CE' ? '#28a745' : '#dc3545';
                        const optionTypeBg = option.option_type === 'CE' ? '#d4edda' : '#f8d7da';
                        
                        html += `
                            <tr style="background-color: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};">
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600; font-size: 11px;">${option.tradingsymbol || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <span style="padding: 3px 8px; border-radius: 3px; background-color: ${optionTypeBg}; color: ${optionTypeColor}; font-weight: 600; font-size: 10px;">
                                        ${option.option_type}
                                    </span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 11px;">â‚¹${option.strike_price.toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 11px; color: ${optionTypeColor};">
                                    ${formatIndianNumber(option.total_oi || 0)}
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">${formatIndianNumber(option.total_volume || 0)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 11px;">â‚¹${(option.avg_last_price || 0).toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <button style="background: #17a2b8; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 10px;" onclick="event.stopPropagation(); showOIChartForOption('${option.tradingsymbol || ''}', ${option.strike_price}, '${option.option_type}', '${option.expiry || ''}')">View Chart</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading top 5 OI options:', error);
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading OI data: ${error.message}</div>`;
                });
        }
        
        // Track OI chart maximize state and zoom
        let oiChartMaximized = false;
        let oiChartZoomLevel = 1;
        let isResizing = false;
        let resizeHandle = null;
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startLeft = 0;
        let startTop = 0;
        
        // Show OI Chart for a specific option - shows OI change over time for that strike only
        function showOIChartForOption(tradingsymbol, strike, optionType, expiry) {
            const modal = document.getElementById('oiChartModal');
            const title = document.getElementById('oiChartTitle');
            const container = document.getElementById('oiChartContainer');
            
            // Open in maximized state by default
            oiChartMaximized = true;
            updateOIModalSize();
            
            // Initialize resize handles
            setTimeout(() => initOIChartResize(), 100);
            
            title.textContent = `OI Change Over Time - ${tradingsymbol} (${strike} ${optionType})`;
            const imageWrapper = document.getElementById('oiChartImageWrapper');
            imageWrapper.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading chart...</div>';
            modal.style.display = 'block';
            
            let expiryStr = null;
            if (expiry) {
                if (typeof expiry === 'string' && expiry.includes('-')) {
                    expiryStr = expiry.split('T')[0]; // Already in YYYY-MM-DD format
                } else if (expiry instanceof Date) {
                    expiryStr = expiry.toISOString().split('T')[0];
                }
            }
            
            // Get OI change chart for this specific strike price only
            let url = `/api/options_oi_chart_for_strike?tradingsymbol=${encodeURIComponent(tradingsymbol)}&strike_price=${strike}&option_type=${optionType}&days=7`;
            if (expiryStr) {
                url += `&expiry=${expiryStr}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error: ${data.error || 'Failed to load chart'}</div>`;
                        return;
                    }
                    
                    if (data.chart_image) {
                        const imageWrapper = document.getElementById('oiChartImageWrapper');
                        imageWrapper.innerHTML = `<img id="oiChartImage" src="${data.chart_image}" style="max-width: none; max-height: none; width: 100%; height: auto; object-fit: contain; transition: transform 0.1s;" alt="OI Chart" />`;
                        // Reset zoom when new image loads
                        oiChartZoomLevel = 1;
                        updateOIChartZoom();
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No chart data available</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading OI chart:', error);
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading chart: ${error.message}</div>`;
                });
        }
        
        // Show OI Chart Modal (generic function for backward compatibility)
        function showOIChart(tradingsymbol, strike, optionType, expiry) {
            showOIChartForOption(tradingsymbol, strike, optionType, expiry);
        }
        
        // Toggle OI Chart Maximize
        function toggleOIMaximize() {
            oiChartMaximized = !oiChartMaximized;
            updateOIModalSize();
        }
        
        // Update OI Modal Size
        function updateOIModalSize() {
            const modalContent = document.getElementById('oiChartModalContent');
            const maximizeBtn = document.getElementById('oiChartMaximizeBtn');
            
            if (oiChartMaximized) {
                // Maximized: 90% width and height
                modalContent.style.width = '90%';
                modalContent.style.height = '90vh';
                modalContent.style.margin = '5% auto';
                modalContent.style.left = 'auto';
                modalContent.style.top = 'auto';
                maximizeBtn.textContent = 'â›¶ Restore';
                maximizeBtn.style.background = '#6c757d';
            } else {
                // Normal: 80% width and height
                modalContent.style.width = '80%';
                modalContent.style.height = '80vh';
                modalContent.style.margin = '10% auto';
                modalContent.style.left = 'auto';
                modalContent.style.top = 'auto';
                maximizeBtn.textContent = 'â›¶ Maximize';
                maximizeBtn.style.background = '#17a2b8';
            }
        }
        
        // Zoom OI Chart
        function zoomOIChart(action) {
            const chartImage = document.getElementById('oiChartImage');
            if (!chartImage) return;
            
            if (action === 'in') {
                oiChartZoomLevel = Math.min(oiChartZoomLevel + 0.25, 5); // Max 5x zoom
            } else if (action === 'out') {
                oiChartZoomLevel = Math.max(oiChartZoomLevel - 0.25, 0.25); // Min 0.25x zoom
            } else if (action === 'reset') {
                oiChartZoomLevel = 1;
            }
            
            updateOIChartZoom();
        }
        
        // Update OI Chart Zoom
        function updateOIChartZoom() {
            const chartImage = document.getElementById('oiChartImage');
            if (!chartImage) return;
            
            chartImage.style.transform = `scale(${oiChartZoomLevel})`;
            chartImage.style.transformOrigin = 'center center';
        }
        
        // Handle mouse wheel zoom for OI Chart
        function handleOIChartWheel(event) {
            if (event.ctrlKey || event.metaKey) {
                event.preventDefault();
                const delta = event.deltaY > 0 ? -0.1 : 0.1;
                oiChartZoomLevel = Math.max(0.25, Math.min(5, oiChartZoomLevel + delta));
                updateOIChartZoom();
            }
        }
        
        // Initialize resize handles for OI Chart Modal
        function initOIChartResize() {
            const modalContent = document.getElementById('oiChartModalContent');
            if (!modalContent) return;
            
            // Remove existing event listeners by cloning and replacing
            const handles = modalContent.querySelectorAll('.resize-handle');
            
            handles.forEach(handle => {
                // Remove old listeners by cloning
                const newHandle = handle.cloneNode(true);
                handle.parentNode.replaceChild(newHandle, handle);
                
                // Add new listener
                newHandle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;
                    resizeHandle = newHandle;
                    
                    const rect = modalContent.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = rect.width;
                    startHeight = rect.height;
                    startLeft = rect.left;
                    startTop = rect.top;
                    
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                });
            });
        }
        
        // Handle resize
        function handleResize(e) {
            if (!isResizing || !resizeHandle) return;
            
            const modalContent = document.getElementById('oiChartModalContent');
            if (!modalContent) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            const handleClass = resizeHandle.className;
            
            // Calculate new dimensions based on handle
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;
            
            // Handle different resize directions
            if (handleClass.includes('resize-handle-e') || handleClass.includes('resize-handle-ne') || handleClass.includes('resize-handle-se')) {
                newWidth = startWidth + deltaX;
            }
            if (handleClass.includes('resize-handle-w') || handleClass.includes('resize-handle-nw') || handleClass.includes('resize-handle-sw')) {
                newWidth = startWidth - deltaX;
                newLeft = startLeft + deltaX;
            }
            if (handleClass.includes('resize-handle-s') || handleClass.includes('resize-handle-se') || handleClass.includes('resize-handle-sw')) {
                newHeight = startHeight + deltaY;
            }
            if (handleClass.includes('resize-handle-n') || handleClass.includes('resize-handle-ne') || handleClass.includes('resize-handle-nw')) {
                newHeight = startHeight - deltaY;
                newTop = startTop + deltaY;
            }
            
            // Apply minimum size constraints
            const minWidth = 400;
            const minHeight = 300;
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 20;
            
            // Constrain width
            if (newWidth >= minWidth && newWidth <= maxWidth) {
                modalContent.style.width = newWidth + 'px';
                if (newLeft !== startLeft) {
                    modalContent.style.left = newLeft + 'px';
                    modalContent.style.right = 'auto';
                    modalContent.style.margin = '0';
                } else {
                    // Center horizontally if not resizing from left/right
                    modalContent.style.left = 'auto';
                    modalContent.style.right = 'auto';
                    modalContent.style.marginLeft = 'auto';
                    modalContent.style.marginRight = 'auto';
                }
            }
            
            // Constrain height
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                modalContent.style.height = newHeight + 'px';
                if (newTop !== startTop) {
                    modalContent.style.top = newTop + 'px';
                    modalContent.style.bottom = 'auto';
                    modalContent.style.margin = '0';
                } else {
                    // Center vertically if not resizing from top/bottom
                    modalContent.style.top = 'auto';
                    modalContent.style.bottom = 'auto';
                    modalContent.style.marginTop = 'auto';
                    modalContent.style.marginBottom = 'auto';
                }
            }
        }
        
        // Stop resize
        function stopResize() {
            isResizing = false;
            resizeHandle = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        // Close OI Chart Modal
        function closeOIChart() {
            const modal = document.getElementById('oiChartModal');
            modal.style.display = 'none';
            // Reset to normal size when closing
            oiChartMaximized = false;
            oiChartZoomLevel = 1;
            updateOIModalSize();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('oiChartModal');
            if (event.target === modal) {
                closeOIChart();
            }
        }
        
        // Initialize resize handles when modal is shown
        document.addEventListener('DOMContentLoaded', function() {
            initOIChartResize();
        });
        
        // Fetch wrapper - respects HTTP cache headers from server
        // The browser's HTTP cache will automatically cache responses based on 
        // Cache-Control headers sent by the API (see get_cache_headers in KiteAccessToken.py)
        // Tab-specific loading is handled by TabLoadTracker to prevent unnecessary data fetching
        async function fetchData(url, options = {}) {
            // Use default cache mode which respects HTTP cache headers
            // This allows browser to cache based on Cache-Control headers from server
            return await fetch(url, { ...options, cache: options.cache || 'default' });
        }
        
        // Load initial data - ONLY Live Market tab data
        document.addEventListener('DOMContentLoaded', function() {
            // Only load Live Market tab data initially
            loadMarketBiasAnalysis();
            loadFuturesOrderFlow();
            loadPositions();
            loadPremarketAnalysis(); // Load pre-market analysis on page load
            loadOptionsScanner(); // Load options scanner on page load
            loadTop5OIOptions(); // Load top 5 OI options on page load
            load5DayTPOChart(); // Load 5-day TPO chart on page load
            
            // Load Order Flow Analysis, Footprint Analysis, and Critical Micro Levels on page load
            loadOrderFlowAnalysis();
            loadFootprintAnalysis();
            loadMicroLevels();
            
            // Initialize auto-refresh for Order Flow Analysis, Footprint Analysis, and Critical Micro Levels
            initOrderFlowAnalysisAutoRefresh();
            initFootprintAnalysisAutoRefresh();
            initMicroLevelsAutoRefresh();
            
            // Mark Live Market tab as loaded
            TabLoadTracker.markLoaded('live-market');
            
            initializeRefreshSystem();
            
            // Start derivatives suggestions refresh (every 1 minute)
            startDerivativesSuggestionsRefresh();
        });
        
        // Cleanup polling when page unloads
        window.addEventListener('beforeunload', function() {
            stopGainersLosersPolling();
            stopOrderFlowAnalysisAutoRefresh();
            stopFootprintAnalysisAutoRefresh();
            stopMicroLevelsAutoRefresh();
        });

        // Tab Switching Functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Start/stop polling based on tab
                if (tabName === 'gainers-losers') {
                    // Start polling for gainers/losers updates
                    startGainersLosersPolling();
                } else {
                    // Stop polling when switching away from Stocks tab
                    stopGainersLosersPolling();
                }
                
                // Load data based on tab name
                if (tabName === 'gainers-losers') {
                    // Always load gainers/losers when tab is clicked (refresh every time)
                    loadGainersLosers();
                    
                    // Only load other data if tab hasn't been loaded before
                    if (!TabLoadTracker.isLoaded(tabName)) {
                        // Load swing trade recommendations automatically when tab is opened
                        loadSwingTrades();
                        // Initialize auto-refresh for swing trades (30-minute interval)
                        initSwingTradeAutoRefresh();
                        // Set prediction days selector to 60 days and load top gainers
                        const daysSelect = document.getElementById('predictionDaysSelect');
                        if (daysSelect) {
                            daysSelect.value = '60';
                        }
                        // Load top gainers when Stocks tab is active (with 60 days)
                        loadTopGainers();
                        // Check if predictions exist, show warning if not
                        checkProphetPredictionsExist();
                        TabLoadTracker.markLoaded(tabName);
                    }
                } else if (tabName === 'holdings') {
                    if (!TabLoadTracker.isLoaded(tabName)) {
                        {% if show_holdings %}
                        // Load P&L, Portfolio chart, and Portfolio Hedge Analysis when Holdings tab is shown
                        loadPnlSummary();
                        loadHoldingsPage(1); // Load first page of holdings (this will also load sparklines and patterns)
                        loadMFHoldings();
                        const daysSelector = document.getElementById('portfolioDaysSelector');
                        if (daysSelector) {
                            loadPortfolioChart(daysSelector.value || 30);
                        }
                        // Load portfolio hedge analysis
                        loadPortfolioHedgeAnalysis();
                        // Load sparklines for initial server-rendered holdings
                        loadSparklines();
                        TabLoadTracker.markLoaded(tabName);
                        {% endif %}
                    }
                } else if (tabName === 'live-market') {
                    // Live Market is already loaded on initial load
                    // Ensure auto-refresh is running for Order Flow, Footprint, and Micro Levels
                    initOrderFlowAnalysisAutoRefresh();
                    initFootprintAnalysisAutoRefresh();
                    initMicroLevelsAutoRefresh();
                    if (!TabLoadTracker.isLoaded(tabName)) {
                        TabLoadTracker.markLoaded(tabName);
                    }
                } else {
                    // Stop auto-refresh when switching away from Live Market tab
                    stopOrderFlowAnalysisAutoRefresh();
                    stopFootprintAnalysisAutoRefresh();
                    stopMicroLevelsAutoRefresh();
                }
                
                if (tabName === 'utilities') {
                    if (!TabLoadTracker.isLoaded(tabName)) {
                        // Utilities tab doesn't need data loading
                        TabLoadTracker.markLoaded(tabName);
                    }
                }
            }
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
    </script>
    
    <!-- End Holdings Tab Content -->

    <!-- Candlestick Chart Modal -->
    <div id="candlestickModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); padding: 20px; border: 1px solid #888; width: 80vw; height: 80vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                <h2 id="modalStockSymbol" style="margin: 0; font-size: 1.5em;">Stock Chart</h2>
                <button onclick="closeCandlestickModal()" style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 14px;">Close</button>
            </div>
            <div style="margin-bottom: 15px; flex-shrink: 0;">
                <label for="chartDays">Days to display:</label>
                <select id="chartDays" onchange="updateCandlestickChart()" style="padding: 5px 10px; margin-left: 10px;">
                    <option value="7">7 days</option>
                    <option value="15">15 days</option>
                    <option value="30">30 days</option>
                    <option value="60">60 days</option>
                    <option value="90" selected>90 days</option>
                </select>
            </div>
            <div style="flex: 1; overflow: hidden; position: relative;">
                <canvas id="candlestickChartCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentStockSymbol = '';
        let candlestickChart = null;

        // Helper function to draw sparkline on canvas
        function drawSparkline(canvas, prices) {
            if (!canvas || !prices || prices.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 5;
            
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice || 1;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Determine color based on trend
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];
            const color = lastPrice >= firstPrice ? '#28a745' : '#dc3545';
            
            // Draw line
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < prices.length; i++) {
                const x = padding + (i / (prices.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((prices[i] - minPrice) / priceRange) * (height - 2 * padding);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }
        
        // Batch load sparklines for multiple symbols
        function loadSparklinesBatch(symbols, canvasIdMap = {}) {
            if (!symbols || symbols.length === 0) return;
            
            // Extract actual symbols from symbolOrId format
            const actualSymbols = symbols.map(symbolOrId => {
                if (symbolOrId.startsWith('sparkline-')) {
                    const withoutPrefix = symbolOrId.replace(/^sparkline-/, '');
                    const knownMiddlePrefixes = ['swing', 'gainer', 'loser', 'ajax'];
                    const parts = withoutPrefix.split('-');
                    if (parts.length >= 2 && knownMiddlePrefixes.includes(parts[0])) {
                        return parts.slice(1).join('-');
                    }
                    return withoutPrefix;
                } else if (symbolOrId.includes('-')) {
                    const knownPrefixes = ['gainer', 'loser', 'ajax', 'swing'];
                    const parts = symbolOrId.split('-');
                    if (parts.length >= 2 && knownPrefixes.includes(parts[0])) {
                        return parts.slice(1).join('-');
                    }
                }
                return symbolOrId;
            });
            
            // Remove duplicates
            const uniqueSymbols = [...new Set(actualSymbols)];
            
            // Batch fetch sparklines
            fetch('/api/sparklines/batch?days=90', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ symbols: uniqueSymbols })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading batch sparklines:', data.error);
                    return;
                }
                
                // Draw sparklines for each symbol
                uniqueSymbols.forEach(symbol => {
                    const sparklineData = data.sparklines[symbol];
                    if (!sparklineData || !sparklineData.prices || sparklineData.prices.length === 0) {
                        return;
                    }
                    
                    // Try to find canvas with various ID patterns
                    let canvas = null;
                    if (canvasIdMap[symbol]) {
                        canvas = document.getElementById(canvasIdMap[symbol]);
                    }
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-${symbol}`);
                    }
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-ajax-${symbol}`);
                    }
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-swing-${symbol}`);
                    }
                    if (!canvas) {
                        // Try to find by checking original symbolOrId format
                        const originalSymbolOrId = symbols.find(s => {
                            const extracted = s.startsWith('sparkline-') 
                                ? s.replace(/^sparkline-/, '').replace(/^(swing|ajax|gainer|loser)-/, '')
                                : s.includes('-') 
                                    ? s.split('-').slice(1).join('-')
                                    : s;
                            return extracted === symbol;
                        });
                        if (originalSymbolOrId) {
                            if (originalSymbolOrId.startsWith('sparkline-')) {
                                canvas = document.getElementById(originalSymbolOrId);
                            } else {
                                canvas = document.getElementById(`sparkline-${originalSymbolOrId}`);
                            }
                        }
                    }
                    
                    if (canvas) {
                        drawSparkline(canvas, sparklineData.prices);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading batch sparklines:', error);
                // Fallback to individual requests
                symbols.forEach(symbol => loadSparkline(symbol));
            });
        }
        
        function loadSparklines() {
            {% if show_holdings and holdings_info.holdings %}
            const symbols = [
                {% for holding in holdings_info.holdings %}
                '{{ holding.trading_symbol }}',
                {% endfor %}
            ];
            loadSparklinesBatch(symbols);
            
            // Load patterns for initial holdings
            const initialHoldings = [
                {% for holding in holdings_info.holdings %}
                { trading_symbol: '{{ holding.trading_symbol }}' },
                {% endfor %}
            ];
            loadHoldingsPatterns(initialHoldings);
            {% endif %}
        }

        function loadSparkline(symbolOrId) {
            // Extract actual symbol from ID if it's a prefixed ID
            let symbol = symbolOrId;
            let canvasId = symbolOrId;
            
            // Handle prefixed IDs like "sparkline-swing-RELIANCE", "sparkline-gainer-RELIANCE", etc.
            if (symbolOrId.startsWith('sparkline-')) {
                canvasId = symbolOrId; // Keep the full ID for canvas lookup
                // Extract the symbol by removing "sparkline-" prefix and any known middle prefixes
                const withoutPrefix = symbolOrId.replace(/^sparkline-/, '');
                const knownMiddlePrefixes = ['swing', 'gainer', 'loser', 'ajax'];
                const parts = withoutPrefix.split('-');
                if (parts.length >= 2 && knownMiddlePrefixes.includes(parts[0])) {
                    // Remove the middle prefix to get the actual symbol
                    symbol = parts.slice(1).join('-');
                } else {
                    symbol = withoutPrefix;
                }
            } else if (symbolOrId.includes('-')) {
                // Handle formats like "gainer-RELIANCE" or "swing-RELIANCE"
                const knownPrefixes = ['gainer', 'loser', 'ajax', 'swing'];
                const parts = symbolOrId.split('-');
                if (parts.length >= 2 && knownPrefixes.includes(parts[0])) {
                    // Remove the known prefix to get the actual symbol
                    symbol = parts.slice(1).join('-');
                    canvasId = `sparkline-${symbolOrId}`;
                }
            } else {
                canvasId = `sparkline-${symbolOrId}`;
            }
            
            fetch(`/api/sparkline/${symbol}?days=90`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(`Error loading sparkline for ${symbol}:`, data.error);
                        return;
                    }
                    
                    // Try to find canvas with various ID patterns
                    let canvas = document.getElementById(`sparkline-${symbol}`);
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-ajax-${symbol}`);
                    }
                    if (!canvas) {
                        canvas = document.getElementById(`sparkline-swing-${symbol}`);
                    }
                    if (!canvas && canvasId && canvasId !== `sparkline-${symbol}`) {
                        // If canvasId is provided (e.g., "swing-RELIANCE"), try to extract and find
                        const extractedSymbol = canvasId.replace(/^(sparkline-)?(swing-|ajax-)?/, '').replace(/^swing-/, '');
                        if (extractedSymbol && extractedSymbol !== canvasId) {
                            canvas = document.getElementById(`sparkline-swing-${extractedSymbol}`);
                            if (!canvas) {
                                canvas = document.getElementById(`sparkline-${extractedSymbol}`);
                            }
                        }
                        if (!canvas) {
                            canvas = document.getElementById(canvasId);
                        }
                    }
                    if (!canvas) {
                        console.warn(`Canvas not found for symbol: ${symbol}, canvasId: ${canvasId}`);
                        return;
                    }
                    
                    // Use helper function to draw sparkline
                    drawSparkline(canvas, data.prices);
                })
                .catch(error => console.error(`Error loading sparkline for ${symbol}:`, error));
        }
        
        // Swing Trade Recommendations Functions
        let allSwingTrades = [];
        let filteredSwingTrades = [];
        let swingTradeScanInProgress = false;
        let swingTradeRefreshInterval = null;
        let swingTradeCurrentPage = 1;
        let swingTradeItemsPerPage = 10;
        let swingTradeSortColumn = 'confidence'; // Default sort by confidence
        let swingTradeSortDirection = 'desc'; // Default descending
        
        function loadSwingTrades() {
            // Prevent multiple simultaneous scans
            if (swingTradeScanInProgress) {
                console.log('Swing trade scan already in progress, skipping...');
                return;
            }
            
            const statusDiv = document.getElementById('swingTradesStatus');
            const tbody = document.getElementById('swingTradesTableBody');
            const criteriaDiv = document.getElementById('swingTradeFilterCriteria');
            
            if (!statusDiv || !tbody || !criteriaDiv) {
                console.error('Required elements not found for swing trades');
                return;
            }
            
            swingTradeScanInProgress = true;
            statusDiv.innerHTML = '<span style="color: #666;">â³ Scanning stocks and generating recommendations... (This may take a few minutes)</span>';
            tbody.innerHTML = '<tr><td colspan="11" style="padding: 15px; text-align: center; color: #666; font-size: 14px;">Scanning stocks...</td></tr>';
            
            fetch('/api/swing_trades?min_gain=10&max_gain=20&min_confidence=70&limit=100&scan_limit=500')
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${data.error || 'Failed to load recommendations'}</span>`;
                        tbody.innerHTML = '<tr><td colspan="11" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">Error loading recommendations</td></tr>';
                        return;
                    }
                    
                    allSwingTrades = data.recommendations || [];
                    filteredSwingTrades = [...allSwingTrades];
                    swingTradeCurrentPage = 1; // Reset to first page on new data
                    // Reset sort to default (confidence desc)
                    swingTradeSortColumn = 'confidence';
                    swingTradeSortDirection = 'desc';
                    updateSwingTradeSortIcons();
                    
                    // Debug: Log prophet predictions count
                    if (allSwingTrades.length > 0) {
                        const withPredictions = allSwingTrades.filter(t => t.prophet_prediction_pct !== undefined && t.prophet_prediction_pct !== null);
                        console.log(`Swing trades loaded: ${allSwingTrades.length} total, ${withPredictions.length} with Prophet predictions`);
                        if (withPredictions.length > 0) {
                            console.log('Sample trade with prediction:', withPredictions[0]);
                        }
                    }
                    
                    // Group by symbol to count unique stocks
                    const groupedTrades = {};
                    allSwingTrades.forEach(trade => {
                        const symbol = trade.scrip_id || '-';
                        if (!groupedTrades[symbol]) {
                            groupedTrades[symbol] = [];
                        }
                        groupedTrades[symbol].push(trade);
                    });
                    const uniqueStocksCount = Object.keys(groupedTrades).length;
                    const totalRecommendationsCount = allSwingTrades.length;
                    
                    // Display filtering criteria
                    if (data.filtering_criteria) {
                        const criteria = data.filtering_criteria;
                        let criteriaText = `Min Gain: ${criteria.min_gain}% | Max Gain: ${criteria.max_gain}% | Min Confidence: ${criteria.min_confidence}`;
                        if (criteria.pattern_type) {
                            criteriaText += ` | Pattern: ${criteria.pattern_type}`;
                        }
                        criteriaDiv.textContent = criteriaText;
                    }
                    
                    displaySwingTrades();
                    // Initialize sort icons after first load
                    updateSwingTradeSortIcons();
                    
                    // Show status with unique stocks count (matching pagination display)
                    statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ Loaded ${uniqueStocksCount} stocks (${totalRecommendationsCount} pattern${totalRecommendationsCount !== 1 ? 's' : ''})</span>`;
                    swingTradeScanInProgress = false;
                })
                .catch(error => {
                    console.error('Error loading swing trades:', error);
                    statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Failed to load recommendations'}</span>`;
                    tbody.innerHTML = '<tr><td colspan="11" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">Error loading recommendations</td></tr>';
                    swingTradeScanInProgress = false;
                });
        }
        
        // Set up 30-minute auto-refresh for swing trades (only when Stocks tab is active)
        function startSwingTradeAutoRefresh() {
            // Clear existing interval if any
            if (swingTradeRefreshInterval) {
                clearInterval(swingTradeRefreshInterval);
            }
            
            // Refresh every 30 minutes (30 * 60 * 1000 milliseconds)
            swingTradeRefreshInterval = setInterval(() => {
                // Only refresh if Stocks tab is currently active and no scan is in progress
                const stocksTab = document.getElementById('gainers-losers-tab');
                if (stocksTab && stocksTab.classList.contains('active') && !swingTradeScanInProgress) {
                    console.log('Auto-refreshing swing trade recommendations (30-minute interval)...');
                    loadSwingTrades();
                }
            }, 30 * 60 * 1000); // 30 minutes
            
            console.log('Swing trade auto-refresh started (every 30 minutes)');
        }
        
        // Stop auto-refresh
        function stopSwingTradeAutoRefresh() {
            if (swingTradeRefreshInterval) {
                clearInterval(swingTradeRefreshInterval);
                swingTradeRefreshInterval = null;
                console.log('Swing trade auto-refresh stopped');
            }
        }
        
        // Start auto-refresh when Stocks tab is first activated
        let swingTradeAutoRefreshStarted = false;
        function initSwingTradeAutoRefresh() {
            if (!swingTradeAutoRefreshStarted) {
                startSwingTradeAutoRefresh();
                swingTradeAutoRefreshStarted = true;
            }
        }
        
        function filterSwingTrades() {
            const patternFilter = document.getElementById('swingTradePatternFilter')?.value || '';
            const gainFilter = document.getElementById('swingTradeGainFilter')?.value || '';
            
            filteredSwingTrades = allSwingTrades.filter(trade => {
                if (patternFilter && trade.pattern_type !== patternFilter) {
                    return false;
                }
                
                if (gainFilter) {
                    const gain = trade.potential_gain_pct || 0;
                    if (gainFilter === '10-15' && (gain < 10 || gain > 15)) {
                        return false;
                    }
                    if (gainFilter === '15-20' && (gain < 15 || gain > 20)) {
                        return false;
                    }
                    if (gainFilter === '20+' && gain < 20) {
                        return false;
                    }
                }
                
                return true;
            });
            
            swingTradeCurrentPage = 1; // Reset to first page when filtering
            displaySwingTrades();
        }
        
        function displaySwingTrades() {
            const tbody = document.getElementById('swingTradesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredSwingTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="padding: 15px; text-align: center; color: #666; font-size: 14px;">No recommendations found matching the filters</td></tr>';
                updateSwingTradePagination(0);
                return;
            }
            
            // Group trades by stock symbol
            const groupedTrades = {};
            filteredSwingTrades.forEach(trade => {
                const symbol = trade.scrip_id || '-';
                if (!groupedTrades[symbol]) {
                    groupedTrades[symbol] = [];
                }
                groupedTrades[symbol].push(trade);
            });
            
            // Sort stocks based on current sort column and direction
            const sortedSymbols = Object.keys(groupedTrades).sort((a, b) => {
                let valueA, valueB;
                
                switch(swingTradeSortColumn) {
                    case 'symbol':
                        valueA = a.toUpperCase();
                        valueB = b.toUpperCase();
                        break;
                    case 'pattern':
                        // Get first pattern type for each symbol
                        const patternA = groupedTrades[a][0]?.pattern_type || '';
                        const patternB = groupedTrades[b][0]?.pattern_type || '';
                        valueA = patternA.toLowerCase();
                        valueB = patternB.toLowerCase();
                        break;
                    case 'gain':
                        // Get max potential gain for each symbol
                        valueA = Math.max(...groupedTrades[a].map(t => t.potential_gain_pct || 0));
                        valueB = Math.max(...groupedTrades[b].map(t => t.potential_gain_pct || 0));
                        break;
                    case 'confidence':
                        // Get max confidence for each symbol
                        valueA = Math.max(...groupedTrades[a].map(t => t.confidence_score || 0));
                        valueB = Math.max(...groupedTrades[b].map(t => t.confidence_score || 0));
                        break;
                    case 'ghost':
                        // Get max ghost prediction for each symbol
                        valueA = Math.max(...groupedTrades[a].map(t => t.prophet_prediction_pct || -Infinity));
                        valueB = Math.max(...groupedTrades[b].map(t => t.prophet_prediction_pct || -Infinity));
                        // Handle cases where no prediction exists
                        if (valueA === -Infinity) valueA = -999999;
                        if (valueB === -Infinity) valueB = -999999;
                        break;
                    default:
                        valueA = Math.max(...groupedTrades[a].map(t => t.confidence_score || 0));
                        valueB = Math.max(...groupedTrades[b].map(t => t.confidence_score || 0));
                }
                
                let comparison = 0;
                if (valueA > valueB) {
                    comparison = 1;
                } else if (valueA < valueB) {
                    comparison = -1;
                }
                
                return swingTradeSortDirection === 'asc' ? comparison : -comparison;
            });
            
            // Calculate pagination
            const totalItems = sortedSymbols.length;
            const totalPages = Math.ceil(totalItems / swingTradeItemsPerPage);
            const startIndex = (swingTradeCurrentPage - 1) * swingTradeItemsPerPage;
            const endIndex = Math.min(startIndex + swingTradeItemsPerPage, totalItems);
            const currentPageSymbols = sortedSymbols.slice(startIndex, endIndex);
            
            const symbols = [];
            
            currentPageSymbols.forEach(symbol => {
                const trades = groupedTrades[symbol];
                const patterns = trades.map(t => t.pattern_type).join(', ');
                const entryPrice = trades[0].entry_price || 0;
                const targetPrice = Math.max(...trades.map(t => t.target_price || 0));
                const stopLoss = Math.min(...trades.map(t => t.stop_loss || 0));
                const maxGain = Math.max(...trades.map(t => t.potential_gain_pct || 0));
                const maxRR = Math.max(...trades.map(t => t.risk_reward_ratio || 0));
                const maxConfidence = Math.max(...trades.map(t => t.confidence_score || 0));
                const avgHoldingPeriod = Math.round(trades.reduce((sum, t) => sum + (t.holding_period_days || 0), 0) / trades.length);
                const rationale = trades.map(t => `${t.pattern_type}: ${t.rationale || '-'}`).join('; ');
                
                // Get Prophet prediction from any trade in the group (check all trades in case some don't have it)
                let prophetPred = null;
                let prophetConf = null;
                let predictionDays = null;
                for (const trade of trades) {
                    // Check multiple possible field names for Prophet prediction
                    const predValue = trade.prophet_prediction_pct !== undefined ? trade.prophet_prediction_pct :
                                     trade.prophet_prediction !== undefined ? trade.prophet_prediction :
                                     trade.predicted_price_change_pct !== undefined ? trade.predicted_price_change_pct :
                                     null;
                    
                    if (predValue !== undefined && predValue !== null && !isNaN(predValue)) {
                        prophetPred = parseFloat(predValue);
                        const confValue = trade.prophet_confidence !== undefined ? trade.prophet_confidence :
                                         trade.prediction_confidence !== undefined ? trade.prediction_confidence :
                                         null;
                        prophetConf = (confValue !== undefined && confValue !== null && !isNaN(confValue)) ? parseFloat(confValue) : null;
                        
                        // Get prediction_days if available
                        if (trade.prediction_days !== undefined && trade.prediction_days !== null) {
                            predictionDays = parseInt(trade.prediction_days);
                        }
                        break;
                    }
                }
                
                // Debug logging - log the actual trade data if prediction is missing
                if (prophetPred === null && console) {
                    console.log(`No Prophet prediction for ${symbol}. Trade data:`, {
                        hasProphetPred: trades[0].prophet_prediction_pct !== undefined,
                        prophetPredValue: trades[0].prophet_prediction_pct,
                        alternativeFields: {
                            prophet_prediction: trades[0].prophet_prediction,
                            predicted_price_change_pct: trades[0].predicted_price_change_pct,
                            potential_gain_pct: trades[0].potential_gain_pct
                        },
                        allFields: Object.keys(trades[0])
                    });
                }
                
                symbols.push(symbol);
                
                const gainColor = maxGain >= 15 ? '#28a745' : '#17a2b8';
                const confidenceColor = maxConfidence >= 80 ? '#28a745' : maxConfidence >= 70 ? '#ffc107' : '#dc3545';
                const prophetColor = prophetPred !== null && prophetPred >= 0 ? '#28a745' : prophetPred !== null ? '#dc3545' : '#999';
                
                // Extract MAPE and RMSE from prophet predictions
                const prophetCvMape = trades[0].prophet_cv_mape !== undefined ? trades[0].prophet_cv_mape : null;
                const prophetCvRmse = trades[0].prophet_cv_rmse !== undefined ? trades[0].prophet_cv_rmse : null;
                
                // Debug logging for first trade
                if (symbols.length === 0) {
                    console.log('Sample swing trade data:', trades[0]);
                    console.log('prophet_cv_mape:', prophetCvMape, 'type:', typeof prophetCvMape);
                    console.log('prophet_cv_rmse:', prophetCvRmse, 'type:', typeof prophetCvRmse);
                }
                
                // Format MAPE and RMSE
                const mapeDisplay = (prophetCvMape !== null && prophetCvMape !== undefined && !isNaN(prophetCvMape) && prophetCvMape !== Infinity) 
                    ? prophetCvMape.toFixed(2) + '%' : 'N/A';
                const rmseDisplay = (prophetCvRmse !== null && prophetCvRmse !== undefined && !isNaN(prophetCvRmse) && prophetCvRmse !== Infinity) 
                    ? prophetCvRmse.toFixed(2) : 'N/A';
                
                const row = `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 14px;">${symbol}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                            <canvas id="sparkline-swing-${symbol}" width="120" height="40" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; font-size: 13px; max-width: 200px; word-wrap: break-word; white-space: normal; line-height: 1.4;">${patterns}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">â‚¹${entryPrice.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px; font-weight: bold;">â‚¹${targetPrice.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px; color: #dc3545;">â‚¹${stopLoss.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${gainColor}; font-size: 14px;">
                            +${maxGain.toFixed(2)}%
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${confidenceColor}; font-size: 13px;">
                            ${maxConfidence.toFixed(0)}%
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">${maxRR.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px;">
                            ${prophetPred !== null && !isNaN(prophetPred) ? `
                                <div style="color: ${prophetColor}; font-weight: bold;">${prophetPred >= 0 ? '+' : ''}${prophetPred.toFixed(2)}%</div>
                                <div style="font-size: 11px; color: #87CEEB;">Conf: ${prophetConf !== null && !isNaN(prophetConf) ? prophetConf.toFixed(0) : 'N/A'}%</div>
                                <div style="font-size: 11px; color: #87CEEB;">${predictionDays === 30 ? '30D' : predictionDays ? predictionDays + 'D' : 'N/A'}</div>
                            ` : '<span style="color: #999; font-size: 12px;">N/A</span>'}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px; color: ${prophetCvMape !== null && prophetCvMape !== undefined && !isNaN(prophetCvMape) && prophetCvMape !== Infinity && prophetCvMape < 50 ? '#28a745' : prophetCvMape !== null && prophetCvMape !== undefined && !isNaN(prophetCvMape) && prophetCvMape !== Infinity && prophetCvMape < 100 ? '#ffc107' : '#999'};">
                            ${mapeDisplay}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-size: 13px; color: ${prophetCvRmse !== null && prophetCvRmse !== undefined && !isNaN(prophetCvRmse) && prophetCvRmse !== Infinity ? '#666' : '#999'};">
                            ${rmseDisplay}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 13px;">${avgHoldingPeriod || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; font-size: 12px; max-width: 350px; word-wrap: break-word; white-space: normal; line-height: 1.4;" title="${rationale}">${rationale}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Load sparklines after a delay
            setTimeout(() => {
                symbols.forEach(symbol => {
                    if (symbol && symbol !== '-') {
                        // Pass the canvas ID to loadSparkline
                        loadSparkline(`sparkline-swing-${symbol}`);
                    }
                });
            }, 100);
            
            // Update pagination controls
            updateSwingTradePagination(totalItems);
        }
        
        function updateSwingTradePagination(totalItems) {
            const paginationDiv = document.getElementById('swingTradePagination');
            if (!paginationDiv) return;
            
            if (totalItems === 0) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalItems / swingTradeItemsPerPage);
            
            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">';
            
            // Previous button
            html += `<button onclick="swingTradeGoToPage(${swingTradeCurrentPage - 1})" ${swingTradeCurrentPage === 1 ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${swingTradeCurrentPage === 1 ? '#e9ecef' : 'white'}; color: ${swingTradeCurrentPage === 1 ? '#6c757d' : '#007bff'}; cursor: ${swingTradeCurrentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 13px;">Previous</button>`;
            
            // Page numbers
            let startPage = Math.max(1, swingTradeCurrentPage - 2);
            let endPage = Math.min(totalPages, swingTradeCurrentPage + 2);
            
            if (startPage > 1) {
                html += `<button onclick="swingTradeGoToPage(1)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="swingTradeGoToPage(${i})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: ${i === swingTradeCurrentPage ? '#007bff' : 'white'}; color: ${i === swingTradeCurrentPage ? 'white' : '#007bff'}; cursor: pointer; font-size: 13px; font-weight: ${i === swingTradeCurrentPage ? 'bold' : 'normal'};">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
                html += `<button onclick="swingTradeGoToPage(${totalPages})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="swingTradeGoToPage(${swingTradeCurrentPage + 1})" ${swingTradeCurrentPage === totalPages ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${swingTradeCurrentPage === totalPages ? '#e9ecef' : 'white'}; color: ${swingTradeCurrentPage === totalPages ? '#6c757d' : '#007bff'}; cursor: ${swingTradeCurrentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 13px;">Next</button>`;
            
            // Page info
            html += `<span style="margin-left: 15px; font-size: 13px; color: #666;">Showing ${((swingTradeCurrentPage - 1) * swingTradeItemsPerPage) + 1}-${Math.min(swingTradeCurrentPage * swingTradeItemsPerPage, totalItems)} of ${totalItems} results</span>`;
            
            html += '</div>';
            paginationDiv.innerHTML = html;
        }
        
        function swingTradeGoToPage(page) {
            // Group trades to get total unique symbols
            const groupedTrades = {};
            filteredSwingTrades.forEach(trade => {
                const symbol = trade.scrip_id || '-';
                if (!groupedTrades[symbol]) {
                    groupedTrades[symbol] = [];
                }
                groupedTrades[symbol].push(trade);
            });
            
            const totalItems = Object.keys(groupedTrades).length;
            const totalPages = Math.ceil(totalItems / swingTradeItemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                swingTradeCurrentPage = page;
                displaySwingTrades();
            }
        }
        
        // Sort swing trades function
        function sortSwingTrades(column) {
            // If clicking the same column, toggle direction; otherwise, set to ascending
            if (swingTradeSortColumn === column) {
                swingTradeSortDirection = swingTradeSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                swingTradeSortColumn = column;
                swingTradeSortDirection = 'asc';
            }
            
            // Reset to first page when sorting
            swingTradeCurrentPage = 1;
            
            // Update sort icons
            updateSwingTradeSortIcons();
            
            // Redisplay with new sort
            displaySwingTrades();
        }
        
        // Update sort icons based on current sort state
        function updateSwingTradeSortIcons() {
            // Clear all icons first
            ['symbol', 'pattern', 'gain', 'confidence', 'ghost'].forEach(col => {
                const icon = document.getElementById(`sort-${col}-icon`);
                if (icon) {
                    icon.innerHTML = '';
                    icon.style.color = '#999';
                }
            });
            
            // Set icon for current sort column
            const currentIcon = document.getElementById(`sort-${swingTradeSortColumn}-icon`);
            if (currentIcon) {
                if (swingTradeSortDirection === 'asc') {
                    currentIcon.innerHTML = ' â–²';
                    currentIcon.style.color = '#007bff';
                } else {
                    currentIcon.innerHTML = ' â–¼';
                    currentIcon.style.color = '#007bff';
                }
            }
        }
        
        // Generate Prophet predictions with selected days from dropdown
        function generateProphetPredictionsWithDays() {
            const daysSelect = document.getElementById('predictionDaysSelect');
            const predictionDays = daysSelect ? parseInt(daysSelect.value) : 30;
            generateProphetPredictions(predictionDays);
        }
        
        // Prophet Predictions Generation Function
        function generateProphetPredictions(predictionDays = 30, limit = null, force = false) {
            const statusDiv = document.getElementById('topGainersStatus');
            const tbody = document.getElementById('topGainersTableBody');
            
            if (statusDiv) {
                statusDiv.innerHTML = `<span style="color: #17a2b8;">â³ Generating Prophet predictions for ${predictionDays} days... This may take a few minutes.</span>`;
            }
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #666; font-size: 14px;">Generating predictions... Please wait...</td></tr>';
            }
            
            let url = `/api/prophet_predictions/generate?prediction_days=${predictionDays}`;
            if (limit) {
                url += `&limit=${limit}`;
            }
            if (force) {
                url += '&force=true';
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ Successfully generated ${data.predictions_generated} predictions for ${data.prediction_days} days (${data.run_date})</span>`;
                        }
                        // Auto-load top gainers after generation
                        setTimeout(() => {
                            loadTopGainers();
                        }, 1000);
                    } else {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #dc3545;">âœ— Error: ${data.error || 'Failed to generate predictions'}</span>`;
                        }
                        if (tbody) {
                            tbody.innerHTML = `<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">${data.error || 'Failed to generate predictions'}</td></tr>`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error generating Prophet predictions:', error);
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">âœ— Error: ${error.message || 'Failed to generate predictions'}</span>`;
                    }
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">Error generating predictions</td></tr>';
                    }
                });
        }
        
        // Check if Prophet predictions exist for today
        function checkProphetPredictionsExist() {
            fetch('/api/prophet_predictions/top_gainers?limit=1')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.top_gainers || data.top_gainers.length === 0) {
                        const statusDiv = document.getElementById('topGainersStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<span style="color: #ffc107;">âš ï¸ No predictions found. Click "Generate Predictions" to create 30-day price forecasts.</span>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking predictions:', error);
                });
        }
        
        // Pagination variables for Top 20 Potential Gainers
        let allTopGainers = [];
        let topGainersCurrentPage = 1;
        let topGainersItemsPerPage = 10;
        
        function loadTopGainers() {
            const tbody = document.getElementById('topGainersTableBody');
            const statusDiv = document.getElementById('topGainersStatus');
            const daysSelect = document.getElementById('predictionDaysSelect');
            const predictionDays = daysSelect ? parseInt(daysSelect.value) : 30;
            
            if (!tbody || !statusDiv) {
                console.error('Required elements not found for top gainers');
                return;
            }
            
            statusDiv.innerHTML = `<span style="color: #666;">â³ Loading top gainers for ${predictionDays} days...</span>`;
            tbody.innerHTML = '<tr><td colspan="11" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Loading...</td></tr>';
            
            fetch(`/api/prophet_predictions/top_gainers?limit=20&prediction_days=${predictionDays}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${data.error || 'Failed to load top gainers'}</span>`;
                        tbody.innerHTML = '<tr><td colspan="11" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Error loading top gainers</td></tr>';
                        return;
                    }
                    
                    let topGainers = data.top_gainers || [];
                    
                    // Filter out stocks with confidence < 50%
                    topGainers = topGainers.filter(gainer => {
                        const confidence = gainer.prediction_confidence || 0;
                        return confidence >= 50.0;
                    });
                    
                    if (topGainers.length === 0) {
                        statusDiv.innerHTML = '<span style="color: #ffc107;">âš ï¸ No predictions available. Click "Generate Predictions" button to create predictions.</span>';
                        tbody.innerHTML = `<tr><td colspan="11" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">
                            No top gainers found. <button onclick="generateProphetPredictionsWithDays()" style="padding: 6px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; font-size: 11px;">âš¡ Generate Predictions Now</button>
                        </td></tr>`;
                        allTopGainers = [];
                        topGainersCurrentPage = 1;
                        updateTopGainersPagination(0);
                        return;
                    }
                    
                    // Store all gainers and reset to page 1
                    allTopGainers = topGainers;
                    topGainersCurrentPage = 1;
                    
                    // Calculate pagination
                    const totalItems = allTopGainers.length;
                    const totalPages = Math.ceil(totalItems / topGainersItemsPerPage);
                    const startIndex = (topGainersCurrentPage - 1) * topGainersItemsPerPage;
                    const endIndex = Math.min(startIndex + topGainersItemsPerPage, totalItems);
                    const currentPageGainers = allTopGainers.slice(startIndex, endIndex);
                    
                    tbody.innerHTML = '';
                    const symbols = [];
                    
                    currentPageGainers.forEach((gainer, index) => {
                        const displayIndex = startIndex + index;
                        const symbol = gainer.scrip_id || '-';
                        const currentPrice = gainer.current_price || 0;
                        const predictedPrice = gainer.predicted_price_30d || gainer.predicted_price_60d || gainer.predicted_price_90d || gainer.predicted_price_180d || 0;
                        const predictedChangePct = gainer.predicted_price_change_pct || 0;
                        const confidence = gainer.prediction_confidence || 0;
                        const predictionDays = gainer.prediction_days || 30;
                        const daysInLeaderboard = gainer.days_in_leaderboard || 0;
                        const cvMape = gainer.cv_mape;
                        const cvRmse = gainer.cv_rmse;
                        
                        // Debug logging
                        if (index === 0) {
                            console.log('Sample gainer data:', gainer);
                            console.log('cv_mape:', cvMape, 'type:', typeof cvMape);
                            console.log('cv_rmse:', cvRmse, 'type:', typeof cvRmse);
                        }
                        
                        symbols.push(symbol);
                        
                        const gainColor = predictedChangePct >= 15 ? '#28a745' : predictedChangePct >= 10 ? '#ffc107' : '#17a2b8';
                        const confidenceColor = confidence >= 70 ? '#28a745' : confidence >= 50 ? '#ffc107' : '#dc3545';
                        
                        // Format MAPE and RMSE
                        const mapeDisplay = (cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity) 
                            ? cvMape.toFixed(2) + '%' : 'N/A';
                        const rmseDisplay = (cvRmse !== null && cvRmse !== undefined && !isNaN(cvRmse) && cvRmse !== Infinity) 
                            ? cvRmse.toFixed(2) : 'N/A';
                        
                        const row = `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666; font-size: 12px;">${displayIndex + 1}</td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                                <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">
                                    <canvas id="sparkline-gainer-${symbol}" width="100" height="35" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">â‚¹${currentPrice.toFixed(2)}</td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; font-weight: bold;">â‚¹${predictedPrice.toFixed(2)}</td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${gainColor}; font-size: 12px;">
                                    +${predictedChangePct.toFixed(2)}%
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${confidenceColor}; font-size: 12px;">
                                    ${confidence.toFixed(0)}%
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                    <span onclick="showPredictionHistory('${symbol}', ${predictionDays})" style="cursor: pointer; color: #17a2b8; font-weight: bold; text-decoration: underline;" title="Click to view prediction history chart">${daysInLeaderboard}</span>
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                    ${predictionDays} days
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; color: ${cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity && cvMape < 50 ? '#28a745' : cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity && cvMape < 100 ? '#ffc107' : '#999'};">
                                    ${mapeDisplay}
                                </td>
                                <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; color: ${cvRmse !== null && cvRmse !== undefined && !isNaN(cvRmse) && cvRmse !== Infinity ? '#666' : '#999'};">
                                    ${rmseDisplay}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // Load sparklines after a delay
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            if (symbol && symbol !== '-') {
                                loadSparkline(`sparkline-gainer-${symbol}`);
                            }
                        });
                    }, 100);
                    
                    // Update pagination
                    updateTopGainersPagination(totalItems);
                    
                    statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ Loaded ${totalItems} top gainers (showing ${startIndex + 1}-${endIndex} of ${totalItems})</span>`;
                })
                .catch(error => {
                    console.error('Error loading top gainers:', error);
                    statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Failed to load top gainers'}</span>`;
                    tbody.innerHTML = '<tr><td colspan="11" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">Error loading top gainers</td></tr>';
                });
        }
        
        // Update Top Gainers pagination (similar to Swing Predictions)
        function updateTopGainersPagination(totalItems) {
            const paginationDiv = document.getElementById('topGainersPagination');
            if (!paginationDiv) return;
            
            if (totalItems === 0) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalItems / topGainersItemsPerPage);
            
            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">';
            
            // Previous button
            html += `<button onclick="topGainersGoToPage(${topGainersCurrentPage - 1})" ${topGainersCurrentPage === 1 ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${topGainersCurrentPage === 1 ? '#e9ecef' : 'white'}; color: ${topGainersCurrentPage === 1 ? '#6c757d' : '#007bff'}; cursor: ${topGainersCurrentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 13px;">Previous</button>`;
            
            // Page numbers
            let startPage = Math.max(1, topGainersCurrentPage - 2);
            let endPage = Math.min(totalPages, topGainersCurrentPage + 2);
            
            if (startPage > 1) {
                html += `<button onclick="topGainersGoToPage(1)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="topGainersGoToPage(${i})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: ${i === topGainersCurrentPage ? '#007bff' : 'white'}; color: ${i === topGainersCurrentPage ? 'white' : '#007bff'}; cursor: pointer; font-size: 13px; font-weight: ${i === topGainersCurrentPage ? 'bold' : 'normal'};">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 6px; color: #666; font-size: 13px;">...</span>`;
                }
                html += `<button onclick="topGainersGoToPage(${totalPages})" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background-color: white; color: #007bff; cursor: pointer; font-size: 13px;">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="topGainersGoToPage(${topGainersCurrentPage + 1})" ${topGainersCurrentPage === totalPages ? 'disabled' : ''} style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: ${topGainersCurrentPage === totalPages ? '#e9ecef' : 'white'}; color: ${topGainersCurrentPage === totalPages ? '#6c757d' : '#007bff'}; cursor: ${topGainersCurrentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 13px;">Next</button>`;
            
            // Page info
            html += `<span style="margin-left: 15px; font-size: 13px; color: #666;">Showing ${((topGainersCurrentPage - 1) * topGainersItemsPerPage) + 1}-${Math.min(topGainersCurrentPage * topGainersItemsPerPage, totalItems)} of ${totalItems} results</span>`;
            
            html += '</div>';
            paginationDiv.innerHTML = html;
        }
        
        function topGainersGoToPage(page) {
            const totalItems = allTopGainers.length;
            const totalPages = Math.ceil(totalItems / topGainersItemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                topGainersCurrentPage = page;
                
                // Calculate pagination
                const startIndex = (topGainersCurrentPage - 1) * topGainersItemsPerPage;
                const endIndex = Math.min(startIndex + topGainersItemsPerPage, totalItems);
                const currentPageGainers = allTopGainers.slice(startIndex, endIndex);
                
                const tbody = document.getElementById('topGainersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                const symbols = [];
                
                currentPageGainers.forEach((gainer, index) => {
                    const displayIndex = startIndex + index;
                    const symbol = gainer.scrip_id || '-';
                    const currentPrice = gainer.current_price || 0;
                    const predictedPrice = gainer.predicted_price_30d || gainer.predicted_price_60d || gainer.predicted_price_90d || gainer.predicted_price_180d || 0;
                    const predictedChangePct = gainer.predicted_price_change_pct || 0;
                    const confidence = gainer.prediction_confidence || 0;
                    const predictionDays = gainer.prediction_days || 30;
                    const daysInLeaderboard = gainer.days_in_leaderboard || 0;
                    const cvMape = gainer.cv_mape;
                    const cvRmse = gainer.cv_rmse;
                    
                    symbols.push(symbol);
                    
                    const gainColor = predictedChangePct >= 15 ? '#28a745' : predictedChangePct >= 10 ? '#ffc107' : '#17a2b8';
                    const confidenceColor = confidence >= 70 ? '#28a745' : confidence >= 50 ? '#ffc107' : '#dc3545';
                    
                    // Format MAPE and RMSE
                    const mapeDisplay = (cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity) 
                        ? cvMape.toFixed(2) + '%' : 'N/A';
                    const rmseDisplay = (cvRmse !== null && cvRmse !== undefined && !isNaN(cvRmse) && cvRmse !== Infinity) 
                        ? cvRmse.toFixed(2) : 'N/A';
                    
                    const row = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #666; font-size: 12px;">${displayIndex + 1}</td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">
                                <canvas id="sparkline-gainer-${symbol}" width="100" height="35" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">â‚¹${currentPrice.toFixed(2)}</td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; font-weight: bold;">â‚¹${predictedPrice.toFixed(2)}</td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${gainColor}; font-size: 12px;">
                                +${predictedChangePct.toFixed(2)}%
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${confidenceColor}; font-size: 12px;">
                                ${confidence.toFixed(0)}%
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                <span onclick="showPredictionHistory('${symbol}', ${predictionDays})" style="cursor: pointer; color: #17a2b8; font-weight: bold; text-decoration: underline;" title="Click to view prediction history chart">${daysInLeaderboard}</span>
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                ${predictionDays} days
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; color: ${cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity && cvMape < 50 ? '#28a745' : cvMape !== null && cvMape !== undefined && !isNaN(cvMape) && cvMape !== Infinity && cvMape < 100 ? '#ffc107' : '#999'};">
                                ${mapeDisplay}
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; color: ${cvRmse !== null && cvRmse !== undefined && !isNaN(cvRmse) && cvRmse !== Infinity ? '#666' : '#999'};">
                                ${rmseDisplay}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                // Load sparklines after a delay
                setTimeout(() => {
                    symbols.forEach(symbol => {
                        if (symbol && symbol !== '-') {
                            loadSparkline(`sparkline-gainer-${symbol}`);
                        }
                    });
                }, 100);
                
                // Update pagination
                updateTopGainersPagination(totalItems);
            }
        }
        
        // Prediction History Chart Modal
        let predictionHistoryChart = null;
        
        function showPredictionHistory(symbol, predictionDays) {
            // Show modal
            const modal = document.getElementById('predictionHistoryModal');
            if (!modal) {
                // Create modal if it doesn't exist
                createPredictionHistoryModal();
            }
            document.getElementById('predictionHistoryModal').style.display = 'block';
            document.getElementById('predictionHistorySymbol').textContent = `${symbol} - Prediction History (${predictionDays} days)`;
            
            // Fetch prediction history
            fetch(`/api/prophet_predictions/history/${symbol}?prediction_days=${predictionDays}&limit=100`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success) {
                        document.getElementById('predictionHistoryStatus').innerHTML = 
                            `<span style="color: #dc3545;">Error: ${data.error || 'Failed to load prediction history'}</span>`;
                        return;
                    }
                    
                    if (!data.history || data.history.length === 0) {
                        document.getElementById('predictionHistoryStatus').innerHTML = 
                            `<span style="color: #666;">No prediction history available for ${symbol}</span>`;
                        return;
                    }
                    
                    // Draw chart
                    drawPredictionHistoryChart(data.history, symbol);
                })
                .catch(error => {
                    console.error('Error loading prediction history:', error);
                    document.getElementById('predictionHistoryStatus').innerHTML = 
                        `<span style="color: #dc3545;">Error loading prediction history</span>`;
                });
        }
        
        function createPredictionHistoryModal() {
            const modal = document.createElement('div');
            modal.id = 'predictionHistoryModal';
            modal.style.cssText = 'display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);';
            modal.innerHTML = `
                <div style="background-color: #fefefe; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); padding: 20px; border: 1px solid #888; width: 80vw; max-width: 900px; height: 70vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                        <h2 id="predictionHistorySymbol" style="margin: 0; font-size: 1.5em;">Prediction History</h2>
                        <button onclick="closePredictionHistoryModal()" style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 14px;">Close</button>
                    </div>
                    <div id="predictionHistoryStatus" style="margin-bottom: 10px; flex-shrink: 0; font-size: 12px; color: #666;"></div>
                    <div style="flex: 1; overflow: hidden; position: relative;">
                        <canvas id="predictionHistoryChartCanvas" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closePredictionHistoryModal() {
            document.getElementById('predictionHistoryModal').style.display = 'none';
            if (predictionHistoryChart) {
                predictionHistoryChart.destroy();
                predictionHistoryChart = null;
            }
        }
        
        function drawPredictionHistoryChart(history, symbol) {
            const canvas = document.getElementById('predictionHistoryChartCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (predictionHistoryChart) {
                predictionHistoryChart.destroy();
            }
            
            // Prepare data
            const labels = history.map(h => h.run_date || '');
            const predictedGainPct = history.map(h => h.predicted_price_change_pct || 0);
            const confidence = history.map(h => h.prediction_confidence || 0);
            
            // Create chart
            predictionHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Predicted Gain %',
                            data: predictedGainPct,
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Confidence %',
                            data: confidence,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${symbol} - Prediction History Over Time`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Predicted Gain %'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Confidence %'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // Stock Symbol Search Functions
        let symbolSuggestionsList = [];
        let symbolSearchTimeout = null;
        
        function handleSymbolSearch(value) {
            const suggestionsDiv = document.getElementById('symbolSuggestions');
            if (!value || value.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Debounce API calls
            if (symbolSearchTimeout) {
                clearTimeout(symbolSearchTimeout);
            }
            
            symbolSearchTimeout = setTimeout(() => {
                fetch(`/api/prophet_predictions/symbol_search?query=${encodeURIComponent(value)}&limit=10`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.suggestions && data.suggestions.length > 0) {
                            symbolSuggestionsList = data.suggestions;
                            displaySymbolSuggestions(data.suggestions);
                        } else {
                            suggestionsDiv.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching symbol suggestions:', error);
                        suggestionsDiv.style.display = 'none';
                    });
            }, 300);
        }
        
        function displaySymbolSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('symbolSuggestions');
            if (!suggestions || suggestions.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            suggestions.forEach(symbol => {
                html += `<div onclick="selectSymbol('${symbol}')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">${symbol}</div>`;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }
        
        function handleSymbolSearchKeydown(event) {
            const suggestionsDiv = document.getElementById('symbolSuggestions');
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchInput = document.getElementById('stockSymbolSearch');
                if (searchInput.value) {
                    searchStockSymbol();
                }
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function selectSymbol(symbol) {
            document.getElementById('stockSymbolSearch').value = symbol;
            document.getElementById('symbolSuggestions').style.display = 'none';
            searchStockSymbol();
        }
        
        function searchStockSymbol() {
            const searchInput = document.getElementById('stockSymbolSearch');
            const symbol = searchInput.value.trim().toUpperCase();
            const container = document.getElementById('stockSearchContainer');
            const tbody = document.getElementById('stockSearchTableBody');
            const statusDiv = document.getElementById('stockSearchStatus');
            const daysSelect = document.getElementById('predictionDaysSelect');
            const predictionDays = daysSelect ? parseInt(daysSelect.value) : 60;
            
            if (!symbol) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">Please enter a stock symbol</span>';
                return;
            }
            
            container.style.display = 'block';
            statusDiv.innerHTML = `<span style="color: #666;">â³ Loading prediction for ${symbol}...</span>`;
            tbody.innerHTML = '<tr><td colspan="7" style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Loading...</td></tr>';
            
            fetch(`/api/prophet_predictions/${symbol}?prediction_days=${predictionDays}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.success || !data.prediction) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${data.error || 'No prediction found for ' + symbol}</span>`;
                        tbody.innerHTML = `<tr><td colspan="7" style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">${data.error || 'No prediction found'}</td></tr>`;
                        return;
                    }
                    
                    const prediction = data.prediction;
                    const currentPrice = prediction.current_price || 0;
                    const predictedPrice = prediction.predicted_price_30d || prediction.predicted_price_60d || prediction.predicted_price_90d || prediction.predicted_price_180d || 0;
                    const predictedChangePct = prediction.predicted_price_change_pct || 0;
                    const confidence = prediction.prediction_confidence || 0;
                    const predictionDaysValue = prediction.prediction_days || predictionDays || 60;
                    
                    // Only show if confidence >= 50%
                    if (confidence < 50.0) {
                        statusDiv.innerHTML = '<span style="color: #ffc107;">âš ï¸ Prediction available but confidence is below 50%</span>';
                    }
                    
                    const gainColor = predictedChangePct >= 15 ? '#28a745' : predictedChangePct >= 10 ? '#ffc107' : '#17a2b8';
                    const confidenceColor = confidence >= 70 ? '#28a745' : confidence >= 50 ? '#ffc107' : '#dc3545';
                    
                    tbody.innerHTML = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 5px 8px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${symbol}</td>
                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">
                                <canvas id="sparkline-search-${symbol}" width="100" height="35" onclick="showCandlestick('${symbol}')" style="cursor: pointer;"></canvas>
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px;">â‚¹${currentPrice.toFixed(2)}</td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-size: 12px; font-weight: bold;">â‚¹${predictedPrice.toFixed(2)}</td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: ${gainColor}; font-size: 12px;">
                                ${predictedChangePct >= 0 ? '+' : ''}${predictedChangePct.toFixed(2)}%
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${confidenceColor}; font-size: 12px;">
                                ${confidence.toFixed(0)}%
                            </td>
                            <td style="padding: 5px 8px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                ${predictionDaysValue} days
                            </td>
                        </tr>
                    `;
                    
                    // Load sparkline
                    setTimeout(() => {
                        if (symbol && symbol !== '-') {
                            loadSparkline(`sparkline-search-${symbol}`);
                        }
                    }, 100);
                    
                    statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ Loaded prediction for ${symbol}</span>`;
                })
                .catch(error => {
                    console.error('Error loading stock prediction:', error);
                    statusDiv.innerHTML = `<span style="color: #dc3545;">Error: ${error.message || 'Failed to load prediction'}</span>`;
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 15px; text-align: center; color: #dc3545; font-size: 14px;">Error loading prediction</td></tr>';
                });
        }
        
        function clearStockSearch() {
            document.getElementById('stockSymbolSearch').value = '';
            document.getElementById('symbolSuggestions').style.display = 'none';
            document.getElementById('stockSearchContainer').style.display = 'none';
            document.getElementById('stockSearchStatus').innerHTML = '';
            symbolSuggestionsList = [];
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const suggestionsDiv = document.getElementById('symbolSuggestions');
            const searchInput = document.getElementById('stockSymbolSearch');
            if (suggestionsDiv && !suggestionsDiv.contains(event.target) && searchInput && !searchInput.contains(event.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        function showCandlestick(symbol) {
            currentStockSymbol = symbol;
            document.getElementById('modalStockSymbol').textContent = `${symbol} - Candlestick Chart`;
            document.getElementById('candlestickModal').style.display = 'block';
            updateCandlestickChart();
        }

        function closeCandlestickModal() {
            document.getElementById('candlestickModal').style.display = 'none';
            if (candlestickChart) {
                candlestickChart.destroy();
                candlestickChart = null;
            }
        }
        
        // Handle window resize to adjust chart size
        window.addEventListener('resize', function() {
            if (document.getElementById('candlestickModal').style.display !== 'none' && candlestickChart) {
                const canvas = document.getElementById('candlestickChartCanvas');
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                candlestickChart.resize();
            }
        });

        function updateCandlestickChart() {
            if (!currentStockSymbol) return;
            
            const days = document.getElementById('chartDays').value;
            
            fetch(`/api/candlestick/${currentStockSymbol}?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading candlestick data:', data.error);
                        return;
                    }
                    
                    console.log('Candlestick data received:', data);
                    console.log('First data point structure:', data.data[0]);
                    console.log('Sample data point:', JSON.stringify(data.data[0], null, 2));
                    
                    const ctx = document.getElementById('candlestickChartCanvas').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (candlestickChart) {
                        candlestickChart.destroy();
                    }
                    
                    // Prepare data for Chart.js Financial candlestick
                    // Data format: {x: timestamp, o: open, h: high, l: low, c: close}
                    // Round to 2 decimal places for display
                    const candlestickData = data.data.map(d => {
                        // Convert date string to timestamp
                        const timestamp = new Date(d.date).getTime();
                        return {
                            x: timestamp, 
                            o: parseFloat(d.open.toFixed(2)), 
                            h: parseFloat(d.high.toFixed(2)), 
                            l: parseFloat(d.low.toFixed(2)), 
                            c: parseFloat(d.close.toFixed(2))
                        };
                    });
                    
                    // Prepare indicator data for line charts (rounded to 2 decimal places)
                    const sma20Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_20 !== null && !isNaN(d.sma_20) ? parseFloat(d.sma_20.toFixed(2)) : null
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma50Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_50 !== null && !isNaN(d.sma_50) ? parseFloat(d.sma_50.toFixed(2)) : null
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const sma200Data = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.sma_200 !== null && !isNaN(d.sma_200) ? parseFloat(d.sma_200.toFixed(2)) : null
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    const supertrendData = data.data.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: d.supertrend !== null && !isNaN(d.supertrend) ? parseFloat(d.supertrend.toFixed(2)) : null,
                        direction: d.supertrend_direction
                    })).filter(d => d.y !== null && !isNaN(d.y));
                    
                    console.log('Candlestick data formatted:', candlestickData.slice(0, 5));
                    console.log('SMA 20 data:', sma20Data.slice(0, 5));
                    console.log('SMA 50 data:', sma50Data.slice(0, 5));
                    console.log('SMA 200 data:', sma200Data.slice(0, 5));
                    console.log('Supertrend data:', supertrendData.slice(0, 5));
                    
                    // Get the container dimensions
                    const container = ctx.canvas.parentElement;
                    ctx.canvas.width = container.clientWidth;
                    ctx.canvas.height = container.clientHeight;
                    
                    // Create candlestick chart using Chart.js Financial
                    try {
                    // First, create the candlestick chart
                    candlestickChart = new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: currentStockSymbol,
                                data: candlestickData
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(2);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: `${currentStockSymbol} - Last ${days} Days`
                                },
                                tooltip: {
                                    enabled: true,
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        title: function(context) {
                                            // Show date in tooltip title
                                            if (context.length > 0 && context[0].raw) {
                                                const raw = context[0].raw;
                                                if (raw.x) {
                                                    const date = new Date(raw.x);
                                                    return date.toLocaleDateString('en-IN', { 
                                                        year: 'numeric', 
                                                        month: 'short', 
                                                        day: 'numeric' 
                                                    });
                                                }
                                            }
                                            return '';
                                        },
                                        label: function(context) {
                                            const dataset = context.dataset;
                                            const raw = context.raw;
                                            
                                            // For candlestick data, show OHLC values
                                            if (raw && typeof raw === 'object' && 'o' in raw) {
                                                const safeValue = (val) => {
                                                    if (val == null || isNaN(val)) return 'N/A';
                                                    try {
                                                        return parseFloat(val).toFixed(2);
                                                    } catch (e) {
                                                        return 'N/A';
                                                    }
                                                };
                                                return [
                                                    `Open: â‚¹${safeValue(raw.o)}`,
                                                    `High: â‚¹${safeValue(raw.h)}`,
                                                    `Low: â‚¹${safeValue(raw.l)}`,
                                                    `Close: â‚¹${safeValue(raw.c)}`
                                                ];
                                            }
                                            
                                            // For line chart datasets (SMA, Supertrend)
                                            if (raw && typeof raw === 'object' && 'y' in raw) {
                                                const y = raw.y;
                                                if (y != null && !isNaN(y)) {
                                                    try {
                                                        const yValue = parseFloat(y).toFixed(2);
                                                        return `${dataset.label || 'Value'}: â‚¹${yValue}`;
                                                    } catch (e) {
                                                        return `${dataset.label || 'Value'}: N/A`;
                                                    }
                                                }
                                            }
                                            
                                            // Fallback - try parsed values
                                            const label = dataset.label || '';
                                            if (context.parsed && context.parsed.y != null && !isNaN(context.parsed.y)) {
                                                try {
                                                    const yValue = parseFloat(context.parsed.y).toFixed(2);
                                                    return `${label}: â‚¹${yValue}`;
                                                } catch (e) {
                                                    return `${label}: N/A`;
                                                }
                                            }
                                            
                                            // Return empty string if no valid data
                                            return label || '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Add indicator datasets after chart creation
                    if (sma20Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 20',
                            data: sma20Data,
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma50Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 50',
                            data: sma50Data,
                            type: 'line',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (sma200Data.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'SMA 200',
                            data: sma200Data,
                            type: 'line',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false
                        });
                    }
                    
                    if (supertrendData.length > 0) {
                        candlestickChart.data.datasets.push({
                            label: 'Supertrend',
                            data: supertrendData,
                            type: 'line',
                            borderColor: 'rgba(138, 43, 226, 1)',  // Default fallback
                            backgroundColor: 'rgba(138, 43, 226, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.1,
                            fill: false,
                            segment: {
                                borderColor: (ctx) => {
                                    const segment = ctx.p0;
                                    // Get direction from the data point
                                    const dataIndex = ctx.p0DataIndex;
                                    const point = supertrendData[dataIndex];
                                    if (point && point.direction === 1) {
                                        return 'rgba(40, 167, 69, 1)';  // Green for uptrend
                                    } else {
                                        return 'rgba(220, 53, 69, 1)';  // Red for downtrend
                                    }
                                }
                            }
                        });
                    }
                    
                    // Update the chart to render the new datasets
                    candlestickChart.update();
                    console.log('Chart created successfully');
                    console.log('Chart datasets after update:', candlestickChart.data.datasets.length);
                    candlestickChart.data.datasets.forEach((ds, index) => {
                        console.log(`Dataset ${index}:`, ds.label, ds.type, 'data points:', ds.data.length);
                    });
                    } catch (error) {
                        console.error('Error creating chart:', error);
                        console.error(error.stack);
                    }
                })
                .catch(error => console.error('Error loading candlestick data:', error));
        }

        // Load sparklines after page loads - but only if holdings tab is loaded
        // Sparklines for holdings will be loaded when holdings tab is first clicked
        // This prevents holdings API calls on initial page load
        // Note: loadSparklines() is called when holdings tab is loaded via loadHoldingsPage()
    </script>
</body>
</html>
